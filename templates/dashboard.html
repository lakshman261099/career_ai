{% extends "base.html" %}
{% block title %}CareerAI — Dashboard{% endblock %}
{% block content %}
<section class="max-w-6xl mx-auto px-4 space-y-6">

  {% if error %}
  <div class="glass rounded-xl p-4 border border-rose-400/40 text-rose-300">
    {{ error }}
  </div>
  {% endif %}
  {% if info %}
  <div class="glass rounded-xl p-4 border border-white/20">
    {{ info }}
  </div>
  {% endif %}

  <!-- Tabs -->
  <div class="glass rounded-xl p-2 flex gap-2 overflow-x-auto">
    {% set tab = active_tab or 'jobpack' %}
    {% macro tabbtn(id, label) -%}
      <button data-tab="{{ id }}" class="tab-btn px-3 py-2 rounded-lg text-sm {{ 'bg-brand' if tab==id else 'hover:bg-white/10' }}">{{ label }}</button>
    {%- endmacro %}
    {{ tabbtn('jobpack','Job Pack') }}
    {{ tabbtn('internships','Internship Finder') }}
    {{ tabbtn('portfolio','Portfolio Builder') }}
    {{ tabbtn('referral','Referral Network') }}
    {{ tabbtn('agent','Career Agent') }}
  </div>

  <!-- Panels -->
  <div id="panel-jobpack" class="panel {{ '' if tab=='jobpack' else 'hidden' }}">
    <div class="grid md:grid-cols-3 gap-6">
      <div class="md:col-span-1 space-y-4">
        <div class="glass rounded-xl p-5">
          <h2 class="font-bold text-lg">Job Match & Application Pack</h2>
          <form action="/jobpack/generate" method="post" class="space-y-3">
            <div>
              <label class="block text-sm text-slate-300">Job Link (optional)</label>
              <input type="url" name="job_url" class="w-full rounded-lg bg-slate-900 border border-white/10 p-3" placeholder="https://jobs.greenhouse.io/...">
            </div>
            <div>
              <label class="block text-sm text-slate-300">OR paste Job Description</label>
              <textarea name="job_text" rows="5" class="w-full rounded-lg bg-slate-900 border border-white/10 p-3" placeholder="Paste full JD here..."></textarea>
            </div>
            <div>
              <label class="block text-sm text-slate-300">Your Resume (plain text)</label>
              <textarea name="resume_text" rows="8" class="w-full rounded-lg bg-slate-900 border border-white/10 p-3" placeholder="Paste your resume text here..."></textarea>
            </div>
            <button class="bg-emerald-500 hover:bg-emerald-400 text-black font-semibold px-4 py-2 rounded-lg">Generate Pack</button>
            <p class="text-xs text-slate-400">Mock mode: {{ 'ON' if (env('MOCK_MODE') if env else 'true') == 'true' else 'OFF' }}</p>
          </form>
        </div>
      </div>
      <div class="md:col-span-2 space-y-4">
        {% if jobpack_result %}
        <div class="glass rounded-xl p-5 space-y-5">
          <div>
            <h3 class="font-semibold text-lg">JD Summary</h3>
            <pre class="bg-slate-900 border border-white/10 rounded p-3 whitespace-pre-wrap">{{ jobpack_result.jd_summary }}</pre>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="glass rounded-lg p-4">
              <h3 class="font-semibold">ATS Score</h3>
              <p class="text-3xl font-extrabold mt-1">{{ jobpack_result.ats_score.score }}%</p>
              <ul class="list-disc ml-5 mt-2 text-slate-300">
                {% for e in jobpack_result.ats_score.explain %}<li>{{ e }}</li>{% endfor %}
              </ul>
            </div>
            <div class="glass rounded-lg p-4">
              <h3 class="font-semibold">Missing Skills</h3>
              <ul class="list-disc ml-5 mt-2 text-slate-300">
                {% for s in jobpack_result.missing_skills %}<li>{{ s }}</li>{% endfor %}
              </ul>
            </div>
          </div>
          <div>
            <h3 class="font-semibold">Tailored Resume Bullets</h3>
            <ul class="list-disc ml-5 mt-2 text-slate-300">
              {% for b in jobpack_result.tailored_bullets %}<li>{{ b }}</li>{% endfor %}
            </ul>
          </div>
          <div>
            <h3 class="font-semibold">Cover Letter</h3>
            <pre class="bg-slate-900 border border-white/10 rounded p-3 whitespace-pre-wrap">{{ jobpack_result.cover_letter }}</pre>
          </div>
        </div>
        {% else %}
        <div class="glass rounded-xl p-6">
          <h3 class="font-semibold">No results yet</h3>
          <p class="text-slate-300 mt-1">Paste a job & your resume, then click <em>Generate Pack</em>.</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

 <div id="panel-internships" class="panel {{ '' if tab=='internships' else 'hidden' }}">
  <div class="glass rounded-xl p-6">
    <h2 class="font-bold text-lg">AI Internship Finder with Skill Gap Bridge</h2>
    <form action="/internships/search" method="post" class="space-y-3 mt-4">
      <input name="role" placeholder="Target Career Path" class="w-full p-2 rounded bg-slate-900 border border-white/10">
      <input name="location" placeholder="Preferred Location" class="w-full p-2 rounded bg-slate-900 border border-white/10">
      <input name="skills" placeholder="Your Current Skills" class="w-full p-2 rounded bg-slate-900 border border-white/10">
      <button type="submit" class="bg-green-500 px-4 py-2 rounded">Find Internships</button>
    </form>

    {% if internships_result %}
      <div class="mt-6 space-y-4">
        {% for job in internships_result %}
          <div class="bg-slate-900 p-4 rounded border border-white/10">
            <p class="font-semibold">{{ job.title }} – {{ job.company }}</p>
            <p class="text-sm text-slate-400">{{ job.location }} | Match: {{ job.match_score }}%</p>
            <p class="mt-2"><a href="{{ job.link }}" class="text-blue-400 underline" target="_blank">View Listing</a></p>
            {% if job.missing_skills %}
              <p class="mt-2 text-red-300">Missing Skills:</p>
              <ul class="list-disc ml-5 text-slate-300">
                {% for s in job.missing_skills %}
                  <li>{{ s }}</li>
                {% endfor %}
              </ul>
              <p class="mt-2 text-slate-300">Learning Links:</p>
              <ul class="list-disc ml-5 text-blue-400">
                {% for l in job.learning_links %}
                  <li><a href="{{ l.link }}" target="_blank">{{ l.skill }}</a></li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>


 <div id="panel-portfolio" class="panel {{ '' if tab=='portfolio' else 'hidden' }}">
  <div class="glass rounded-xl p-6">
    <h2 class="font-bold text-lg">Portfolio Builder – Real Job Simulation</h2>
    <form action="/portfolio/generate" method="post" class="space-y-3 mt-4">
      <input name="role" placeholder="Target Role" class="w-full p-2 rounded bg-slate-900 border border-white/10">
      <button type="submit" class="bg-purple-500 px-4 py-2 rounded">Generate Project Brief</button>
    </form>

    {% if portfolio_result %}
      <div class="mt-6 bg-slate-900 p-4 rounded border border-white/10 whitespace-pre-wrap">
        {{ portfolio_result }}
      </div>
    {% endif %}
  </div>
</div>


<div id="panel-referral" class="panel {{ '' if tab=='referral' else 'hidden' }}">
  <div class="glass rounded-xl p-6">
    <h2 class="font-bold text-lg">AI Personal Job Referral Network Builder</h2>
    <form action="/referral/generate" method="post" class="space-y-3 mt-4">
      <input name="university" placeholder="Your University" class="w-full p-2 rounded bg-slate-900 border border-white/10">
      <input name="target_role" placeholder="Target Job Role" class="w-full p-2 rounded bg-slate-900 border border-white/10">
      <input name="skills" placeholder="Your Key Skills" class="w-full p-2 rounded bg-slate-900 border border-white/10">
      <input name="goal" placeholder="Your Career Goal" class="w-full p-2 rounded bg-slate-900 border border-white/10">
      <button type="submit" class="bg-blue-500 px-4 py-2 rounded">Generate Network</button>
    </form>

    {% if referral_result %}
      <div class="mt-6 space-y-4">
        {% for r in referral_result %}
          <div class="bg-slate-900 p-4 rounded border border-white/10">
            <p><strong>{{ r.person.name }}</strong> – {{ r.person.role }} @ {{ r.person.company }} ({{ r.person.grad_year }})</p>
            <p class="mt-2 text-slate-300 whitespace-pre-wrap">{{ r.message }}</p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-slate-300 mt-4">Enter your details to find alumni and generate personalised outreach messages.</p>
    {% endif %}
  </div>
</div>


 <div id="panel-agent" class="panel {{ '' if tab=='agent' else 'hidden' }}">
  <div class="glass rounded-xl p-6">
    <h2 class="font-bold text-lg">AI Career Agent – Job Search Automation</h2>
    <form action="/agent/run" method="post" class="space-y-3 mt-4">
      <input name="role" placeholder="Target Role" class="w-full p-2 rounded bg-slate-900 border border-white/10">
      <input name="location" placeholder="Preferred Location" class="w-full p-2 rounded bg-slate-900 border border-white/10">
      <input name="skills" placeholder="Your Skills" class="w-full p-2 rounded bg-slate-900 border border-white/10">
      <button type="submit" class="bg-orange-500 px-4 py-2 rounded">Run Career Agent</button>
    </form>

    {% if agent_result %}
      <div class="mt-6 space-y-6">
        {% for r in agent_result %}
          <div class="bg-slate-900 p-4 rounded border border-white/10">
            <p class="font-semibold">{{ r.job.title }} – {{ r.job.company }}</p>
            <p class="text-sm text-slate-400">{{ r.job.location }}</p>
            <p class="mt-1"><a href="{{ r.job.link }}" target="_blank" class="text-blue-400 underline">View Job</a></p>
            <h4 class="mt-3 font-bold">Tailored Resume</h4>
            <pre class="bg-slate-800 p-2 rounded border border-white/10 whitespace-pre-wrap">{{ r.pack.resume }}</pre>
            <h4 class="mt-3 font-bold">Cover Letter</h4>
            <pre class="bg-slate-800 p-2 rounded border border-white/10 whitespace-pre-wrap">{{ r.pack.cover_letter }}</pre>
            <h4 class="mt-3 font-bold">Follow-Up Email</h4>
            <pre class="bg-slate-800 p-2 rounded border border-white/10 whitespace-pre-wrap">{{ r.pack.follow_up }}</pre>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>


</section>
{% endblock %}
