{% extends "base.html" %}
{% block title %}CareerAI Deep Evaluation Report{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 mt-10 space-y-6 text-white">

  <!-- HEADER -->
  <div class="glass-card p-6 rounded-2xl flex justify-between items-center border border-white/10 shadow-lg">
    <div>
      <h1 class="text-2xl font-bold tracking-tight">
        {{ "CareerAI Deep Evaluation" if is_pro else "Job Pack Report" }}
      </h1>
      <p class="text-sm text-white/70">
        {{ "Professional-grade analysis powered by CareerAI (GPT-4o)" if is_pro else "AI-powered fit, ATS score & resume optimization" }}
      </p>
      {% if from_history %}
        <p class="text-xs text-white/50 mt-1">
          Viewing a saved report from your Job Pack history.
        </p>
      {% endif %}
    </div>
    <div class="flex flex-col items-end gap-1">
      {% if is_pro %}
        <span class="px-3 py-1 bg-emerald-500/20 border border-emerald-400/40 rounded-full text-xs font-semibold text-emerald-300">
          Deep Evaluation ‚≠ê
        </span>
      {% else %}
        <span class="px-3 py-1 bg-white/10 border border-white/20 rounded-full text-xs font-semibold text-white/70">
          Free ü™ô
        </span>
      {% endif %}
      <a href="{{ url_for('jobpack.history') }}"
         class="text-[11px] text-white/60 hover:text-white underline">
        View all Job Packs
      </a>
    </div>
  </div>

  {% if result %}

  {% if result.report_tier %}
  <div class="glass-card p-4 rounded-2xl bg-gradient-to-r from-emerald-600/10 to-emerald-400/10 border border-emerald-400/30">
    <p class="text-sm font-semibold text-emerald-300">
      {{ result.report_tier }}
    </p>
  </div>
  {% endif %}

  {% if result.resume_missing %}
  <div class="glass-card p-4 rounded-2xl border border-yellow-400/40 bg-yellow-500/10">
    <p class="text-sm">
      ‚ö†Ô∏è <strong>Heads up:</strong> No resume was provided. We extracted key insights from your Profile Portal or the job description.
      Your ATS score may be limited.
    </p>
  </div>
  {% endif %}

  <!-- SUMMARY -->
  <div class="glass-card p-6 rounded-2xl">
    <h2 class="text-lg font-semibold mb-2">Role Summary</h2>
    <p class="text-white/80 leading-relaxed">{{ result.summary or "No summary available." }}</p>
    <p class="text-sm text-white/60 mt-2">
      Detected Role: <span class="font-semibold">{{ result.role_detected or "‚Äî" }}</span>
    </p>
  </div>

  <!-- FIT OVERVIEW -->
  {% if result.fit_overview %}
  <div class="glass-card p-6 rounded-2xl">
    <h2 class="text-lg font-semibold mb-4">Fit Overview</h2>
    <table class="w-full text-sm border-separate border-spacing-y-2">
      <thead class="text-white/60">
        <tr><th class="text-left">Category</th><th class="text-left">Match</th><th class="text-left">Comment</th></tr>
      </thead>
      <tbody>
      {% for row in result.fit_overview %}
        <tr class="bg-white/5 rounded-xl">
          <td class="p-2 font-semibold">{{ row.category }}</td>
          <td class="p-2 {% if row.match >= 80 %}text-emerald-400{% elif row.match >= 60 %}text-yellow-400{% else %}text-red-400{% endif %}">
            {{ row.match }}%
          </td>
          <td class="p-2 text-white/70">{{ row.comment }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- ATS SCORE -->
  <div class="glass-card p-6 rounded-2xl">
    <h2 class="text-lg font-semibold mb-3">ATS Score</h2>
    <div class="bg-white/10 h-3 rounded-full overflow-hidden">
      <div class="h-3 bg-emerald-500 rounded-full transition-all duration-500" style="width: {{ result.ats_score }}%"></div>
    </div>
    <div class="flex justify-between mt-2 items-center">
      <p class="text-sm text-white/70">
        ATS Compatibility:
        <span class="font-semibold {% if result.ats_score >= 80 %}text-emerald-400{% elif result.ats_score >= 60 %}text-yellow-400{% else %}text-red-400{% endif %}">
          {{ result.ats_score }}%
        </span>
      </p>
      {% if result.resume_missing %}
        <span class="text-xs px-2 py-1 rounded bg-yellow-500/20 border border-yellow-500/30 text-yellow-300">Resume Missing ‚ö†</span>
      {% endif %}
    </div>
  </div>

  <!-- RESUME ATS AUDIT -->
  <div class="glass-card p-6 rounded-2xl border border-emerald-400/30 bg-emerald-600/5">
    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
      Resume ATS Audit
      <span class="text-xs text-emerald-400 font-normal">(Structure, keywords, exact fixes)</span>
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white/5 rounded-xl p-4">
        <div class="flex justify-between items-center mb-1">
          <span class="text-sm font-semibold">Resume ATS Score</span>
          <span class="text-sm font-bold">{{ result.resume_ats.resume_ats_score or 0 }}%</span>
        </div>
        <div class="bg-white/10 h-2 rounded-full overflow-hidden">
          <div class="h-2 bg-emerald-500 transition-all duration-500" style="width: {{ (result.resume_ats.resume_ats_score or 0) | int }}%"></div>
        </div>
      </div>

      <div class="bg-white/5 rounded-xl p-4">
        <h3 class="text-sm font-semibold mb-2">Must Fix (Blockers)</h3>
        <ul class="list-disc pl-5 text-xs space-y-1">
          {% for b in result.resume_ats.blockers %}
            <li>{{ b }}</li>
          {% else %}
            <li>None</li>
          {% endfor %}
        </ul>
      </div>

      <div class="bg-white/5 rounded-xl p-4">
        <h3 class="text-sm font-semibold mb-2">Should Fix (Warnings)</h3>
        <ul class="list-disc pl-5 text-xs space-y-1">
          {% for w in result.resume_ats.warnings %}
            <li>{{ w }}</li>
          {% else %}
            <li>None</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div class="bg-white/5 rounded-xl p-4">
        <h3 class="text-sm font-semibold mb-2">Missing Keywords</h3>
        <div class="flex flex-wrap gap-2">
          {% for k in result.resume_ats.keyword_coverage.missing_keywords[:24] %}
            <span class="px-2 py-1 rounded-lg bg-white/10 border border-white/20 text-xs">{{ k }}</span>
          {% else %}
            <span class="text-xs text-white/60">None</span>
          {% endfor %}
        </div>
      </div>
      <div class="bg-white/5 rounded-xl p-4">
        <h3 class="text-sm font-semibold mb-2">Exact Fixes</h3>
        <ul id="ats-fixes" class="text-xs space-y-1">
          {% for a in result.resume_ats.resume_rewrite_actions %}
            <li>‚Ä¢ {{ a }}</li>
          {% else %}
            <li>No specific fixes generated.</li>
          {% endfor %}
        </ul>
        <button onclick="copyFixes()" class="mt-2 text-xs px-2 py-1 rounded bg-white/10 hover:bg-white/20">Copy ATS Fixes</button>
      </div>
    </div>
  </div>

  <!-- LEARNING LINKS -->
  {% if result.learning_links %}
  <div class="glass-card p-6 rounded-2xl">
    <h2 class="text-lg font-semibold mb-3">Learning Resources</h2>
    <ul class="list-disc pl-5 text-sm space-y-1">
      {% for link in result.learning_links %}
        <li>
          <a class="underline hover:no-underline" href="{{ link.url }}" target="_blank" rel="noopener nofollow">
            {{ link.label }}
          </a>
          {% if link.why %}
            <span class="text-xs text-white/60"> ‚Äî {{ link.why }}</span>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <!-- INTERVIEW Q&A -->
  {% if result.interview_qa %}
  <div class="glass-card p-6 rounded-2xl">
    <h2 class="text-lg font-semibold mb-3">Interview Q&A (Practice)</h2>
    <div class="space-y-3">
      {% for qa in result.interview_qa %}
        <div class="bg-white/5 rounded-lg p-3">
          <p class="text-sm font-semibold">Q: {{ qa.q }}</p>
          {% if qa.a_outline %}
            <p class="text-xs text-white/70 mt-1">Answer outline:</p>
            <ul class="list-disc pl-5 text-xs text-white/80">
              {% for pt in qa.a_outline %}<li>{{ pt }}</li>{% endfor %}
            </ul>
          {% endif %}
          {% if qa.why_it_matters %}
            <p class="text-xs text-white/60 mt-1"><em>Why it matters:</em> {{ qa.why_it_matters }}</p>
          {% endif %}
          {% if qa.followup %}
            <p class="text-xs text-white/60"><em>Follow-up:</em> {{ qa.followup }}</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- DETECTED KEYWORDS -->
  {% if result.detected_keywords %}
  <div class="glass-card p-6 rounded-2xl">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">Detected Keywords</h2>
      <span class="text-xs text-white/60">
        Matched {{ result.matched_count }} / {{ result.matched_count + result.missing_count }}
      </span>
    </div>
    <div class="flex flex-wrap gap-2">
      {% for kw in result.detected_keywords %}
        <span class="px-2 py-1 rounded-lg bg-white/10 border border-white/20 text-xs">{{ kw }}</span>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- REWRITE SUGGESTIONS -->
  <div class="glass-card p-6 rounded-2xl">
    <h2 class="text-lg font-semibold mb-3">Resume Rewrite Suggestions</h2>
    {% if result.rewrite_suggestions %}
      {% for line in result.rewrite_suggestions %}
        <div class="text-sm mb-1 flex justify-between items-center bg-white/5 px-3 py-2 rounded-lg hover:bg-white/10 transition">
          <span>{{ line }}</span>
          <button onclick="navigator.clipboard.writeText(`{{ line }}`)" class="text-xs text-white/60 hover:text-white/90 transition">Copy</button>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-sm text-white/60">No rewrite suggestions were generated for this job.</p>
    {% endif %}
  </div>

  <!-- NEXT STEPS -->
  {% if result.next_steps %}
  <div class="glass-card p-6 rounded-2xl">
    <h2 class="text-lg font-semibold mb-3">Next Steps</h2>
    <ul class="list-disc pl-5 text-sm text-white/80 space-y-1">
      {% for step in result.next_steps %}
        <li>{{ step }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <!-- PRACTICE PLAN -->
  {% if result.practice_plan %}
  <div class="glass-card p-6 rounded-2xl">
    <h2 class="text-lg font-semibold mb-3">Practice Plan</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      {% for blk in result.practice_plan %}
        <div class="bg-white/5 rounded-lg p-3">
          <p class="text-sm font-semibold">{{ blk.period }}</p>
          <p class="text-xs text-white/70">Goals: {{ blk.goals }}</p>
          {% if blk.tasks %}
          <ul class="list-disc pl-5 text-xs text-white/80 mt-1">
            {% for t in blk.tasks %}<li>{{ t }}</li>{% endfor %}
          </ul>
          {% endif %}
          {% if blk.output %}
            <p class="text-xs text-white/60 mt-1"><em>Output:</em> {{ blk.output }}</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- APPLICATION CHECKLIST -->
  {% if result.application_checklist %}
  <div class="glass-card p-6 rounded-2xl">
    <h2 class="text-lg font-semibold mb-3">Application Checklist</h2>
    <ul class="list-disc pl-5 text-sm text-white/80 space-y-1">
      {% for item in result.application_checklist %}
        <li>{{ item }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <!-- IMPACT SUMMARY -->
  <div class="glass-card p-6 rounded-2xl text-center text-sm text-white/70 italic border border-emerald-400/20">
    {{ result.impact_summary or "Evaluation complete. Thank you for using CareerAI." }}
  </div>

  <!-- ACTIONS -->
  <div class="text-center mt-6 space-x-3">
    {% if is_pro %}
      <form method="POST" action="{{ url_for('jobpack.export_pdf') }}" class="inline-block">
        {% if report %}
          <input type="hidden" name="report_id" value="{{ report.id }}">
        {% else %}
          <input type="hidden" name="data" value='{{ result | tojson | forceescape }}'>
        {% endif %}
        <button class="btn-primary px-5 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white transition shadow-lg">
          Download Deep Evaluation PDF ‚≠ê
        </button>
      </form>
    {% else %}
      <a href="{{ url_for('billing.index') }}"
         class="btn-upgrade px-5 py-2 rounded-lg bg-gradient-to-r from-pink-500 to-orange-400 hover:from-pink-600 hover:to-orange-500 transition text-white shadow-lg">
        Upgrade to Deep Evaluation ‚≠ê
      </a>
    {% endif %}
  </div>

  <!-- BACK -->
  <div class="text-center mt-4 space-x-3">
    <a href="{{ url_for('jobpack.index') }}" class="text-sm text-white/60 hover:text-white underline">
      ‚Üê Back to Job Pack
    </a>
    <a href="{{ url_for('jobpack.history') }}" class="text-sm text-white/60 hover:text-white underline">
      History
    </a>
  </div>

  {% else %}
  <div class="glass-card p-6 rounded-2xl text-center text-white/70">
    No results available. Please run a Job Pack analysis first.
  </div>
  {% endif %}

</div>

<script>
function copyFixes(){
  const text = [...document.querySelectorAll('#ats-fixes li')].map(li=>li.innerText).join('\\n');
  navigator.clipboard.writeText(text);
}
</script>

{% endblock %}
