{% extends "base.html" %}
{% block title %}Your Skill Roadmap ‚Äî CareerAI{% endblock %}

{% block content %}
{% set sm = skillmap or {} %}
{% set roles = sm.roles
               or sm.top_roles
               or sm.role_roadmap
               or sm.role_cards
               or sm.primary_roles
               or [] %}
{% set meta = sm.meta or {} %}

<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 mb-16 space-y-6 text-white">

  <!-- HEADER -->
  <div class="glass-card rounded-2xl p-6 sm:p-7 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 border border-white/10 shadow-xl">
    <div class="space-y-1">
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">
        Your Skill Roadmap
      </h1>
      <p class="text-sm text-white/70 max-w-xl">
        Built from your Profile Portal{% if profile_snapshot and profile_snapshot.resume_present %}, latest resume{% endif %}
        {% if meta.region_focus or meta.region %} for
          <span class="font-semibold">
            {{ meta.region_focus or meta.region }}
          </span>
        {% endif %}.
        {% if is_pro %}
          This is a <span class="font-semibold text-emerald-300">Deep Skill Map (Pro)</span>.
        {% else %}
          This is a <span class="font-semibold text-white/80">Free Skill Map</span> with a preview of deeper insights.
        {% endif %}
      </p>

      <!-- Clear ‚Äúwhat to do next‚Äù guidance -->
      <p class="text-[11px] text-white/60 mt-2 max-w-xl">
        What to do next:
        <span class="font-semibold text-white/80">1)</span> Pick <span class="font-semibold">ONE role</span> below as your focus,
        <span class="font-semibold text-white/80">2)</span> use
        <a href="{{ feature_paths.portfolio }}" class="underline hover:text-white">Portfolio</a>
        to build 1‚Äì3 projects for that role,
        <span class="font-semibold text-white/80">3)</span> use
        <a href="{{ feature_paths.jobpack }}" class="underline hover:text-white">Job Packs</a>
        <span class="text-white/70">and</span>
        <a href="{{ feature_paths.internships }}" class="underline hover:text-white">Internship Analyzer</a>
        on real job/internship descriptions, then
        <span class="font-semibold text-white/80">4)</span> use
        <a href="{{ feature_paths.referral }}" class="underline hover:text-white">Referral Trainer</a>
        to reach people for those roles.
      </p>

      {% if meta.used_live_ai %}
        <p class="text-[11px] text-emerald-300/90">
          Live CareerAI model run ¬∑ {{ CAREER_AI_VERSION or '2025-Q4' }}
        </p>
      {% endif %}
    </div>
    <div class="space-y-2 self-start sm:self-auto text-xs text-right">
      {% if profile_snapshot %}
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/20">
          <span class="text-[11px]">Profile Portal</span>
          <span class="font-semibold">{{ profile_snapshot.profile_strength_score or 0 }}% complete</span>
        </div>
      {% endif %}
      <div class="flex flex-wrap justify-end gap-2">
        <a href="{{ url_for('skillmapper.history') }}"
           class="text-[11px] text-white/60 hover:text-white underline">
          View past Skill Maps
        </a>
        <a href="{{ url_for('skillmapper.index') }}"
           class="text-[11px] text-white/60 hover:text-white underline">
          Run again
        </a>
      </div>
    </div>
  </div>

  {% if not roles %}
    <div class="glass-card rounded-2xl p-6 text-sm text-white/70 text-center">
      No roadmap data was returned. Please go back and run Skill Mapper again.
      <div class="mt-3">
        <a href="{{ url_for('skillmapper.index') }}" class="btn-primary px-4 py-2 inline-flex justify-center">
          ‚Üê Back to Skill Mapper
        </a>
      </div>
      {% if sm.call_to_action %}
        <p class="mt-3 text-xs text-white/50">
          Debug note: {{ sm.call_to_action }}
        </p>
      {% endif %}
    </div>
  {% else %}

  <!-- TOP ROLES -->
  <section class="space-y-4">
    <div class="flex items-center justify-between gap-2">
      <h2 class="text-lg sm:text-xl font-semibold">Top roles for you</h2>
      <span class="text-[11px] text-white/60">
        Based on your current skills, projects & preferences.
      </span>
    </div>

    {% for role in roles %}
      {% set show_locked = (not is_pro and not loop.first) %}
      <div class="pro-lock-wrapper {% if show_locked %}pro-locked{% endif %}">
        <div class="pro-lock-blur glass-card rounded-2xl p-5 sm:p-6">
          <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
            <div class="space-y-1.5 flex-1">
              <div class="flex flex-wrap items-center gap-2">
                <h3 class="text-base sm:text-lg font-semibold">
                  {{ role.title or role.role_title or 'Unnamed role' }}
                </h3>
                {% set match_score = role.match_score or role.fit or role.fit_score %}
                {% if match_score is not none %}
                  <span class="px-2.5 py-0.5 rounded-full text-[11px] border
                               {% if match_score >= 80 %}border-emerald-400/70 bg-emerald-500/20 text-emerald-100
                               {% elif match_score >= 60 %}border-yellow-400/70 bg-yellow-500/15 text-yellow-100
                               {% else %}border-sky-400/70 bg-sky-500/15 text-sky-100{% endif %}">
                    Fit: {{ match_score }}%
                  </span>
                {% endif %}
              </div>
              <p class="text-sm text-white/80">
                {{ role.why_fit or role.summary or role.overview or role.description or 'No summary provided.' }}
              </p>
            </div>

            <!-- Quick meta -->
            <div class="flex flex-col items-start sm:items-end gap-1 text-[11px] text-white/60">
              {% if role.level or role.seniority or role.seniority_target %}
                <span>Seniority:
                  <span class="font-semibold text-white/80">
                    {{ role.level or role.seniority or role.seniority_target }}
                  </span>
                </span>
              {% endif %}

              {% set salary = role.salary or (role.compensation.range if role.compensation is defined and role.compensation.range is defined else '') %}
              {% if salary %}
                <span>Typical package:
                  <span class="font-semibold text-white/80">{{ salary }}</span>
                </span>
              {% endif %}

              {% if role.geo or role.region %}
                <span>Region focus:
                  <span class="font-semibold text-white/80">{{ role.geo or role.region }}</span>
                </span>
              {% endif %}
            </div>
          </div>

          <!-- Skills + gaps + micro projects -->
          <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-xs sm:text-[13px]">
            <!-- Skill match -->
            <div class="space-y-2">
              <p class="font-semibold text-white/80 flex items-center gap-1">
                <span>Skill match</span>
              </p>
              {% set clusters = role.primary_skill_clusters or [] %}
              {% set skills = role.skills or role.primary_skills or role.skill_match or [] %}
              {% if clusters %}
                <div class="flex flex-wrap gap-1.5">
                  {% for cluster in clusters %}
                    {% for s in cluster.skills %}
                      <span class="px-2 py-0.5 rounded-full bg-emerald-500/15 border border-emerald-400/40 text-[11px]">
                        {{ s }}
                      </span>
                    {% endfor %}
                  {% endfor %}
                </div>
              {% elif skills %}
                <div class="flex flex-wrap gap-1.5">
                  {% for s in skills %}
                    <span class="px-2 py-0.5 rounded-full bg-emerald-500/15 border border-emerald-400/40 text-[11px]">
                      {{ s.name if s.name is defined else s }}
                    </span>
                  {% endfor %}
                </div>
              {% else %}
                <p class="text-white/60">No specific skills detected.</p>
              {% endif %}

              {% if role.stack %}
                <p class="mt-2 text-[11px] text-white/60">
                  Typical stack:
                  <span class="text-white/80">
                    {{ role.stack | join(', ') }}
                  </span>
                </p>
              {% endif %}
            </div>

            <!-- Gaps -->
            <div class="space-y-2">
              <p class="font-semibold text-white/80">Core gaps to build</p>
              {% set gaps = role.gaps or role.core_gaps or [] %}
              {% if gaps %}
                <div class="flex flex-wrap gap-1.5">
                  {% for g in gaps %}
                    <span class="px-2 py-0.5 rounded-full bg-red-500/10 border border-red-400/40 text-[11px]">
                      {{ g.skill if g.skill is defined else (g.name if g.name is defined else g) }}
                    </span>
                  {% endfor %}
                </div>
              {% else %}
                <p class="text-white/60">No major gaps highlighted.</p>
              {% endif %}
            </div>

            <!-- Micro projects -->
            <div class="space-y-2">
              <p class="font-semibold text-white/80">Micro-project ideas</p>
              {% set projects = role.micro_projects or role.projects or role.mini_projects or [] %}
              {% if projects %}
                <ul class="space-y-1.5">
                  {% for p in projects %}
                    <li>
                      <span class="font-semibold">
                        {{ p.title or p.name or ('Project ' ~ loop.index) }}:
                      </span>
                      <span class="text-white/70">
                        {{ p.outcome or p.description or p.summary }}
                      </span>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-white/60">No projects were suggested for this role.</p>
              {% endif %}
            </div>
          </div>
        </div>

        {% if show_locked %}
          <div class="pro-lock-overlay">
            <h3>Deep roadmap role {{ loop.index }} is Pro-only üîí</h3>
            <p>Upgrade to see all roles, detailed gaps, and copy-paste micro-projects for your Skill Map.</p>
            <a href="{{ url_for('billing.index') }}" class="btn-primary mt-3 text-[11px]">
              Unlock full 3-role roadmap
            </a>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </section>

  <!-- FOOTER SUMMARY -->
  <div class="glass-card rounded-2xl p-5 text-center text-sm text-white/70 mt-6">
    {% if sm.impact_summary %}
      {{ sm.impact_summary }}
    {% else %}
      You can re-run Skill Mapper any time after updating your Profile Portal or adding new projects.
    {% endif %}
  </div>

  {% endif %}
</div>
{% endblock %}
