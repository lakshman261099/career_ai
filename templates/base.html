{# templates/base.html #}

{# -----------------------------
   Safe defaults
   ----------------------------- #}
{% set FREE = user_free|default(0, true) %}
{% set PRO  = user_pro|default(0, true) %}

{# feature_paths can be missing on admin/auth pages; keep base.html crash-proof #}
{% set feature_paths = feature_paths|default({}) %}
{% set fp_home        = feature_paths.home|default(url_for('dashboard'), true) %}
{% set fp_portfolio   = feature_paths.portfolio|default('#', true) %}
{% set fp_internships = feature_paths.internships|default('#', true) %}
{% set fp_skillmapper = feature_paths.skillmapper|default('#', true) %}
{% set fp_referral    = feature_paths.referral|default('#', true) %}
{% set fp_jobpack     = feature_paths.jobpack|default('#', true) %}
{% set fp_dream       = feature_paths.dream|default('#', true) %}
{% set fp_coach       = feature_paths.coach|default(url_for('coach.index'), true) %}
{% set fp_billing     = feature_paths.billing|default('#', true) %}
{% set fp_profile     = feature_paths.profile|default('#', true) %}
{% set fp_settings    = feature_paths.settings|default('#', true) %}
{% set fp_logout      = feature_paths.logout|default('#', true) %}
{% set fp_signup      = feature_paths.signup|default('#', true) %}
{% set fp_login       = feature_paths.login|default('#', true) %}
{% set fp_admin_home  = feature_paths.admin_home|default(None, true) %}

{# ------------------------------------------------------------
   Role detection for header UI (Admin vs Student)
   - IMPORTANT: University admins must NOT see student UI
   - Robust even if role string is missing OR is_* flags are callables
   ------------------------------------------------------------ #}
{% set _authed = (current_user.is_authenticated if current_user is defined else false) %}
{% set role_raw = (((current_user.role or '')|trim|lower) if _authed else '') %}

{# callable-safe flags #}
{% set _uni_flag = false %}
{% if _authed and (current_user.is_university_admin is defined) %}
  {% if current_user.is_university_admin is callable %}
    {% set _uni_flag = current_user.is_university_admin() %}
  {% else %}
    {% set _uni_flag = current_user.is_university_admin %}
  {% endif %}
{% endif %}

{% set _super_flag = false %}
{% if _authed and (current_user.is_super_admin is defined) %}
  {% if current_user.is_super_admin is callable %}
    {% set _super_flag = current_user.is_super_admin() %}
  {% else %}
    {% set _super_flag = current_user.is_super_admin %}
  {% endif %}
{% endif %}

{% set _ultra_flag = false %}
{% if _authed and (current_user.is_ultra_admin is defined) %}
  {% if current_user.is_ultra_admin is callable %}
    {% set _ultra_flag = current_user.is_ultra_admin() %}
  {% else %}
    {% set _ultra_flag = current_user.is_ultra_admin %}
  {% endif %}
{% endif %}

{# role-based flags (string) + attribute flags #}
{% set is_uni_admin    = _authed and (role_raw == 'university_admin' or _uni_flag) %}
{% set is_super_admin  = _authed and (role_raw == 'super_admin' or _super_flag) %}
{% set is_ultra_admin  = _authed and (role_raw == 'ultra_admin' or _ultra_flag) %}
{% set is_global_admin = is_super_admin or is_ultra_admin %}

{# Prefer server-provided nav_mode if available (most reliable) #}
{% set _nav_mode = (nav_mode|default(None)) %}
{% set is_any_admin =
    (_authed and _nav_mode == 'admin')
    or (_authed and (is_uni_admin or is_global_admin))
    or (_authed and (nav_is_admin|default(false)))
%}

{# Subscription status (prefer current_user if template var not provided) #}
{% set _sub_status = 'free' %}
{% if subscription_status is defined and subscription_status %}
  {% set _sub_status = (subscription_status|string|lower) %}
{% elif _authed and current_user is defined and current_user.subscription_status is defined and current_user.subscription_status %}
  {% set _sub_status = (current_user.subscription_status|string|lower) %}
{% endif %}

{# Admin home routing #}
{% set admin_home = None %}
{% if fp_admin_home and fp_admin_home != '#' %}
  {% set admin_home = fp_admin_home %}
{% else %}
  {% if is_uni_admin %}
    {% set admin_home = url_for('admin.strategy') %}
  {% elif is_global_admin or (nav_is_admin|default(false)) %}
    {% set admin_home = url_for('admin.dashboard') %}
  {% endif %}
{% endif %}

<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}CareerAI{% endblock %}</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: {
            brand: { 500:'#f97316', 600:'#ea580c' },
            ink:   { 900:'#020617', 800:'#020617' }
          },
          boxShadow: {
            glow: '0 8px 30px rgba(249,115,22,.25)',
            neon: '0 0 25px rgba(96,165,250,.8)'
          }
        }
      }
    }
  </script>

  <!-- Fonts + Glass CSS -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/glass.css') }}"/>

  <style>
    /* Global textured layer */
    body::before {
      content:"";
      position:fixed;
      inset:0;
      z-index:-2;
      pointer-events:none;
      opacity:.20;
      mix-blend-mode:soft-light;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/><feComponentTransfer><feFuncA type='table' tableValues='0 0.16'/></feComponentTransfer></filter><rect width='100%' height='100%' filter='url(%23n)'/></svg>");
      background-size: 240px 240px;
    }

    /* Base gradient behind everything */
    .ca-root-gradient {
      position:fixed;
      inset:0;
      z-index:-3;
      background:
        radial-gradient(circle at top left, rgba(96,165,250,.45), transparent 55%),
        radial-gradient(circle at bottom right, rgba(249,115,22,.5), transparent 55%),
        radial-gradient(circle at top right, rgba(139,92,246,.45), transparent 55%),
        #020617;
    }

    .nav-link {
      position: relative;
      opacity:.85;
      padding: .25rem .4rem;
      border-radius: 999px;
      transition: opacity 140ms ease-out, background-color 140ms ease-out, color 140ms ease-out;
    }
    .nav-link::after {
      content:"";
      position:absolute;
      left:18%;
      right:18%;
      bottom:-0.45rem;
      height:2px;
      border-radius:999px;
      background:linear-gradient(90deg,#6366f1,#f97316);
      opacity:0;
      transform:scaleX(.4);
      transform-origin:center;
      transition:opacity 140ms ease-out, transform 160ms ease-out;
    }
    .nav-link:hover {
      opacity:1;
      background-color:rgba(15,23,42,.5);
    }
    .nav-active {
      opacity:1;
      color:#fff;
      background-color:rgba(15,23,42,.75);
    }
    .nav-active::after {
      opacity:1;
      transform:scaleX(1);
    }

    /* Buttons (no @apply so CDN Tailwind works) */
    .btn-primary {
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      padding:.5rem 1rem;
      border-radius:999px;
      background:linear-gradient(135deg,#4f46e5,#6366f1,#f97316);
      color:#fff;
      font-weight:600;
      font-size:.875rem;
      box-shadow:0 10px 30px rgba(79,70,229,.7);
      border:1px solid rgba(191,219,254,.5);
      transition:transform 140ms ease-out, box-shadow 140ms ease-out, filter 140ms ease-out;
      text-decoration:none;
    }
    .btn-primary:hover {
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(79,70,229,.9);
      filter:brightness(1.05);
    }

    .btn-ghost {
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      padding:.4rem .9rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.2);
      color:rgba(248,250,252,.8);
      font-size:.8rem;
      background:rgba(15,23,42,.7);
      text-decoration:none;
      transition:border-color 140ms ease-out, color 140ms ease-out, background-color 140ms ease-out;
    }
    .btn-ghost:hover {
      border-color:rgba(248,250,252,.5);
      color:#fff;
      background:rgba(15,23,42,.9);
    }

    .glass-bar   { background: rgba(15,23,42,.80); backdrop-filter: blur(18px); border:1px solid rgba(148,163,184,.55); }
    .glass-card  { background: rgba(15,23,42,.85); backdrop-filter: blur(18px); border:1px solid rgba(148,163,184,.45); border-radius: .9rem; }
    .glass-panel { background: rgba(15,23,42,.88); backdrop-filter: blur(18px); border:1px solid rgba(148,163,184,.45); }

    /* Coins pill */
    .coins-pill { display:none; }
    @media (min-width: 640px) { .coins-pill { display:flex; } }
    .coins-chip { font-weight:600; }
    .coins-sep { opacity:.4; }

    /* Tiny header glow line */
    .header-neon-line {
      position:absolute;
      inset-inline:10%;
      bottom:-1px;
      height:1px;
      background:linear-gradient(90deg,transparent,#4f46e5,#6366f1,#f97316,transparent);
      opacity:.9;
      filter:blur(.2px);
    }

    /* ---------- Pro lock helpers (used by features) ---------- */
    .pro-lock-wrapper {
      position: relative;
      border-radius: 0.9rem;
      overflow: hidden;
    }
    .pro-lock-blur {
      transition: filter 160ms ease-out, opacity 160ms ease-out;
    }
    .pro-lock-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 1.5rem;
      text-align: center;
      background: radial-gradient(circle at top, rgba(15,23,42,0.2), rgba(15,23,42,0.96));
      backdrop-filter: blur(6px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease-out;
    }
    .pro-lock-overlay h3 {
      font-size: .9rem;
      font-weight: 600;
      margin-bottom: .35rem;
    }
    .pro-lock-overlay p {
      font-size: .75rem;
      opacity: .8;
      max-width: 260px;
    }
    .pro-locked .pro-lock-blur {
      filter: blur(4px) grayscale(0.1);
      pointer-events: none;
    }
    .pro-locked .pro-lock-overlay {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>

<body class="h-full text-white" style="font-family: Inter, ui-sans-serif, system-ui;">
  <!-- Global background gradient -->
  <div class="ca-root-gradient"></div>

  <!-- Top navigation -->
  <header class="fixed top-0 inset-x-0 z-[99999] pointer-events-auto isolate">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pt-4 pb-2">
      <div class="relative glass-bar rounded-2xl px-4 py-3 flex items-center justify-between shadow-lg shadow-black/40">
        <!-- Logo + name -->
        <a href="{% if is_any_admin and admin_home %}{{ admin_home }}{% else %}{{ fp_home }}{% endif %}"
           class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl bg-gradient-to-tr from-indigo-500 via-purple-500 to-fuchsia-500 border border-indigo-200/70 grid place-items-center shadow-neon">
            <span class="text-xl font-extrabold">C</span>
          </div>
          <span class="font-semibold tracking-wide text-sm sm:text-base">CareerAI</span>

          {% if is_any_admin %}
            <span class="ml-2 text-[10px] px-2 py-0.5 rounded-full bg-indigo-500/15 border border-indigo-300/70 uppercase tracking-widest text-indigo-100">
              Admin
            </span>
          {% elif _sub_status == 'pro' %}
            <span class="ml-2 text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/15 border border-emerald-300/70 uppercase tracking-widest text-emerald-100">
              Pro
            </span>
          {% endif %}
        </a>

        <!-- Nav links (desktop) -->
        <nav class="hidden md:flex items-center gap-5 text-[13px]">
          {% if not is_any_admin %}
            {# STUDENT NAV (hidden for ALL admins) #}
            <a class="nav-link {% if request.endpoint in ['portfolio.index','portfolio.wizard'] %}nav-active{% endif %}"
               href="{{ fp_portfolio }}">Portfolio</a>
            <a class="nav-link {% if request.endpoint=='internships.index' %}nav-active{% endif %}"
               href="{{ fp_internships }}">Internships</a>
            <a class="nav-link {% if request.endpoint=='skillmapper.index' %}nav-active{% endif %}"
               href="{{ fp_skillmapper }}">Skill Mapper</a>
            <a class="nav-link {% if request.endpoint=='referral.index' %}nav-active{% endif %}"
               href="{{ fp_referral }}">Referrals</a>
            <a class="nav-link {% if request.endpoint and request.endpoint.startswith('jobpack.') %}nav-active{% endif %}"
               href="{{ fp_jobpack }}">Job Packs</a>
            <a class="nav-link {% if request.endpoint and request.endpoint.startswith('dream.') %}nav-active{% endif %}"
               href="{{ fp_dream }}">Dream Planner</a>
            <a class="nav-link {% if request.endpoint and request.endpoint.startswith('coach.') %}nav-active{% endif %}"
               href="{{ fp_coach }}">Coach</a>
            <a class="nav-link {% if request.endpoint and request.endpoint.startswith('billing.') %}nav-active{% endif %}"
               href="{{ fp_billing }}">Pricing</a>

          {% else %}
            {# ADMIN NAV (shown to university admins + global admins) #}
            {% if is_uni_admin %}
              <a class="nav-link {% if request.endpoint and request.endpoint == 'admin.strategy' %}nav-active{% endif %}"
                 href="{{ url_for('admin.strategy') }}">Dean Dashboard</a>
              <a class="nav-link {% if request.endpoint and request.endpoint == 'admin.users' %}nav-active{% endif %}"
                 href="{{ url_for('admin.users') }}">Students</a>
              <a class="nav-link {% if request.endpoint and request.endpoint == 'admin.analytics' %}nav-active{% endif %}"
                 href="{{ url_for('admin.analytics') }}">Student Analytics</a>
            {% else %}
              <a class="nav-link {% if request.endpoint and request.endpoint.startswith('admin.') %}nav-active{% endif %}"
                 href="{{ url_for('admin.dashboard') }}">Admin Overview</a>
              <a class="nav-link {% if request.endpoint == 'admin.universities' %}nav-active{% endif %}"
                 href="{{ url_for('admin.universities') }}">Universities</a>
              <a class="nav-link {% if request.endpoint == 'admin.university_wallets' %}nav-active{% endif %}"
                 href="{{ url_for('admin.university_wallets') }}">Wallets</a>
              <a class="nav-link {% if request.endpoint == 'admin.deals' %}nav-active{% endif %}"
                 href="{{ url_for('admin.deals') }}">Deals</a>
              <a class="nav-link {% if request.endpoint == 'admin.vouchers' %}nav-active{% endif %}"
                 href="{{ url_for('admin.vouchers') }}">Vouchers</a>
              {% if is_ultra_admin %}
                <a class="nav-link {% if request.endpoint == 'admin.audit' %}nav-active{% endif %}"
                   href="{{ url_for('admin.audit') }}">Audit</a>
              {% endif %}
            {% endif %}
          {% endif %}
        </nav>

        <!-- Right cluster -->
        <div class="flex items-center gap-3">

          {# Hide coins for admins (admins should not see student currency UI) #}
          {% if not is_any_admin %}
            <div class="coins-pill items-center gap-2 rounded-full border border-slate-200/35 bg-slate-900/70 px-3 py-1 text-[11px] shadow-lg shadow-black/30">
              <span class="coins-chip">ü™ô {{ FREE }}</span>
              <span class="coins-sep">|</span>
              <span class="coins-chip">‚≠ê {{ PRO }}</span>
            </div>
          {% endif %}

          {% if _authed %}
            {% if not is_any_admin %}
              <a href="{{ fp_profile }}"
                 class="btn-ghost hidden sm:inline {% if request.endpoint=='settings.profile' %}nav-active{% endif %}">
                <span>Profile Portal</span>
                <span class="hidden md:inline text-[10px] opacity-70">¬∑ start here ¬∑ powers all tools</span>
              </a>
              <a href="{{ fp_settings }}"
                 class="btn-ghost hidden sm:inline {% if request.endpoint and request.endpoint.startswith('settings.') and request.endpoint != 'settings.profile' %}nav-active{% endif %}">
                Settings
              </a>
            {% else %}
              <a href="{{ admin_home if admin_home else url_for('admin.dashboard') }}"
                 class="btn-ghost hidden sm:inline {% if request.endpoint and request.endpoint.startswith('admin.') %}nav-active{% endif %}">
                Admin Console
              </a>
            {% endif %}

            <a href="{{ fp_logout }}" class="btn-primary">Logout</a>
          {% else %}
            <a href="{{ fp_signup }}" class="btn-ghost hidden sm:inline">Sign up</a>
            <a href="{{ fp_login }}" class="btn-primary">Login</a>
          {% endif %}
        </div>

        <div class="header-neon-line"></div>
      </div>
    </div>
  </header>

  <!-- Content wrapper (offset fixed header height) -->
  <div class="pt-24">
    <!-- Flash messages -->
    <div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 mt-4 space-y-2">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for cat, msg in messages %}
            <div class="glass-card border-l-4 px-4 py-3
                        {% if cat in ['danger','error'] %}border-red-400
                        {% elif cat == 'warning' %}border-yellow-400
                        {% elif cat=='success' %}border-emerald-400
                        {% else %}border-brand-500{% endif %}">
              <p class="text-sm">{{ msg|safe }}</p>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>

    {# Email verification banner ‚Äî hide for admins to keep admin UI clean #}
    {% if _authed and not is_any_admin %}
      {% set _is_verified = (
           _authed
           and (
             (current_user.email_verified|default(false))
             or
             (current_user.verified|default(false))
           )
         )
      %}
      {% if not _is_verified %}
        <div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 mt-3">
          <div class="glass-card rounded-2xl border border-yellow-400/70 px-4 py-3 flex flex-wrap items-center justify-between gap-2 text-xs sm:text-sm text-amber-100">
            <div class="space-y-0.5">
              <p class="font-semibold">Verify your email to unlock AI features.</p>
              <p class="text-amber-100/80 text-[11px] sm:text-xs">
                You can browse all tools, but AI actions (analyze, generate, etc.) need a one-time email code.
              </p>
            </div>
            <a href="{{ url_for('auth.otp_request') }}" class="btn-primary text-xs whitespace-nowrap">
              Get login code
            </a>
          </div>
        </div>
      {% endif %}
    {% endif %}

    {# Student onboarding strip ‚Äî hide for admins #}
    {% if _authed and not is_any_admin %}
      <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 mt-3">
        <div class="glass-card rounded-2xl px-4 py-2.5 flex flex-wrap items-center gap-2 text-[11px] text-white/70">
          <span class="font-semibold text-white/80">Simple way to use CareerAI:</span>
          <span>1) <strong>Fill Profile Portal</strong></span>
          <span class="hidden sm:inline">‚Üí 2) Run <strong>Dream Planner</strong> &amp; <strong>Coach</strong></span>
          <span class="hidden sm:inline">‚Üí 3) Map roles with <strong>Skill Mapper</strong></span>
          <span class="hidden sm:inline">‚Üí 4) Build <strong>Projects in Portfolio</strong></span>
          <span class="hidden sm:inline">‚Üí 5) Use <strong>Job Packs &amp; Internship Analyzer</strong></span>
          <span class="hidden sm:inline">‚Üí 6) Send <strong>Referral messages</strong></span>
        </div>
      </div>
    {% endif %}

    <!-- Page content -->
    <main class="relative z-0">
      {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="mt-16 mb-10">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="glass-bar rounded-2xl p-4 text-[11px] text-white/60 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <span>¬© {{ now.year if now else 2025 }} CareerAI ¬∑ Built for students &amp; new grads</span>
          <span>Flask ¬∑ SQLAlchemy ¬∑ OpenAI ¬∑ Glass UI</span>
        </div>
      </div>
    </footer>
  </div>

  <!-- Safety: unlock body on history navigation -->
  <script>
    (function () {
      function unlockBody() {
        document.body.classList.remove("overflow-hidden");
      }
      window.addEventListener("pageshow", unlockBody);
      window.addEventListener("popstate", unlockBody);
    })();
  </script>

  <!-- üîß Safer fix: only handle explicitly-marked <a> inside forms, never header/nav -->
  <script>
    (function () {
      document.addEventListener(
        "click",
        function (e) {
          // Only normal left-clicks, no modifier keys
          if (e.button !== 0) return;
          if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;

          const target = e.target;
          if (!target || !target.closest) return;

          // Only anchors explicitly marked for this behavior
          const anchor = target.closest("a[data-form-overlay-fix='1']");
          if (!anchor) return;

          // Never intercept clicks in the fixed header/nav
          if (anchor.closest("header")) return;

          // Only care when that anchor is inside a form
          const form = anchor.closest("form");
          if (!form) return;

          // Treat as form action, not navigation
          e.preventDefault();
          e.stopPropagation();
          if (typeof e.stopImmediatePropagation === "function") {
            e.stopImmediatePropagation();
          }

          // If the click was on a submit button, actually submit the form
          const submitter = target.closest("button, input[type='submit']");
          if (submitter) {
            try {
              if (typeof form.requestSubmit === "function") {
                form.requestSubmit(submitter);
              } else {
                form.submit();
              }
            } catch (err) {
              try { form.submit(); } catch (err2) {}
            }
          }
        },
        true // capture phase so we beat overlay handlers
      );
    })();
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
