{% extends "base.html" %}
{% block title %}Your Dream Plan ‚Äî CareerAI{% endblock %}

{% block content %}
{# Extract meta and path type safely #}
{% set meta = plan.meta if plan and plan.meta else {} %}
{% set path_type = (plan.mode or meta.path_type or 'job')|lower %}
{% set input = plan.input or {} %}

{# timeline_months: accept either legacy "timeline_months" or new "timeline" radio values #}
{% set _raw_timeline_months = input.timeline_months if input and input.timeline_months is defined else None %}
{% set _raw_timeline = input.timeline if input and input.timeline is defined else None %}
{% if _raw_timeline_months %}
  {% set timeline_months = (_raw_timeline_months or 3)|int %}
{% else %}
  {% if _raw_timeline == '28_days' %}
    {% set timeline_months = 1 %}
  {% else %}
    {% set timeline_months = 3 %}
  {% endif %}
{% endif %}

{% set is_sprint = (timeline_months == 1) %}
{% set horizon_label = '28-Day' if is_sprint else timeline_months ~ '-Month' %}
{% set horizon_sentence = '28 days' if is_sprint else timeline_months ~ ' months' %}

<section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 mb-16 space-y-8 text-white">

  <header class="glass-card rounded-2xl p-7 sm:p-9 border border-white/10 shadow-2xl relative overflow-hidden">
    <div class="pointer-events-none absolute inset-0 opacity-40">
      <div class="w-full h-full bg-[radial-gradient(circle_at_top_right,rgba(16,185,129,0.2),transparent_50%),radial-gradient(circle_at_bottom_left,rgba(56,189,248,0.18),transparent_50%)]"></div>
    </div>

    <div class="relative flex flex-col md:flex-row md:items-start md:justify-between gap-8">
      <div class="space-y-4 max-w-2xl">
        <div class="inline-flex flex-wrap items-center gap-2">
          <span class="px-3 py-1 rounded-full bg-black/50 border border-white/15 text-[11px] uppercase tracking-widest font-semibold text-emerald-300 flex items-center gap-1.5">
            {% if path_type == 'startup' %}
              <i data-lucide="rocket" class="w-3.5 h-3.5"></i> Dream Startup Plan
            {% else %}
              <i data-lucide="briefcase" class="w-3.5 h-3.5"></i> Dream Job Plan
            {% endif %}
          </span>
          {% if meta.used_live_ai %}
            <span class="px-2.5 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/40 text-[10px] uppercase tracking-wide text-emerald-200">
              Generated with CareerAI Pro Engine
            </span>
          {% endif %}
        </div>

        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold tracking-tight leading-tight">
          {% if path_type == 'startup' %}
            Your {{ horizon_label }} Founder Roadmap
          {% else %}
            Your {{ horizon_label }} Career Roadmap
          {% endif %}
        </h1>

        <p class="text-white/75 text-sm sm:text-base leading-relaxed">
          Based on your goal:
          <span class="text-white font-semibold">
            "{{ input.target_role or 'Your Dream Role / Idea' }}"
          </span>.
          This plan is tuned to your chosen horizon of
          <span class="font-semibold">{{ horizon_sentence }}</span>
          and the gaps between your current profile and market expectations.
        </p>
      </div>

      <div class="flex flex-col items-end gap-4 pt-2">
        {% if profile_snapshot %}
          <div class="text-right">
            <p class="text-[10px] uppercase tracking-wider text-white/50 mb-1">Profile Strength</p>
            <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-emerald-500/10 border border-emerald-500/30 text-emerald-300 font-bold text-sm">
              <i data-lucide="activity" class="w-4 h-4"></i>
              {{ profile_snapshot.profile_strength_score or 0 }}%
            </div>
          </div>
        {% endif %}
        <div class="flex gap-3 mt-2 text-xs">
           {% if feature_paths is defined and feature_paths.skillmapper %}
             <a href="{{ feature_paths.skillmapper }}" class="text-white/60 hover:text-white transition-colors flex items-center gap-1">
               <i data-lucide="arrow-left" class="w-3 h-3"></i> Back to Skill Mapper
             </a>
           {% else %}
             <a href="/" class="text-white/60 hover:text-white transition-colors flex items-center gap-1">
               <i data-lucide="arrow-left" class="w-3 h-3"></i> Back to home
             </a>
           {% endif %}
           <a href="{{ url_for('dream.index', path_type=path_type) }}" class="text-white/60 hover:text-white transition-colors flex items-center gap-1">
             <i data-lucide="refresh-cw" class="w-3 h-3"></i> Regenerate Plan
           </a>
        </div>
      </div>
    </div>

    {# --- Coach CTA block (UPDATED: Lock Plan & Coach Section per merge guide) --- #}
    <div class="relative mt-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 border-t border-white/10 pt-4">

      {% set lock_snapshot_id = (snapshot_id if snapshot_id is defined and snapshot_id else (snapshot.id if snapshot is defined and snapshot.id else 0)) %}
      {% set projects = projects if projects is defined and projects else [] %}
      {% set is_locked = is_locked if is_locked is defined else False %}

      {% if (projects and (not is_locked)) or is_locked %}
        <!-- ‚úÖ UPDATED: Lock Plan & Coach Section -->
        <div class="w-full">
          {% if not is_locked and projects %}
          <div class="glass-card rounded-2xl p-6 border border-white/10">
            <h3 class="text-xl font-bold mb-4">Select Your Focus Projects</h3>

            <form method="POST" action="{{ url_for('dream.lock_plan', snapshot_id=lock_snapshot_id) }}" class="space-y-4">
              {% for project in projects %}
              <label class="block p-4 rounded-xl border-2 border-white/10 bg-white/5
                            hover:border-indigo-500/50 hover:bg-indigo-500/5 cursor-pointer transition-all">
                <input type="checkbox" name="selected_projects" value="{{ loop.index0 }}"
                       {% if loop.index0 == 0 %}checked{% endif %} class="sr-only peer">
                <div class="peer-checked:ring-2 peer-checked:ring-indigo-500 peer-checked:bg-indigo-500/10 rounded-lg p-4">
                  <h4 class="font-bold">{{ project.title }}</h4>
                  <p class="text-sm text-white/70 mt-2">{{ project.description }}</p>
                  <div class="flex flex-wrap gap-2 mt-3">
                    {% for tech in project.tech_stack %}
                    <span class="px-2 py-1 rounded-md bg-white/10 text-xs">{{ tech }}</span>
                    {% endfor %}
                  </div>
                </div>
              </label>
              {% endfor %}

              <button type="submit" class="btn-primary w-full py-4 justify-center">
                <i data-lucide="lock" class="w-5 h-5"></i>
                Lock Plan & Start Coach
              </button>
            </form>
          </div>

          {% elif is_locked %}
          <div class="glass-card rounded-2xl p-6 border border-emerald-500/30 bg-emerald-500/10 text-center">
            <div class="flex items-center justify-center gap-2 mb-3">
              <i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i>
              <span class="font-semibold text-emerald-300">Plan Locked!</span>
            </div>
            <a href="{{ url_for('coach.index', path_type=path_type) }}" class="btn-primary inline-flex">
              <i data-lucide="play" class="w-4 h-4"></i>
              Start Weekly Coach
            </a>
          </div>
          {% endif %}
        </div>
      {% else %}

        {% if is_pro_user %}
          <form
            method="post"
            action="{{ url_for('coach.start') }}"
            class="flex flex-col sm:flex-row gap-3"
          >
            <input type="hidden" name="path_type" value="{{ path_type }}">

            <button
              type="submit"
              class="inline-flex items-center justify-center px-5 py-3 rounded-xl
                     text-sm sm:text-base font-semibold
                     bg-emerald-500 hover:bg-emerald-600
                     text-white shadow-lg shadow-emerald-500/30
                     transition-all duration-150"
            >
              <i data-lucide="target" class="w-4 h-4 mr-2"></i>
              Start Weekly Coach from Phase 1
            </button>
          </form>
        {% else %}
          <div class="text-xs sm:text-sm text-white/80">
            üîí Weekly Coach is a Pro ‚≠ê feature.
            <a
              href="{{ url_for('billing.index') }}"
              class="underline underline-offset-4 hover:text-white"
            >
              Upgrade to turn this plan into guided weekly execution.
            </a>
          </div>
        {% endif %}

      {% endif %}

      <p class="text-[11px] sm:text-xs text-white/55 max-w-md">
        Weekly Coach breaks this roadmap into small, realistic weekly actions with a streak counter,
        so you keep moving even when life gets messy.
      </p>
    </div>
  </header>

  <!-- ‚úÖ NEW: Probability Matrix (per merge guide) -->
  {% if plan and path_type != 'startup' %}
    {% set probs_src = plan.probabilities or {} %}
    {% set projected_src = projected_probabilities if projected_probabilities is defined and projected_probabilities else (plan.projected_probabilities if plan.projected_probabilities is defined and plan.projected_probabilities else {}) %}
    {% set bold_truth = bold_truth if bold_truth is defined else (plan.bold_truth if plan.bold_truth is defined else None) %}

    {# Build "probabilities" dict safely from common shapes #}
    {% set probabilities = probabilities if probabilities is defined and probabilities else {
      '3': (probs_src.get('3') or probs_src.get('lpa_3') or probs_src.get('lpa03') or 0),
      '6': (probs_src.get('6') or probs_src.get('lpa_6') or probs_src.get('lpa06') or 0),
      '12': (probs_src.get('12') or probs_src.get('lpa_12') or probs_src.get('lpa12') or 0),
      '24': (probs_src.get('24') or probs_src.get('lpa_24') or probs_src.get('lpa24') or 0)
    } %}

    {% set projected_probabilities = projected_src if projected_src is mapping else {} %}

    {% if probabilities or projected_probabilities %}
    <div class="glass-card rounded-2xl p-6 sm:p-8 border border-white/10 space-y-6">
      <div class="flex items-start justify-between">
        <div>
          <h2 class="text-2xl font-bold flex items-center gap-2">
            <i data-lucide="trending-up" class="w-6 h-6 text-indigo-400"></i>
            Career Probability Analysis
          </h2>
          <p class="text-sm text-white/60 mt-1">
            Current skills vs. Projected after completing the plan
          </p>
        </div>
      </div>

      <div class="space-y-6">
        {% for lpa in ['3', '6', '12', '24'] %}
        {% set current = probabilities.get(lpa, 0)|int %}
        {% set projected = projected_probabilities.get(lpa, 0)|int %}
        {% set tier_label = {'3': 'Entry-level', '6': 'Junior', '12': 'Mid-level', '24': 'Senior'}[lpa] %}

        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <!-- LPA Badge with tier-specific colors -->
              {% if lpa == '3' %}
              <div class="w-16 h-16 rounded-xl bg-emerald-500/10 border-2 border-emerald-500/30 flex items-center justify-center">
                <span class="text-2xl font-bold text-emerald-300">3+</span>
              </div>
              {% elif lpa == '6' %}
              <div class="w-16 h-16 rounded-xl bg-blue-500/10 border-2 border-blue-500/30 flex items-center justify-center">
                <span class="text-2xl font-bold text-blue-300">6+</span>
              </div>
              {% elif lpa == '12' %}
              <div class="w-16 h-16 rounded-xl bg-purple-500/10 border-2 border-purple-500/30 flex items-center justify-center">
                <span class="text-2xl font-bold text-purple-300">12+</span>
              </div>
              {% else %}
              <div class="w-16 h-16 rounded-xl bg-pink-500/10 border-2 border-pink-500/30 flex items-center justify-center">
                <span class="text-2xl font-bold text-pink-300">24+</span>
              </div>
              {% endif %}
              
              <div>
                <div class="font-bold text-lg text-white">{{ lpa }}+ LPA</div>
                <div class="text-xs text-white/60">{{ tier_label }} Roles</div>
              </div>
            </div>
            {% if projected > current %}
            <div class="px-4 py-2 rounded-lg bg-emerald-500/10 border border-emerald-500/30">
              <div class="text-xs text-emerald-300 font-semibold uppercase tracking-wider">Growth Potential</div>
              <div class="text-2xl font-bold text-emerald-400">+{{ projected - current }}%</div>
            </div>
            {% endif %}
          </div>

          <div class="grid grid-cols-2 gap-4">
            <!-- CURRENT Bar -->
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-xs font-semibold text-white/70 uppercase tracking-wider">Current</span>
                <span class="text-lg font-bold text-gray-300">{{ current }}%</span>
              </div>
              <div class="h-4 bg-white/5 rounded-full overflow-hidden border border-white/10">
                <div class="h-full bg-gradient-to-r from-gray-600 to-gray-400 transition-all duration-1000 flex items-center justify-end pr-2"
                     style="width: {{ current }}%; min-width: {{ '30px' if current > 0 else '0' }}">
                  {% if current >= 15 %}
                  <span class="text-[10px] font-bold text-white drop-shadow">{{ current }}%</span>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- PROJECTED Bar -->
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-xs font-semibold text-emerald-300 uppercase tracking-wider">Projected</span>
                <span class="text-lg font-bold text-emerald-400">{{ projected }}%</span>
              </div>
              <div class="h-4 bg-white/5 rounded-full overflow-hidden border border-emerald-500/20">
                <div class="h-full bg-gradient-to-r from-emerald-600 to-emerald-400 transition-all duration-1000 flex items-center justify-end pr-2"
                     style="width: {{ projected }}%; min-width: {{ '30px' if projected > 0 else '0' }}">
                  {% if projected >= 15 %}
                  <span class="text-[10px] font-bold text-white drop-shadow">{{ projected }}%</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          {% if projected > current %}
          <div class="flex items-center gap-2 text-xs text-emerald-400 bg-emerald-500/5 px-3 py-2 rounded-lg border border-emerald-500/20">
            <i data-lucide="trending-up" class="w-3.5 h-3.5"></i>
            <span>After completing this plan, your probability increases by <strong>{{ projected - current }}%</strong></span>
          </div>
          {% elif projected == current %}
          <div class="flex items-center gap-2 text-xs text-blue-400 bg-blue-500/5 px-3 py-2 rounded-lg border border-blue-500/20">
            <i data-lucide="target" class="w-3.5 h-3.5"></i>
            <span>Your current skills already position you well for this tier</span>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>

      {% if bold_truth %}
      <div class="p-5 rounded-xl bg-amber-500/10 border-2 border-amber-500/30">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-lg bg-amber-500/20 flex items-center justify-center flex-shrink-0">
            <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-400"></i>
          </div>
          <div class="flex-1">
            <div class="text-sm font-semibold text-amber-300 mb-1">‚ö° Reality Check</div>
            <p class="text-white/90 leading-relaxed">{{ bold_truth }}</p>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}
  {% endif %}

  {% if not plan %}
    <div class="glass-card rounded-2xl p-8 text-center border border-white/10">
      <div class="w-12 h-12 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4 text-white/50">
        <i data-lucide="alert-circle" class="w-6 h-6"></i>
      </div>
      <h3 class="text-lg font-semibold text-white">Plan Not Found</h3>
      <p class="text-white/60 text-sm mt-2 max-w-md mx-auto">
        We couldn't retrieve the plan data. This might be a temporary glitch.
      </p>
      <a href="{{ url_for('dream.index') }}" class="mt-6 btn-primary inline-flex items-center gap-2">
        Try Again
      </a>
    </div>
  {% else %}

    {% if plan.summary %}
    <div class="glass-card rounded-2xl p-6 sm:p-7 border-l-4 border-l-emerald-500 border-y border-r border-white/10 bg-gradient-to-r from-emerald-900/20 via-emerald-800/10 to-transparent">
      <h3 class="text-xs sm:text-sm font-bold text-emerald-300 uppercase tracking-widest mb-2 flex items-center gap-2">
        <i data-lucide="brain-circuit" class="w-4 h-4"></i> AI Mentor Verdict
      </h3>
      <p class="text-base sm:text-lg lg:text-xl text-white/95 leading-relaxed font-normal">
        {{ plan.summary }}
      </p>
    </div>
    {% endif %}

    {% if path_type == 'startup' %}
      {# STARTUP MODE VIEW ‚Äî use structured fields from plan_view #}
      {% set sx = plan.startup_extras or {} %}
      {% set startup_summary = plan.startup_summary or {} %}
      {% set budget_and_stack = plan.budget_and_stack or {} %}
      {% set go_to_market = plan.go_to_market or {} %}
      {% set risks = plan.risks or {} %}

      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2 glass-card rounded-2xl p-6 border border-white/10">
          <h3 class="text-lg sm:text-xl font-semibold text-white mb-3 flex items-center gap-2">
            <i data-lucide="user" class="w-5 h-5 text-purple-400"></i> Your Founder Role Fit
          </h3>
          <p class="text-sm sm:text-base text-white/75 leading-relaxed">
            {{ startup_summary.founder_role or sx.founder_role_fit
               or "Analysis of how your current skills and background map to a realistic founder role for this idea." }}
          </p>
          {% if startup_summary.positioning or sx.positioning %}
            <div class="mt-4 p-3 rounded-lg bg-white/5 border border-white/10">
              <p class="text-[11px] text-white/50 uppercase tracking-wide mb-1">Product Positioning</p>
              <p class="text-sm sm:text-base text-white/85 italic">
                "{{ startup_summary.positioning or sx.positioning }}"
              </p>
            </div>
          {% endif %}
        </div>

        <div class="glass-card rounded-2xl p-6 border border-white/10">
          <h3 class="text-lg sm:text-xl font-semibold text-white mb-3 flex items-center gap-2">
            <i data-lucide="users" class="w-5 h-5 text-pink-400"></i> Team & Cofounder Gaps
          </h3>
          <p class="text-[11px] text-white/50 mb-3 uppercase tracking-wide">Roles to complement you:</p>
          {% set cofounders = startup_summary.cofounder_needs or sx.cofounder_gaps or [] %}
          <div class="flex flex-wrap gap-2">
            {% for role in cofounders %}
              <span class="px-2.5 py-1 rounded-md bg-pink-500/10 border border-pink-500/25 text-pink-200 text-xs font-medium">
                {{ role }}
              </span>
            {% else %}
              <span class="text-white/40 text-xs">No specific cofounder gaps listed. Add this later as you clarify your idea.</span>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-6">
        <div class="glass-card rounded-2xl p-6 border border-white/10 flex flex-col">
          <div class="mb-4">
            <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-300 mb-3">
              <i data-lucide="box" class="w-5 h-5"></i>
            </div>
            <h3 class="text-lg sm:text-xl font-bold text-white">Your MVP</h3>
            <p class="text-[11px] text-white/50 mt-1">First version you‚Äôll actually ship</p>
          </div>
          <p class="text-sm sm:text-base text-white/75 mb-4 flex-grow">
            {{ plan.mvp_outline or sx.mvp_outline
               or "Short outline of the MVP: core features, user journey, and what 'launched' means for you in this time horizon." }}
          </p>

          {% set mvp_steps = sx.mvp_steps or [] %}
          {% if mvp_steps %}
            <div class="space-y-2 mt-auto">
              <p class="text-[11px] text-white/55 uppercase tracking-wide">Key MVP steps</p>
              <ul class="list-disc list-inside text-white/70 text-sm space-y-1">
                {% for item in mvp_steps[:4] %}
                  <li>{{ item }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        </div>

        <div class="glass-card rounded-2xl p-6 border border-white/10 flex flex-col">
          <div class="mb-4">
            <div class="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center text-emerald-300 mb-3">
              <i data-lucide="megaphone" class="w-5 h-5"></i>
            </div>
            <h3 class="text-lg sm:text-xl font-bold text-white">Go-To-Market</h3>
            <p class="text-[11px] text-white/50 mt-1">How you‚Äôll get first users</p>
          </div>

          <div class="space-y-4 text-sm sm:text-base text-white/80 flex-grow">
            <div>
              <p class="text-[11px] text-white/55 uppercase tracking-wide mb-1">First 10 Customers</p>
              {% set first_customers = go_to_market.first_customers or sx.first_10_customers or [] %}
              <ul class="list-disc list-inside space-y-1">
                {% for c in first_customers %}
                  <li>{{ c }}</li>
                {% else %}
                  <li class="text-white/50 text-xs">Concrete ideas for your first 10 users will appear here.</li>
                {% endfor %}
              </ul>
            </div>
            <div>
              <p class="text-[11px] text-white/55 uppercase tracking-wide mb-1">Channels & Plays</p>
              {% set channels = go_to_market.channels or sx.go_to_market or [] %}
              <div class="flex flex-wrap gap-1.5">
                {% for ch in channels %}
                  <span class="px-2 py-0.5 rounded bg-emerald-500/10 border border-emerald-500/25 text-emerald-200 text-[10px]">
                    {{ ch }}
                  </span>
                {% else %}
                  <p class="text-xs text-white/50">Your channel strategy will show up here: communities, cold outreach, content, etc.</p>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <div class="glass-card rounded-2xl p-6 border border-white/10 flex flex-col">
          <div class="mb-4">
            <div class="w-10 h-10 rounded-lg bg-orange-500/20 flex items-center justify-center text-orange-300 mb-3">
              <i data-lucide="cpu" class="w-5 h-5"></i>
            </div>
            <h3 class="text-lg sm:text-xl font-bold text-white">Stack & Budget</h3>
            <p class="text-[11px] text-white/50 mt-1">Tools, costs & constraints</p>
          </div>

          <div class="space-y-4">
            <div>
              <p class="text-[11px] text-white/55 uppercase tracking-wide mb-1">Suggested stack</p>
              {% set stack = budget_and_stack.tech_stack or sx.stack or sx.tech_stack or [] %}
              <div class="flex flex-wrap gap-1.5">
                {% for t in stack %}
                  <span class="px-2 py-0.5 rounded bg-white/5 border border-white/15 text-white/85 text-[10px] font-mono">
                    {{ t }}
                  </span>
                {% else %}
                  <p class="text-xs text-white/50">Stack suggestions will appear here once the engine has more context.</p>
                {% endfor %}
              </div>
            </div>
            <div class="p-3 bg-orange-500/5 border border-orange-500/15 rounded-lg">
              <p class="text-[11px] text-orange-300/80 uppercase tracking-wide mb-1">Budget & Pricing Notes</p>
              <p class="text-sm sm:text-base text-orange-100">
                {{ budget_and_stack.budget_estimate or sx.budget_notes or sx.pricing_notes
                   or "High-level notes on budget range, tool costs, and how to think about early pricing experiments." }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="glass-card rounded-2xl p-6 border border-white/10 bg-red-900/5">
        <h3 class="text-lg sm:text-xl font-semibold text-white mb-4 flex items-center gap-2">
          <i data-lucide="shield-alert" class="w-5 h-5 text-red-400"></i> Risk & Reality Check
        </h3>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <span class="text-[11px] font-bold text-red-400 uppercase tracking-wide block mb-2">Key Risks</span>
            <ul class="space-y-2">
              {% set risk_items = risks.items or sx.risk_analysis or sx.key_risks or [] %}
              {% for risk in risk_items %}
                <li class="flex items-start gap-2 text-sm sm:text-base text-white/75">
                  <i data-lucide="x-circle" class="w-4 h-4 text-red-500/60 mt-0.5 shrink-0"></i>
                  {{ risk }}
                </li>
              {% else %}
                <li class="text-xs text-white/50">Risk analysis will appear here ‚Äî market, product, team and execution risks.</li>
              {% endfor %}
            </ul>
          </div>
          <div>
            <span class="text-[11px] font-bold text-emerald-400 uppercase tracking-wide block mb-2">Mitigation / Focus</span>
            <ul class="space-y-2">
              {% set mitigations = sx.mitigations or sx.mitigation_ideas or [] %}
              {% for mit in mitigations %}
                <li class="flex items-start gap-2 text-sm sm:text-base text-white/75">
                  <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500/70 mt-0.5 shrink-0"></i>
                  {{ mit }}
                </li>
              {% else %}
                <li class="text-xs text-white/50">
                  Concrete suggestions for how to reduce risk (scope, budget, experiments) will be listed here.
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>

    {% else %}

      {# JOB MODE VIEW - OLD PROBABILITY SECTION REMOVED #}

      {% set probs = plan.probabilities or {} %}

      <div class="lg:col-span-3 glass-card rounded-2xl p-6 border border-white/10">
          <h3 class="text-sm sm:text-base font-semibold text-white/70 uppercase tracking-wider mb-4 flex items-center gap-2">
            <i data-lucide="alert-triangle" class="w-4 h-4 text-orange-400"></i> Critical Skill Gaps
          </h3>
          <div class="flex flex-wrap gap-2">
            {% for skill in plan.missing_skills or [] %}
              <span class="px-3 py-1.5 rounded-lg bg-orange-500/10 border border-orange-500/25 text-orange-200 text-sm font-medium">
                {{ skill }}
              </span>
            {% else %}
              <span class="text-white/55 text-sm">No major gaps detected (or profile incomplete). Fill your Profile Portal for sharper signals.</span>
            {% endfor %}
          </div>
          <p class="text-xs sm:text-sm text-white/65 mt-4">
            Closing these gaps is the fastest way to:
            <span class="font-semibold">move from 12 ‚Üí 24 LPA</span>, and make 48 LPA at least possible over a longer horizon.
          </p>
        </div>
      </div>

      {% set phases = plan.phases or [] %}

      <div class="space-y-6">
        <div class="flex flex-col sm:flex-row sm:items-baseline sm:justify-between gap-2">
          <h3 class="text-xl sm:text-2xl font-bold text-white flex items-center gap-2">
            <i data-lucide="map" class="w-6 h-6 text-blue-400"></i>
            <span>Your {{ horizon_label }} Execution Plan</span>
          </h3>
          <p class="text-xs text-white/60">
            Split into <span class="font-semibold">3 clear phases</span> so you always know what each phase is about.
          </p>
        </div>

        <div class="grid md:grid-cols-3 gap-6">
          {% for phase in phases[:3] %}
            {% set phase_index = loop.index %}
            {% set has_items = 'items' in phase %}
            {% set phase_items = phase['items'] if has_items else [] %}
            <div class="glass-card rounded-2xl p-6 border border-white/10 relative overflow-hidden group">
              {% if loop.index == 1 %}
                <div class="absolute top-0 left-0 w-full h-1 bg-blue-500"></div>
              {% elif loop.index == 2 %}
                <div class="absolute top-0 left-0 w-full h-1 bg-purple-500"></div>
              {% else %}
                <div class="absolute top-0 left-0 w-full h-1 bg-emerald-500"></div>
              {% endif %}
              <h4 class="text-lg sm:text-xl font-bold text-white mb-1">{{ phase.label }}</h4>
              <p class="text-[11px]
                        {% if loop.index == 1 %}text-blue-300
                        {% elif loop.index == 2 %}text-purple-300
                        {% else %}text-emerald-300{% endif %}
                        font-medium uppercase tracking-wide mb-4">
                {% if loop.index == 1 %}
                  Foundation & Gaps
                {% elif loop.index == 2 %}
                  Projects & Depth
                {% else %}
                  Showcase & Apply
                {% endif %}
              </p>
              <ul class="space-y-3">
                {% for item in phase_items %}
                  <li class="flex items-start gap-3 text-sm sm:text-base text-white/85">
                    <div class="w-5 h-5 rounded-full
                               {% if phase_index == 1 %}bg-blue-500/20 text-blue-300
                               {% elif phase_index == 2 %}bg-purple-500/20 text-purple-300
                               {% else %}bg-emerald-500/20 text-emerald-300{% endif %}
                               flex items-center justify-center shrink-0 text-xs font-bold">
                      {{ loop.index }}
                    </div>
                    <span>{{ item }}</span>
                  </li>
                {% else %}
                  <li class="text-xs text-white/55">
                    Focus items for this phase will appear here once the engine has full context.
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% else %}
            <div class="md:col-span-3 text-xs text-white/60">
              Phase details were not available. Try regenerating the plan if this keeps showing up.
            </div>
          {% endfor %}
        </div>
      </div>

      {% set resources = plan.resources or {} %}
      {% set mini_projects = plan.mini_projects or resources.mini_projects or [] %}
      {% set tutorials = plan.tutorials or resources.tutorials or [] %}
      {% set resume_bullets = plan.resume_bullets or resources.resume_bullets or [] %}
      {% set linkedin_actions = plan.linkedin_actions or resources.linkedin_actions or [] %}
      {% set max_projects = plan.max_projects or 1 %}

      <div class="grid md:grid-cols-2 gap-6">
        <div class="glass-card rounded-2xl p-6 border border-white/10">
          <h3 class="text-lg sm:text-xl font-semibold text-white mb-4 flex items-center gap-2">
            <i data-lucide="code" class="w-5 h-5 text-indigo-400"></i> Mini Projects to Ship
          </h3>

          {% if mini_projects %}
            {% if is_pro_user and snapshot_id %}
              <p class="text-[11px] text-white/65 mb-3">
                Based on your <span class="font-semibold">{{ '28-day' if is_sprint else timeline_months ~ '-month' }}</span> plan,
                you should focus on
                <span class="font-semibold">{{ max_projects }}</span>
                mini project{{ 's' if max_projects > 1 else '' }}.
                Pick the ones you want <span class="font-semibold">Weekly Coach</span> to drive.
              </p>

              <form
                method="post"
                action="{{ url_for('dream.select_projects') }}"
                class="space-y-3"
              >
                <input type="hidden" name="path_type" value="{{ path_type }}">
                <input type="hidden" name="snapshot_id" value="{{ snapshot_id }}">

                <div class="space-y-2">
                  {% for project in mini_projects %}
                    <label class="flex items-start gap-3 p-3 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 hover:border-emerald-400/50 cursor-pointer transition-colors">
                      <input
                        type="checkbox"
                        name="selected_projects"
                        value="{{ loop.index0 }}"
                        class="mt-1 w-4 h-4 rounded border-white/40 bg-black/40 checked:bg-emerald-500"
                      >
                      <div class="flex-1 flex items-start gap-2">
                        <i data-lucide="git-branch" class="w-4 h-4 text-indigo-300 mt-0.5"></i>
                        <span class="text-sm sm:text-base text-white/85">{{ project }}</span>
                      </div>
                    </label>
                  {% endfor %}
                </div>

                <button
                  type="submit"
                  class="mt-3 inline-flex items-center justify-center px-4 py-2.5 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-xs sm:text-sm font-semibold text-white shadow-md shadow-emerald-500/30 transition-all"
                >
                  <i data-lucide="check-circle" class="w-4 h-4 mr-2"></i>
                  Save {{ max_projects }} selected project{{ 's' if max_projects > 1 else '' }} & go to Weekly Coach
                </button>
                <p class="text-[10px] text-white/55 mt-1">
                  Weekly Coach will prioritize tasks that move these selected projects forward, week by week.
                </p>
              </form>
            {% else %}
              <p class="text-xs text-white/60 mb-2">
                Finish these and you unlock concrete bullets to paste into your resume & LinkedIn.
              </p>
              <div class="space-y-3">
                {% for project in mini_projects %}
                  <div class="flex items-start gap-3 p-3 rounded-lg bg-white/5 hover:bg-white/10 transition-colors">
                    <i data-lucide="git-branch" class="w-4 h-4 text-indigo-300 mt-1"></i>
                    <span class="text-sm sm:text-base text-white/85">{{ project }}</span>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          {% else %}
            <p class="text-xs text-white/55">Mini projects will appear here. Use them as your main proof of skill.</p>
          {% endif %}
        </div>

        <div class="glass-card rounded-2xl p-6 border border-white/10">
          <h3 class="text-lg sm:text-xl font-semibold text-white mb-4 flex items-center gap-2">
            <i data-lucide="play-circle" class="w-5 h-5 text-red-400"></i> Recommended Learning
          </h3>
          <p class="text-xs text-white/60 mb-2">
            Short, targeted resources. Don‚Äôt hoard courses ‚Äî finish what‚Äôs here and move on.
          </p>
          <div class="space-y-2">
            {% for tutorial in tutorials %}
              {% if tutorial.label is defined %}
                <a
                  {% if tutorial.url %}href="{{ tutorial.url }}"{% endif %}
                  class="block p-3 rounded-lg border border-white/5 hover:border-white/20 hover:bg-white/5 transition-all"
                  {% if tutorial.url %}target="_blank" rel="noopener noreferrer"{% endif %}
                >
                  <div class="flex items-center justify-between gap-3">
                    <span class="text-sm sm:text-base text-white/85 leading-snug">{{ tutorial.label }}</span>
                    <i data-lucide="external-link" class="w-3 h-3 text-white/30"></i>
                  </div>
                </a>
              {% else %}
                <div class="block p-3 rounded-lg border border-white/5 hover:border-white/20 hover:bg-white/5 transition-all">
                  <div class="flex items-center justify-between gap-3">
                    <span class="text-sm sm:text-base text-white/85 leading-snug">{{ tutorial }}</span>
                    <i data-lucide="external-link" class="w-3 h-3 text-white/30"></i>
                  </div>
                </div>
              {% endif %}
            {% else %}
              <p class="text-xs text-white/55">Tutorial suggestions will appear here. The idea is: lean, focused content, not a 30-course playlist.</p>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <div class="glass-card rounded-2xl p-5 border border-white/10">
          <h4 class="text-xs sm:text-sm font-bold text-white/65 uppercase tracking-wide mb-2 flex items-center gap-1.5">
            <i data-lucide="file-text" class="w-4 h-4 text-emerald-300"></i>
            <span>Resume bullets to add after you execute</span>
          </h4>
          <p class="text-[11px] text-white/55 mb-2">
            Once you‚Äôve actually done the work, you can plug these bullets into your resume & LinkedIn ‚Äî no full rewrite needed.
          </p>
          <ul class="space-y-1.5">
            {% for bullet in resume_bullets %}
              <li class="text-xs sm:text-sm text-white/80 flex gap-2">
                <span class="text-emerald-400 mt-[2px]">‚Ä¢</span> {{ bullet }}
              </li>
            {% else %}
              <li class="text-xs text-white/55">Resume-ready bullets will appear here, connected to the projects and skills in this plan.</li>
            {% endfor %}
          </ul>
        </div>
        <div class="glass-card rounded-2xl p-5 border border-white/10">
          <h4 class="text-xs sm:text-sm font-bold text-white/65 uppercase tracking-wide mb-2 flex items-center gap-1.5">
            <i data-lucide="linkedin" class="w-4 h-4 text-sky-300"></i>
            <span>LinkedIn & Outreach Strategy</span>
          </h4>
          <p class="text-[11px] text-white/55 mb-2">
            Use these as small, weekly moves ‚Äî comments, connections, and DMs that match the work you‚Äôre actually doing.
          </p>
          <ul class="space-y-1.5">
            {% for action in linkedin_actions %}
              <li class="text-xs sm:text-sm text-white/80 flex gap-2">
                <span class="text-sky-300 mt-[2px]">‚Ä¢</span> {{ action }}
              </li>
            {% else %}
              <li class="text-xs text-white/55">Once the engine has enough context, you‚Äôll see 6‚Äì10 concrete LinkedIn actions here.</li>
            {% endfor %}
          </ul>
        </div>
      </div>

    {% endif %}

  {% endif %}
</section>
{% endblock %}