{# templates/admin/credits.html #}
{% extends "admin/_layout.html" %}

{% block title %}Admin Â· Credits Â· CareerAI{% endblock %}
{% set active_tab = 'credits' %}

{% block admin_body %}
<div>

  <h1 class="text-xl sm:text-2xl font-semibold tracking-tight mb-4">
    Admin Â· Credits
  </h1>

  <!-- Access rules -->
  {% set viewing_self = (target and current_user.id == target.id) %}
  {% set is_global_admin = current_user.is_super_admin or current_user.is_ultra_admin %}
  {% set cannot_edit = false %}

  {% if target %}
    {% if target.role == 'ultra_admin' and not current_user.is_ultra_admin %}
      {% set cannot_edit = true %}
    {% endif %}

    {% if not is_global_admin and target.university_id != current_user.university_id %}
      {% set cannot_edit = true %}
    {% endif %}
  {% endif %}

  <!-- Credit adjustment form -->
  <div class="glass-card px-4 py-4 mb-6 rounded-2xl text-[13px]">

    {% if cannot_edit %}
      <p class="text-[12px] text-amber-300/90 mb-3">
        You do not have permission to adjust credits for this user.
      </p>
    {% endif %}

    <form method="post" class="space-y-3" {% if cannot_edit %}onsubmit="return false"{% endif %}>
      
      <div class="grid gap-3 sm:grid-cols-3">
        <div class="sm:col-span-2">
          <label class="block text-xs font-semibold mb-1 text-slate-200/90">
            User email
          </label>
          <input
            type="email"
            name="email"
            value="{{ request.args.get('email','') }}"
            required
            {% if cannot_edit %}disabled class="opacity-40 bg-slate-950/50"{% endif %}
            class="w-full rounded-lg border border-slate-600/70 bg-slate-950/80 px-3 py-2 text-sm"
          />
        </div>

        <div>
          <label class="block text-xs font-semibold mb-1 text-slate-200/90">
            Amount
          </label>
          <input
            type="number"
            name="amount"
            min="1"
            required
            {% if cannot_edit %}disabled class="opacity-40 bg-slate-950/50"{% endif %}
            class="w-full rounded-lg border border-slate-600/70 bg-slate-950/80 px-3 py-2 text-sm"
          />
        </div>
      </div>

      <div class="grid gap-3 sm:grid-cols-3">
        <div>
          <label class="block text-xs font-semibold mb-1 text-slate-200/90">Currency</label>
          <select
            name="currency"
            {% if cannot_edit %}disabled class="opacity-40 bg-slate-950/50"{% endif %}
            class="w-full rounded-lg border border-slate-600/70 bg-slate-950/80 px-3 py-2 text-sm"
          >
            <option value="silver">Silver ğŸª™</option>
            <option value="gold">Gold â­</option>
          </select>
        </div>

        <div class="sm:col-span-2">
          <label class="block text-xs font-semibold mb-1 text-slate-200/90">
            Reason / feature tag
          </label>
          <input
            type="text"
            name="reason"
            placeholder="admin_adjust, promo, bug_refund..."
            {% if cannot_edit %}disabled class="opacity-40 bg-slate-950/50"{% endif %}
            class="w-full rounded-lg border border-slate-600/70 bg-slate-950/80 px-3 py-2 text-sm"
          />
        </div>
      </div>

      <div class="pt-2 flex items-center gap-3">
        {% if cannot_edit %}
          <button type="button" disabled
            class="btn-secondary opacity-40 cursor-not-allowed text-xs px-4 py-1.5">
            Restricted
          </button>
        {% else %}
          <button type="submit" class="btn-primary text-xs px-4 py-1.5">
            Add credits
          </button>
        {% endif %}
        <p class="text-[11px] text-slate-300/80">
          Every change creates a <code>credit_transaction</code> with before/after snapshots.
        </p>
      </div>

    </form>
  </div>

  {% if target %}
  <!-- User snapshot -->
  <div class="mb-3">
    <h2 class="text-sm font-semibold mb-1">User snapshot</h2>
    <div class="glass-card px-4 py-3 rounded-2xl text-[12px] flex flex-wrap gap-4">

      <div>
        <div class="font-semibold text-slate-100">{{ target.email }}</div>
        <div class="text-slate-300/80">{{ target.name or "No name" }}</div>
      </div>

      <div class="h-10 w-px bg-slate-600/40 hidden sm:block"></div>

      <div>
        <div class="uppercase text-[10px] tracking-widest text-slate-300/70">
          Balances
        </div>
        <div class="flex items-center gap-3 mt-0.5">
          <span>ğŸª™ <strong>{{ target.coins_free or 0 }}</strong> Silver</span>
          <span class="text-slate-400/60">Â·</span>
          <span>â­ <strong>{{ target.coins_pro or 0 }}</strong> Gold</span>
        </div>
      </div>

      <div class="h-10 w-px bg-slate-600/40 hidden sm:block"></div>

      <div>
        <div class="uppercase text-[10px] tracking-widest text-slate-300/70">
          Plan
        </div>
        <div class="mt-0.5 text-[11px]">
          {{ (target.subscription_status or "free") | capitalize }}
        </div>
      </div>

    </div>
  </div>

  <!-- Recent transactions -->
  <div>
    <h2 class="text-sm font-semibold mb-2">Recent credit transactions</h2>

    {% if recent_txs %}
    <div class="glass-card rounded-2xl overflow-hidden text-[11px]">
      <table class="min-w-full">
        <thead class="bg-slate-900/80 text-slate-200/80">
          <tr>
            <th class="px-3 py-2 text-left">When</th>
            <th class="px-3 py-2 text-left">Feature / Reason</th>
            <th class="px-3 py-2 text-left">Type</th>
            <th class="px-3 py-2 text-right">Amount</th>
            <th class="px-3 py-2 text-right">Before â†’ After</th>
          </tr>
        </thead>
        <tbody>
          {% for tx in recent_txs %}
          <tr class="border-t border-slate-700/60">
            <td class="px-3 py-2 text-slate-200/70">
              {{ tx.created_at.strftime('%Y-%m-%d %H:%M') if tx.created_at else '' }}
            </td>
            <td class="px-3 py-2">
              <div class="text-slate-100">{{ tx.feature }}</div>
              {% if tx.run_id %}
              <div class="text-[10px] text-slate-400/70">
                run_id: {{ tx.run_id }}
              </div>
              {% endif %}
            </td>
            <td class="px-3 py-2 text-slate-200/70">
              {{ tx.tx_type|capitalize }} ({{ tx.currency }})
            </td>
            <td class="px-3 py-2 text-right">
              {% if tx.tx_type == 'debit' %}
                -{{ tx.amount }}
              {% else %}
                +{{ tx.amount }}
              {% endif %}
            </td>
            <td class="px-3 py-2 text-right text-slate-300/80">
              {{ tx.before_balance }} â†’ <strong>{{ tx.after_balance }}</strong>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <p class="text-[11px] text-slate-400/80">
        No recent transactions for this user.
      </p>
    {% endif %}
  </div>
  {% endif %}

</div>
{% endblock %}
