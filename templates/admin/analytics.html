{# templates/admin/analytics.html #}
{% extends "admin/_layout.html" %}

{% block title %}Admin · Analytics · CareerAI{% endblock %}
{% set active_tab = 'analytics' %}

{% block admin_body %}
<div>

  {# -------------------------------------------------------------- #}
  {# Safe defaults (avoid undefined crashes)                         #}
  {# -------------------------------------------------------------- #}
  {% set tenant = tenant|default(None) %}
  {% set q = q|default('') %}
  {% set start = start|default('') %}
  {% set end = end|default('') %}
  {% set min_ready = (min_ready if min_ready is not none else 0) %}
  {% set max_ready = (max_ready if max_ready is not none else 100) %}
  {% set only_verified = only_verified|default(false) %}
  {% set only_pro = only_pro|default(false) %}

  {% set total_users = total_users|default(0) %}
  {% set total_students = total_students|default(0) %}
  {% set total_university_admins = total_university_admins|default(0) %}

  {% set readiness_chart = readiness_chart|default({}) %}
  {% set streak_chart = streak_chart|default({}) %}
  {% set engagement_summary = engagement_summary|default({}) %}

  {% set problems_summary = problems_summary|default([]) %}
  {% set tool_usage_runs = tool_usage_runs|default([]) %}

  {% set resume_samples = resume_samples|default({}) %}
  {% set resume_missing_skills_top = resume_missing_skills_top|default([]) %}
  {% set roadmap_missing_skills_top = roadmap_missing_skills_top|default([]) %}
  {% set resume_blockers_top = resume_blockers_top|default([]) %}
  {% set resume_warnings_top = resume_warnings_top|default([]) %}

  {% set skills_top = skills_top|default([]) %}
  {% set roles_top = roles_top|default([]) %}
  {% set internship_roles = internship_roles|default([]) %}
  {% set student_rows = student_rows|default([]) %}

  {# Role flag compatibility (in case some templates still use older names) #}
  {% set is_university_admin = is_university_admin|default(is_uni_admin|default(false)) %}
  {% set is_global_admin = is_global_admin|default(is_global|default(false)) %}
  {% set is_super_admin = is_super_admin|default(is_super|default(false)) %}
  {% set is_ultra_admin = is_ultra_admin|default(is_ultra|default(false)) %}

  <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
    <div>
      <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">
        University Analytics · {{ (tenant.name if tenant else "Unknown University") }}
      </h1>
      <div class="text-[11px] text-slate-400/80 mt-1">
        Dean view: placement blockers, missing skills, readiness, proof-of-work, and adoption.
      </div>
    </div>

    <div class="flex items-center gap-2">
      {# If your export route is uni-admin only, this is fine; if global-only, wrap with is_global_admin #}
      {% set _qs = '' %}
      {% if request is defined and request.query_string is defined and request.query_string %}
        {% set _qs = request.query_string.decode('utf-8') %}
      {% endif %}
      <a href="{{ url_for('admin.analytics_export') }}{% if _qs %}?{{ _qs }}{% endif %}"
         class="btn-ghost text-[11px] px-3 py-1.5">
        Download CSV
      </a>
    </div>
  </div>

  {# -------------------------------------------------------------- #}
  {# Filters                                                        #}
  {# -------------------------------------------------------------- #}
  <div class="glass-card rounded-2xl px-4 py-4 mb-5 text-[12px]">
    <div class="flex items-center justify-between gap-3 mb-3">
      <h2 class="text-sm font-semibold">Filters</h2>
      <div class="text-[11px] text-slate-400/80">
        Narrow by cohort slice (ready score, activity window, verification, pro).
      </div>
    </div>

    <form method="get" action="{{ url_for('admin.analytics') }}" class="grid gap-3 md:grid-cols-12">
      <div class="md:col-span-4">
        <label class="block text-[11px] text-slate-400/80 mb-1">Search (name/email)</label>
        <input
          type="text"
          name="q"
          value="{{ q or '' }}"
          placeholder="e.g. arjun@uni.edu"
          class="w-full rounded-xl bg-slate-900/60 border border-slate-700/60 px-3 py-2 text-[12px] outline-none"
        />
      </div>

      <div class="md:col-span-2">
        <label class="block text-[11px] text-slate-400/80 mb-1">Start date</label>
        <input
          type="date"
          name="start"
          value="{{ start or '' }}"
          class="w-full rounded-xl bg-slate-900/60 border border-slate-700/60 px-3 py-2 text-[12px] outline-none"
        />
      </div>

      <div class="md:col-span-2">
        <label class="block text-[11px] text-slate-400/80 mb-1">End date</label>
        <input
          type="date"
          name="end"
          value="{{ end or '' }}"
          class="w-full rounded-xl bg-slate-900/60 border border-slate-700/60 px-3 py-2 text-[12px] outline-none"
        />
      </div>

      <div class="md:col-span-2">
        <label class="block text-[11px] text-slate-400/80 mb-1">Min ready</label>
        <input
          type="number"
          name="min_ready"
          min="0" max="100"
          value="{{ min_ready }}"
          class="w-full rounded-xl bg-slate-900/60 border border-slate-700/60 px-3 py-2 text-[12px] outline-none"
        />
      </div>

      <div class="md:col-span-2">
        <label class="block text-[11px] text-slate-400/80 mb-1">Max ready</label>
        <input
          type="number"
          name="max_ready"
          min="0" max="100"
          value="{{ max_ready }}"
          class="w-full rounded-xl bg-slate-900/60 border border-slate-700/60 px-3 py-2 text-[12px] outline-none"
        />
      </div>

      <div class="md:col-span-3 flex items-center gap-4 mt-1">
        <label class="inline-flex items-center gap-2 text-[12px] text-slate-200/90">
          <input type="checkbox" name="verified" value="1" {% if only_verified %}checked{% endif %}
                 class="rounded border-slate-700/60 bg-slate-900/60">
          Verified only
        </label>

        <label class="inline-flex items-center gap-2 text-[12px] text-slate-200/90">
          <input type="checkbox" name="pro" value="1" {% if only_pro %}checked{% endif %}
                 class="rounded border-slate-700/60 bg-slate-900/60">
          Pro only
        </label>
      </div>

      <div class="md:col-span-9 flex items-center justify-end gap-2 mt-1">
        <a href="{{ url_for('admin.analytics') }}" class="btn-ghost text-[11px] px-3 py-2">
          Reset
        </a>
        <button type="submit" class="btn-primary text-[11px] px-4 py-2">
          Apply filters
        </button>
      </div>
    </form>

    <div class="mt-3 text-[11px] text-slate-400/80">
      Tip: Use <span class="font-mono">Min ready = 60</span> to focus on job-ready students. Use date range to check last-week engagement.
    </div>
  </div>

  {# -------------------------------------------------------------- #}
  {# Insight summary                                                 #}
  {# -------------------------------------------------------------- #}
  {% set _ins = analytics_insights|default({}) %}
  {% if _ins and (_ins|length > 0) %}
  <div class="glass-card rounded-2xl px-4 py-4 mb-5 text-[12px]">
    <h2 class="text-sm font-semibold mb-1">Quick insights</h2>
    <p class="text-[11px] text-slate-300/80 mb-3">
      A quick summary of student progress + what’s blocking placements.
    </p>

    <div class="space-y-1.5 text-[12px]">
      {% if _ins.headline %}<div class="text-slate-100/90">{{ _ins.headline }}</div>{% endif %}
      {% if _ins.readiness_summary %}<div class="text-slate-300/90">• {{ _ins.readiness_summary }}</div>{% endif %}
      {% if _ins.consistency_summary %}<div class="text-slate-300/90">• {{ _ins.consistency_summary }}</div>{% endif %}
      {% if _ins.proof_summary %}<div class="text-slate-300/90">• {{ _ins.proof_summary }}</div>{% endif %}
      {% if _ins.skill_summary %}<div class="text-slate-300/90">• {{ _ins.skill_summary }}</div>{% endif %}
      {% if _ins.tool_summary %}<div class="text-slate-300/90">• {{ _ins.tool_summary }}</div>{% endif %}
    </div>
  </div>
  {% endif %}

  {# -------------------------------------------------------------- #}
  {# Top Stats                                                       #}
  {# -------------------------------------------------------------- #}
  <div class="grid gap-4 md:grid-cols-3 mb-6 text-[13px]">
    <div class="glass-card rounded-2xl px-4 py-3">
      <div class="text-[11px] uppercase tracking-[0.16em] text-slate-400/80 mb-1">Total users</div>
      <div class="text-2xl font-semibold text-white">{{ total_users }}</div>
      <p class="mt-1 text-[11px] text-slate-400/80">All accounts linked to this university.</p>
    </div>

    <div class="glass-card rounded-2xl px-4 py-3">
      <div class="text-[11px] uppercase tracking-[0.16em] text-slate-400/80 mb-1">Students</div>
      <div class="text-2xl font-semibold text-white">{{ total_students }}</div>
      <p class="mt-1 text-[11px] text-slate-400/80">Filtered slice (role = <span class="font-mono">student</span>).</p>
    </div>

    <div class="glass-card rounded-2xl px-4 py-3">
      <div class="text-[11px] uppercase tracking-[0.16em] text-slate-400/80 mb-1">University admins</div>
      <div class="text-2xl font-semibold text-white">{{ total_university_admins }}</div>
      <p class="mt-1 text-[11px] text-slate-400/80">Admin accounts for this university.</p>
    </div>
  </div>

  {# -------------------------------------------------------------- #}
  {# Readiness + Consistency snapshot                                #}
  {# -------------------------------------------------------------- #}
  <div class="grid gap-4 md:grid-cols-4 mb-6 text-[13px]">
    <div class="glass-card rounded-2xl px-4 py-3">
      <div class="text-[11px] uppercase tracking-[0.16em] text-slate-400/80 mb-1">Avg readiness</div>
      <div class="text-2xl font-semibold text-white">{{ readiness_chart.avg|default(0, true) }}</div>
      <p class="mt-1 text-[11px] text-slate-400/80">Mean ready score (0–100) for filtered students.</p>
    </div>

    <div class="glass-card rounded-2xl px-4 py-3">
      <div class="text-[11px] uppercase tracking-[0.16em] text-slate-400/80 mb-1">Median readiness</div>
      <div class="text-2xl font-semibold text-white">{{ readiness_chart.median|default(0, true) }}</div>
      <p class="mt-1 text-[11px] text-slate-400/80">Midpoint score; better than average for skew.</p>
    </div>

    <div class="glass-card rounded-2xl px-4 py-3">
      <div class="text-[11px] uppercase tracking-[0.16em] text-slate-400/80 mb-1">Avg current streak</div>
      <div class="text-2xl font-semibold text-white">{{ streak_chart.avg_current|default(0, true) }}</div>
      <p class="mt-1 text-[11px] text-slate-400/80">Consistency indicator (daily habit).</p>
    </div>

    <div class="glass-card rounded-2xl px-4 py-3">
      <div class="text-[11px] uppercase tracking-[0.16em] text-slate-400/80 mb-1">DevLogs</div>
      <div class="text-2xl font-semibold text-white">{{ engagement_summary.learning_logs|default(0, true) }}</div>
      <p class="mt-1 text-[11px] text-slate-400/80">DevLogs submitted in selected time window.</p>
    </div>
  </div>

  {# -------------------------------------------------------------- #}
  {# Placement blockers + adoption charts                             #}
  {# -------------------------------------------------------------- #}
  <div class="grid gap-5 md:grid-cols-2 mb-6 text-[13px]">

    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-2">Placement blockers (what to fix first)</h2>
      <p class="text-[11px] text-slate-400/80 mb-2">
        Counts are for the filtered student slice (not credit-based).
      </p>
      <div style="height:260px;">
        <canvas id="chartProblemsSummary"></canvas>
      </div>

      {% if problems_summary and problems_summary|length > 0 %}
        <div class="mt-3 grid gap-2 sm:grid-cols-2 text-[11px]">
          {% for p in problems_summary %}
            <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-2 flex items-center justify-between">
              <span class="text-slate-300/80">{{ p.label }}</span>
              <span class="font-semibold text-slate-100/90">{{ p.count }}</span>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-2">Tool adoption (runs)</h2>
      <p class="text-[11px] text-slate-400/80 mb-2">
        Adoption by tool. This is runs, not credits.
      </p>
      <div style="height:260px;">
        <canvas id="chartToolUsageRuns"></canvas>
      </div>
    </div>

  </div>

  {# -------------------------------------------------------------- #}
  {# Missing skills: Resume vs Learning gaps                          #}
  {# -------------------------------------------------------------- #}
  <div class="grid gap-5 md:grid-cols-2 mb-6 text-[13px]">
    <div class="glass-card rounded-2xl px-4 py-4">
      <div class="flex items-center justify-between gap-3 mb-2">
        <h2 class="text-sm font-semibold">Most missed resume skills (Job Pack)</h2>
        <div class="text-[11px] text-slate-400/80">
          Sample: {{ resume_samples.students_with_jobpack|default(0, true) }} students with Job Pack
        </div>
      </div>
      <p class="text-[11px] text-slate-400/80 mb-2">
        These are missing keywords the ATS expects (strong placement signal).
      </p>
      <div style="height:280px;">
        <canvas id="chartResumeMissingSkills"></canvas>
      </div>

      {% if resume_missing_skills_top and resume_missing_skills_top|length > 0 %}
        <div class="mt-3 overflow-x-auto -mx-2 text-[11px]">
          <table class="min-w-full">
            <thead class="bg-slate-900/80 text-slate-200/80">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">Skill</th>
                <th class="px-3 py-2 text-right font-semibold">Students</th>
                <th class="px-3 py-2 text-right font-semibold">%</th>
              </tr>
            </thead>
            <tbody>
              {% for r in resume_missing_skills_top %}
              <tr class="border-t border-slate-700/60">
                <td class="px-3 py-2 text-slate-100/90">{{ r.name }}</td>
                <td class="px-3 py-2 text-right text-slate-200/90">{{ r.students }}</td>
                <td class="px-3 py-2 text-right text-slate-200/80">{{ r.percent }}%</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>

    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-2">Common learning gaps (Skill Mapper)</h2>
      <p class="text-[11px] text-slate-400/80 mb-2">
        Skills students frequently still need to learn (from their role roadmaps).
      </p>
      <div style="height:280px;">
        <canvas id="chartRoadmapMissingSkills"></canvas>
      </div>

      {% if roadmap_missing_skills_top and roadmap_missing_skills_top|length > 0 %}
        <div class="mt-3 overflow-x-auto -mx-2 text-[11px]">
          <table class="min-w-full">
            <thead class="bg-slate-900/80 text-slate-200/80">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">Skill</th>
                <th class="px-3 py-2 text-right font-semibold">Students</th>
                <th class="px-3 py-2 text-right font-semibold">%</th>
              </tr>
            </thead>
            <tbody>
              {% for r in roadmap_missing_skills_top %}
              <tr class="border-t border-slate-700/60">
                <td class="px-3 py-2 text-slate-100/90">{{ r.name }}</td>
                <td class="px-3 py-2 text-right text-slate-200/90">{{ r.students }}</td>
                <td class="px-3 py-2 text-right text-slate-200/80">{{ r.percent }}%</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>

  {# -------------------------------------------------------------- #}
  {# Resume quality signals                                           #}
  {# -------------------------------------------------------------- #}
  <div class="grid gap-5 md:grid-cols-2 mb-6 text-[13px]">
    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-2">Top resume blockers</h2>
      <p class="text-[11px] text-slate-400/80 mb-2">
        Hard ATS problems (highest priority fixes).
      </p>
      <div style="height:260px;">
        <canvas id="chartResumeBlockers"></canvas>
      </div>
    </div>

    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-2">Top resume warnings</h2>
      <p class="text-[11px] text-slate-400/80 mb-2">
        Softer issues that reduce interview conversion.
      </p>
      <div style="height:260px;">
        <canvas id="chartResumeWarnings"></canvas>
      </div>
    </div>
  </div>

  {# -------------------------------------------------------------- #}
  {# Engagement KPIs                                                 #}
  {# -------------------------------------------------------------- #}
  <div class="glass-card rounded-2xl px-4 py-4 mb-6 text-[13px]">
    <div class="flex items-center justify-between gap-3 mb-2">
      <h2 class="text-sm font-semibold">Engagement KPIs</h2>
      <div class="text-[11px] text-slate-400/80">
        Counts reflect your selected date range (or all time if no dates).
      </div>
    </div>

    <div class="grid gap-3 sm:grid-cols-2 md:grid-cols-4">
      <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-3">
        <div class="text-[11px] text-slate-400/80 uppercase tracking-[0.14em]">Skill Mapper runs</div>
        <div class="text-xl font-semibold mt-1">{{ engagement_summary.skillmapper_runs|default(0, true) }}</div>
      </div>
      <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-3">
        <div class="text-[11px] text-slate-400/80 uppercase tracking-[0.14em]">Job Pack runs</div>
        <div class="text-xl font-semibold mt-1">{{ engagement_summary.jobpack_runs|default(0, true) }}</div>
      </div>
      <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-3">
        <div class="text-[11px] text-slate-400/80 uppercase tracking-[0.14em]">Internship runs</div>
        <div class="text-xl font-semibold mt-1">{{ engagement_summary.internship_runs|default(0, true) }}</div>
      </div>
      <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-3">
        <div class="text-[11px] text-slate-400/80 uppercase tracking-[0.14em]">Projects created</div>
        <div class="text-xl font-semibold mt-1">{{ engagement_summary.projects|default(0, true) }}</div>
      </div>

      <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-3">
        <div class="text-[11px] text-slate-400/80 uppercase tracking-[0.14em]">Portfolio pages</div>
        <div class="text-xl font-semibold mt-1">{{ engagement_summary.portfolio_pages|default(0, true) }}</div>
      </div>
      <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-3">
        <div class="text-[11px] text-slate-400/80 uppercase tracking-[0.14em]">Public portfolios</div>
        <div class="text-xl font-semibold mt-1">{{ engagement_summary.public_portfolios|default(0, true) }}</div>
      </div>
      <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-3">
        <div class="text-[11px] text-slate-400/80 uppercase tracking-[0.14em]">Weekly milestones total</div>
        <div class="text-xl font-semibold mt-1">{{ engagement_summary.weekly_milestones_total|default(0, true) }}</div>
      </div>
      <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-3">
        <div class="text-[11px] text-slate-400/80 uppercase tracking-[0.14em]">Weekly milestones avg</div>
        <div class="text-xl font-semibold mt-1">{{ engagement_summary.weekly_milestones_avg|default(0, true) }}</div>
      </div>
    </div>
  </div>

  {# -------------------------------------------------------------- #}
  {# Readiness Charts                                                #}
  {# -------------------------------------------------------------- #}
  <div class="grid gap-5 md:grid-cols-2 mb-6 text-[13px]">
    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-2">Readiness distribution (score buckets)</h2>
      <p class="text-[11px] text-slate-400/80 mb-2">
        0–100 score distribution for filtered students (bucketed by tens).
      </p>
      <div style="height:240px;">
        <canvas id="chartReadinessBuckets"></canvas>
      </div>
    </div>

    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-2">Readiness tiers</h2>
      <p class="text-[11px] text-slate-400/80 mb-2">
        Top Tier (80+), Job Ready (60–79), Building (40–59), Getting Started (0–39).
      </p>
      <div style="height:240px;">
        <canvas id="chartReadinessTiers"></canvas>
      </div>
    </div>
  </div>

  {# -------------------------------------------------------------- #}
  {# Skills & Roles Charts                                           #}
  {# -------------------------------------------------------------- #}
  <div class="grid gap-5 md:grid-cols-2 mb-6 text-[13px]">
    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-2">Top skills (from Skill Mapper)</h2>
      <p class="text-[11px] text-slate-400/80 mb-2">
        Most common skills inferred from Skill Mapper runs (signal extraction).
      </p>
      <div style="height:220px;">
        <canvas id="chartSkillsTop"></canvas>
      </div>
    </div>

    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-2">Top target roles (from Job Packs)</h2>
      <p class="text-[11px] text-slate-400/80 mb-2">
        Roles students are most often analyzing with Job Packs.
      </p>
      <div style="height:220px;">
        <canvas id="chartRolesTop"></canvas>
      </div>
    </div>
  </div>

  {# -------------------------------------------------------------- #}
  {# Internships                                                     #}
  {# -------------------------------------------------------------- #}
  <div class="glass-card rounded-2xl px-4 py-4 mb-6 text-[13px]">
    <h2 class="text-sm font-semibold mb-2">Internship search roles</h2>
    <p class="text-[11px] text-slate-400/80 mb-2">
      Most common internship titles students are exploring.
    </p>
    <div style="height:220px;">
      <canvas id="chartInternshipRoles"></canvas>
    </div>
  </div>

  {# -------------------------------------------------------------- #}
  {# Top Students Table                                              #}
  {# -------------------------------------------------------------- #}
  <div class="glass-card rounded-2xl px-4 py-4 mb-4 text-[13px]">
    <div class="flex items-center justify-between gap-3 mb-2">
      <h2 class="text-sm font-semibold">Top students (actionable list)</h2>
      <div class="text-[11px] text-slate-400/80">
        Sorted by readiness score, then streak. Shows proof-of-work signals.
      </div>
    </div>

    {% if student_rows and student_rows|length > 0 %}
      <div class="overflow-x-auto -mx-2 text-[11px]">
        <table class="min-w-full">
          <thead class="bg-slate-900/80 text-slate-200/80">
            <tr>
              <th class="px-3 py-2 text-left font-semibold">Student</th>
              <th class="px-3 py-2 text-left font-semibold">Tier</th>
              <th class="px-3 py-2 text-right font-semibold">Ready</th>
              <th class="px-3 py-2 text-right font-semibold">Streak</th>
              <th class="px-3 py-2 text-right font-semibold">Longest</th>
              <th class="px-3 py-2 text-right font-semibold">Milestones</th>
              <th class="px-3 py-2 text-right font-semibold">DevLogs</th>
              <th class="px-3 py-2 text-right font-semibold">Projects</th>
              <th class="px-3 py-2 text-right font-semibold">Public Portfolio</th>
              <th class="px-3 py-2 text-left font-semibold">Flags</th>
            </tr>
          </thead>
          <tbody>
            {% for s in student_rows %}
            <tr class="border-t border-slate-700/60">
              <td class="px-3 py-2">
                <div class="text-slate-100/90 font-medium">{{ s.name }}</div>
                <div class="text-slate-400/80">{{ s.email }}</div>
              </td>
              <td class="px-3 py-2 text-slate-200/80">{{ s.tier }}</td>
              <td class="px-3 py-2 text-right text-slate-100/90 font-semibold">{{ s.ready_score }}</td>
              <td class="px-3 py-2 text-right text-slate-200/90">{{ s.current_streak }}</td>
              <td class="px-3 py-2 text-right text-slate-200/90">{{ s.longest_streak }}</td>
              <td class="px-3 py-2 text-right text-slate-200/90">{{ s.weekly_milestones_completed }}</td>
              <td class="px-3 py-2 text-right text-slate-200/90">{{ s.learning_logs }}</td>
              <td class="px-3 py-2 text-right text-slate-200/90">{{ s.projects }}</td>
              <td class="px-3 py-2 text-right text-slate-200/90">{{ s.public_portfolio_pages }}</td>
              <td class="px-3 py-2 text-slate-300/90">
                <div class="flex flex-wrap gap-1">
                  {% if s.verified %}
                    <span class="px-2 py-0.5 rounded-full bg-emerald-900/40 border border-emerald-700/40 text-[10px]">Verified</span>
                  {% else %}
                    <span class="px-2 py-0.5 rounded-full bg-slate-900/40 border border-slate-700/40 text-[10px]">Unverified</span>
                  {% endif %}
                  {% if s.pro %}
                    <span class="px-2 py-0.5 rounded-full bg-amber-900/40 border border-amber-700/40 text-[10px]">Pro</span>
                  {% endif %}
                  {% if s.public_portfolio_pages|int > 0 %}
                    <span class="px-2 py-0.5 rounded-full bg-indigo-900/40 border border-indigo-700/40 text-[10px]">Portfolio</span>
                  {% endif %}
                  {% if s.learning_logs|int > 0 %}
                    <span class="px-2 py-0.5 rounded-full bg-cyan-900/40 border border-cyan-700/40 text-[10px]">DevLog</span>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-[11px] text-slate-400/80">No students match your current filters.</p>
    {% endif %}
  </div>

  <p class="text-[11px] text-slate-400/80">
    Next upgrade (UI): add cohort filters (department/year), and a drilldown student profile view for dean review.
  </p>

  {# -------------------------------------------------------------- #}
  {# Analytics payload + scripts                                     #}
  {# -------------------------------------------------------------- #}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    window.CAREERAI_ANALYTICS = {
      skillsTop: {{ skills_top|tojson }},
      rolesTop: {{ roles_top|tojson }},
      internshipRoles: {{ internship_roles|tojson }},

      readinessChart: {{ readiness_chart|tojson }},
      streakChart: {{ streak_chart|tojson }},
      engagementSummary: {{ engagement_summary|tojson }},

      problemsSummary: {{ problems_summary|tojson }},
      resumeMissingSkillsTop: {{ resume_missing_skills_top|tojson }},
      roadmapMissingSkillsTop: {{ roadmap_missing_skills_top|tojson }},
      resumeBlockersTop: {{ resume_blockers_top|tojson }},
      resumeWarningsTop: {{ resume_warnings_top|tojson }},
      toolUsageRuns: {{ tool_usage_runs|tojson }},

      meta: {
        q: {{ (q or '')|tojson }},
        start: {{ (start or '')|tojson }},
        end: {{ (end or '')|tojson }},
        onlyVerified: {{ (only_verified or false)|tojson }},
        onlyPro: {{ (only_pro or false)|tojson }},
        minReady: {{ (min_ready)|tojson }},
        maxReady: {{ (max_ready)|tojson }}
      }
    };
  </script>
  <script src="{{ url_for('static', filename='js/admin_analytics.js') }}"></script>

</div>
{% endblock %}
