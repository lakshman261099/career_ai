{# templates/admin/audit.html #}
{% extends "admin/_layout.html" %}

{% block title %}Ultra Admin · Audit · CareerAI{% endblock %}
{% set active_tab = 'audit' %}

{% block admin_body %}
<div>

  <h1 class="text-xl sm:text-2xl font-semibold tracking-tight mb-4">
    Ultra Admin · Audit
  </h1>

  <!-- Super Admin List + Recent Admin Credit Adjustments -->
  <div class="grid gap-5 md:grid-cols-2 mb-6 text-[13px]">

    <!-- Super Admins -->
    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-2">Super admins</h2>
      {% if super_admins %}
        <ul class="space-y-1.5 text-[12px]">
          {% for u in super_admins %}
            <li class="flex items-center justify-between">
              <div>
                <div class="font-semibold text-slate-100/90">{{ u.email }}</div>
                <div class="text-[11px] text-slate-400/80">
                  {{ u.name or 'No name' }}
                  {% if u.created_at %}
                    · since {{ u.created_at.strftime('%Y-%m-%d') }}
                  {% endif %}
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-[11px] text-slate-400/80">No super admin accounts found.</p>
      {% endif %}
    </div>

    <!-- Recent Admin Credit Adjustments -->
    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-2">Recent admin credit adjustments</h2>

      {% if admin_credits %}
        <div class="overflow-x-auto -mx-2 text-[11px]">
          <table class="min-w-full">
            <thead class="bg-slate-900/80 text-slate-200/80">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">When</th>
                <th class="px-3 py-2 text-left font-semibold">User</th>
                <th class="px-3 py-2 text-left font-semibold">Type</th>
                <th class="px-3 py-2 text-right font-semibold">Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for tx in admin_credits %}
              <tr class="border-t border-slate-700/60">
                <td class="px-3 py-2 text-slate-200/80">
                  {{ tx.created_at.strftime('%Y-%m-%d %H:%M') if tx.created_at else '' }}
                </td>
                <td class="px-3 py-2 text-slate-100/90">
                  {{ tx.user.email if tx.user else '—' }}
                </td>
                <td class="px-3 py-2 text-slate-200/80">
                  {{ tx.tx_type|capitalize }} ({{ tx.currency }})
                  <span class="text-slate-400/80 text-[10px] ml-1">{{ tx.feature }}</span>
                </td>
                <td class="px-3 py-2 text-right text-slate-100/90">
                  {% if tx.tx_type == 'debit' %}
                    -{{ tx.amount }}
                  {% else %}
                    +{{ tx.amount }}
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-[11px] text-slate-400/80">
          No recent admin-related credit transactions found.
        </p>
      {% endif %}
    </div>

  </div>

  <!-- Recent Vouchers + Deals -->
  <div class="glass-card rounded-2xl px-4 py-4 text-[12px]">
    <h2 class="text-sm font-semibold mb-2">Recent vouchers & deals</h2>

    <div class="grid gap-4 md:grid-cols-2">

      <!-- Vouchers -->
      <div>
        <h3 class="text-xs font-semibold mb-2">Voucher campaigns</h3>
        {% if vouchers %}
          <ul class="space-y-1.5 text-[11px]">
            {% for v in vouchers %}
              <li class="border-b border-slate-700/60 pb-1.5">
                <div class="flex items-center justify-between">
                  <div>
                    <span class="font-semibold text-slate-100/90">{{ v.code }}</span>
                    {% if v.university %}
                      <span class="text-[10px] text-slate-400/80 ml-1">
                        · {{ v.university.name }}
                      </span>
                    {% endif %}
                  </div>
                  <div class="text-[10px] text-slate-400/80">
                    {{ v.created_at.strftime('%Y-%m-%d') if v.created_at else '' }}
                  </div>
                </div>
                <div class="text-[10px] text-slate-400/80">
                  By: {{ v.creator.email if v.creator else '—' }}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-[11px] text-slate-400/80">No voucher campaigns yet.</p>
        {% endif %}
      </div>

      <!-- Deals -->
      <div>
        <h3 class="text-xs font-semibold mb-2">Deals</h3>
        {% if deals %}
          <ul class="space-y-1.5 text-[11px]">
            {% for d in deals %}
              <li class="border-b border-slate-700/60 pb-1.5">
                <div class="flex items-center justify-between">
                  <div>
                    <span class="font-semibold text-slate-100/90">{{ d.name }}</span>
                    {% if d.university %}
                      <span class="text-[10px] text-slate-400/80 ml-1">
                        · {{ d.university.name }}
                      </span>
                    {% endif %}
                  </div>
                  <div class="text-[10px] text-slate-400/80">
                    {{ d.created_at.strftime('%Y-%m-%d') if d.created_at else '' }}
                  </div>
                </div>
                <div class="text-[10px] text-slate-400/80">
                  By: {{ d.creator.email if d.creator else '—' }}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-[11px] text-slate-400/80">No deals created yet.</p>
        {% endif %}
      </div>

    </div>
  </div>

  <p class="mt-3 text-[11px] text-slate-400/80">
    This audit page is read-only. Ultra admins can always see global actions
    by super admins, but never tenant-level student analytics.
  </p>

</div>
{% endblock %}
