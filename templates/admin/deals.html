{# templates/admin/deals.html #}
{% extends "base.html" %}
{% block title %}Admin · Deals · CareerAI{% endblock %}

{% block content %}
<div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 mt-6 mb-16">

  {# ---------- Shared Admin Sub-Nav ---------- #}
  {% macro admin_tab(label, endpoint_name, extra_endpoints) %}
    {% set ep = request.endpoint or '' %}
    {% set active = (ep == endpoint_name) or (ep in extra_endpoints) %}
    <a href="{{ url_for(endpoint_name) }}"
       class="px-3 py-1.5 rounded-full border text-xs
              {% if active %}
                bg-slate-900 text-white border-indigo-400
              {% else %}
                bg-slate-900/40 text-slate-200/80 border-slate-500/70 hover:border-indigo-400/80
              {% endif %}">
      {{ label }}
    </a>
  {% endmacro %}

  <div class="glass-card rounded-2xl px-4 py-3 mb-5 flex flex-wrap items-center gap-2 text-[12px]">
    {{ admin_tab("Overview", "admin.dashboard", []) }}
    {{ admin_tab("Users", "admin.users", []) }}
    {{ admin_tab("Credits", "admin.credits", []) }}
    {{ admin_tab("Universities", "admin.universities", []) }}
    {{ admin_tab("Deals", "admin.deals", []) }}
    {{ admin_tab("Vouchers", "admin.vouchers", ["admin.voucher_detail"]) }}

    <span class="ml-auto text-[11px] text-slate-400/80">
      Admin · university deals & seat packs
    </span>
  </div>

  <h1 class="text-xl sm:text-2xl font-semibold tracking-tight mb-4">
    Admin · University Deals
  </h1>

  <div class="grid gap-5 lg:grid-cols-2 mb-6 text-[13px]">
    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-3">Create deal</h2>

      {% if not universities %}
        <p class="text-[11px] text-slate-400/80">
          You need at least one university before creating deals.
        </p>
      {% else %}
        <form method="post" class="space-y-3">
          <div>
            <label class="block text-xs font-semibold mb-1 text-slate-200/90">
              University
            </label>
            <select name="university_id" required
                    class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400">
              <option value="">Select university…</option>
              {% for uni in universities %}
                <option value="{{ uni.id }}">{{ uni.name }}{% if uni.tenant_slug %} · {{ uni.tenant_slug }}{% endif %}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="block text-xs font-semibold mb-1 text-slate-200/90">
              Deal name
            </label>
            <input type="text" name="name" required placeholder="Veltech 2025 pilot, BITS full-year, …"
                   class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"/>
          </div>

          <div class="grid gap-3 sm:grid-cols-3">
            <div>
              <label class="block text-xs font-semibold mb-1 text-slate-200/90">
                Seats (students)
              </label>
              <input type="number" name="seats_total" min="1" placeholder="e.g. 200"
                     class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"/>
            </div>
            <div>
              <label class="block text-xs font-semibold mb-1 text-slate-200/90">
                Silver total
              </label>
              <input type="number" name="silver_credits_total" min="0" placeholder="e.g. 50000"
                     class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"/>
            </div>
            <div>
              <label class="block text-xs font-semibold mb-1 text-slate-200/90">
                Gold total
              </label>
              <input type="number" name="gold_credits_total" min="0" placeholder="e.g. 20000"
                     class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"/>
            </div>
          </div>

          <div class="grid gap-3 sm:grid-cols-3">
            <div>
              <label class="block text-xs font-semibold mb-1 text-slate-200/90">
                Price (cents)
              </label>
              <input type="number" name="price_cents" min="0" placeholder="e.g. 2500000"
                     class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"/>
            </div>
            <div>
              <label class="block text-xs font-semibold mb-1 text-slate-200/90">
                Currency
              </label>
              <input type="text" name="currency_code" value="INR"
                     class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"/>
            </div>
            <div>
              <label class="block text-xs font-semibold mb-1 text-slate-200/90">
                Status
              </label>
              <select name="status"
                      class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400">
                <option value="draft">Draft</option>
                <option value="active" selected>Active</option>
                <option value="paused">Paused</option>
                <option value="closed">Closed</option>
              </select>
            </div>
          </div>

          <div class="grid gap-3 sm:grid-cols-2">
            <div>
              <label class="block text-xs font-semibold mb-1 text-slate-200/90">
                Start date
              </label>
              <input type="date" name="start_date"
                     class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"/>
            </div>
            <div>
              <label class="block text-xs font-semibold mb-1 text-slate-200/90">
                End date
              </label>
              <input type="date" name="end_date"
                     class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"/>
            </div>
          </div>

          <div>
            <label class="block text-xs font-semibold mb-1 text-slate-200/90">
              Notes (internal)
            </label>
            <textarea name="notes" rows="3"
                      class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"
                      placeholder="Deal terms, invoice notes, contact person, etc."></textarea>
          </div>

          <button type="submit" class="btn-primary text-xs mt-1">
            Create deal
          </button>
        </form>
      {% endif %}
    </div>

    <div class="glass-card rounded-2xl px-4 py-4 text-[12px]">
      <h2 class="text-sm font-semibold mb-3">Existing deals</h2>
      {% if deals %}
        <div class="overflow-x-auto -mx-2">
          <table class="min-w-full text-[11px]">
            <thead class="bg-slate-900/80 text-slate-200/80">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">University</th>
                <th class="px-3 py-2 text-left font-semibold">Deal</th>
                <th class="px-3 py-2 text-left font-semibold">Seats</th>
                <th class="px-3 py-2 text-left font-semibold">Silver</th>
                <th class="px-3 py-2 text-left font-semibold">Gold</th>
                <th class="px-3 py-2 text-left font-semibold">Status</th>
              </tr>
            </thead>
            <tbody>
              {% for d in deals %}
              <tr class="border-t border-slate-700/60">
                <td class="px-3 py-2 text-slate-100/90">
                  {{ d.university.name if d.university else '—' }}
                </td>
                <td class="px-3 py-2">
                  <div class="text-slate-100/90">{{ d.name }}</div>
                  {% if d.start_date or d.end_date %}
                    <div class="text-slate-400/80 text-[10px]">
                      {{ d.start_date or '—' }} → {{ d.end_date or '—' }}
                    </div>
                  {% endif %}
                </td>
                <td class="px-3 py-2 text-slate-200/80">
                  {% if d.seats_total is not none %}
                    {{ d.seats_used or 0 }} / {{ d.seats_total }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td class="px-3 py-2 text-slate-200/80">
                  {% if d.silver_credits_total is not none %}
                    {{ d.silver_credits_used or 0 }} / {{ d.silver_credits_total }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td class="px-3 py-2 text-slate-200/80">
                  {% if d.gold_credits_total is not none %}
                    {{ d.gold_credits_used or 0 }} / {{ d.gold_credits_total }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td class="px-3 py-2 text-slate-200/80">
                  {{ d.status|capitalize }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-[11px] text-slate-400/80">
          No deals yet. Create a deal to track bulk seats & credits sold to a university.
        </p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
