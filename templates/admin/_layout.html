{# templates/admin/_layout.html #}
{% extends "base.html" %}

{% block title %}Admin · CareerAI{% endblock %}

{% block content %}
<div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 mt-6 mb-16">

  {# ------------------------------------------------------------------ #}
  {# Resolve an "effective tenant" for UI                                #}
  {# - Prefer host-based g.current_tenant (true tenant routing)           #}
  {# - Else fallback to current_user.university for university admins      #}
  {# ------------------------------------------------------------------ #}
  {% set role = (current_user.role or 'student') %}
  {% set tenant_host = g.current_tenant if g.current_tenant is defined else None %}
  {% set tenant_user = current_user.university if current_user is defined and current_user.university is defined else None %}
  {% set effective_tenant = tenant_host if tenant_host else (tenant_user if role == 'university_admin' else None) %}

  {# ------------------------------------------------------------------ #}
  {# Admin header (role + tenant badge)                                  #}
  {# ------------------------------------------------------------------ #}
  <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
    <div>
      <div class="text-xs uppercase tracking-[0.2em] text-slate-400/80 mb-1">
        Admin Panel
      </div>

      <div class="flex flex-wrap items-center gap-2 text-[12px] text-slate-300/80">
        <span class="inline-flex items-center rounded-full border border-slate-600/70 bg-slate-900/80 px-2 py-0.5 text-[11px]">
          {% if role == 'ultra_admin' %}
            Ultra Admin
          {% elif role == 'super_admin' %}
            Super Admin
          {% elif role == 'university_admin' %}
            University Admin
          {% else %}
            Student
          {% endif %}
        </span>

        {# Tenant badge: show BOTH "host tenant" and "effective tenant" when relevant #}
        {% if tenant_host %}
          <span class="inline-flex items-center rounded-full border border-indigo-400/60 bg-indigo-500/10 px-2 py-0.5 text-[11px]">
            Tenant (host): {{ tenant_host.name }}
          </span>
        {% endif %}

        {% if effective_tenant %}
          {% if not tenant_host %}
            <span class="inline-flex items-center rounded-full border border-amber-400/60 bg-amber-500/10 px-2 py-0.5 text-[11px]">
              Tenant (fallback): {{ effective_tenant.name }}
            </span>
          {% endif %}
        {% else %}
          <span class="inline-flex items-center rounded-full border border-slate-500/60 bg-slate-800/70 px-2 py-0.5 text-[11px]">
            Global view
          </span>
        {% endif %}
      </div>
    </div>

    <div class="text-right text-[11px] text-slate-400/80">
      <div>{{ current_user.email }}</div>
      <div class="text-[10px]">
        Admin tools are tenant-scoped and fully audit-logged.
      </div>
    </div>
  </div>

  {# ------------------------------------------------------------------ #}
  {# IMPORTANT: Tenant routing warning for University Admins              #}
  {# If they aren't on their tenant domain, analytics may look empty.     #}
  {# ------------------------------------------------------------------ #}
  {% if role == 'university_admin'
        and not current_user.is_super_admin
        and not current_user.is_ultra_admin %}
    {% if not tenant_host %}
      <div class="rounded-2xl border border-amber-400/40 bg-amber-500/10 px-4 py-3 mb-4">
        <div class="flex flex-wrap items-start justify-between gap-3">
          <div class="min-w-[240px]">
            <div class="text-[12px] font-semibold text-amber-200">
              You’re not on your university tenant domain.
            </div>
            <div class="text-[11px] text-slate-200/80 mt-1">
              Analytics and student data are tenant-scoped. If you access the admin panel on the main domain / localhost,
              <span class="font-semibold">tenant resolution (g.current_tenant) may be empty</span> and charts can show “no data”.
            </div>
            {% if effective_tenant %}
              <div class="text-[11px] text-slate-200/80 mt-2">
                We detected your university as:
                <span class="font-semibold text-slate-100">{{ effective_tenant.name }}</span>
                (fallback mode).
              </div>
            {% endif %}
          </div>

          <div class="text-[11px] text-slate-200/80">
            <div class="font-semibold text-slate-100 mb-1">Fix</div>
            <div class="space-y-1">
              <div>• Log in using your tenant domain (recommended).</div>
              <div>• If you don’t have one set, ask a global admin to set <span class="font-mono">University.domain</span> or <span class="font-mono">tenant_slug</span>.</div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}

  {# ------------------------------------------------------------------ #}
  {# Admin sub-navigation — role-aware, dean-friendly                     #}
  {# GOAL: keep "Student Analytics" and "Credit Analytics" separate tabs  #}
  {# ------------------------------------------------------------------ #}
  <div class="glass-card rounded-2xl px-3 py-2 mb-4">
    <nav class="flex flex-wrap gap-2 text-[11px]">

      {# Always visible ------------------------------------------------ #}
      <a href="{{ url_for('admin.dashboard') }}"
         class="nav-link {% if active_tab == 'overview' %}nav-active{% endif %}">
        Overview
      </a>

      {# Label tweak: for University Admins, call it Students (clearer) #}
      <a href="{{ url_for('admin.users') }}"
         class="nav-link {% if active_tab == 'users' %}nav-active{% endif %}">
        {% if role == 'university_admin' and not current_user.is_super_admin and not current_user.is_ultra_admin %}
          Students
        {% else %}
          Users
        {% endif %}
      </a>

      {# Credit Analytics / Adjustments (separate from Student Analytics) #}
      <a href="{{ url_for('admin.credits') }}"
         class="nav-link {% if active_tab in ['credits', 'credit_analytics'] %}nav-active{% endif %}">
        Credit Analytics
      </a>

      {# University Admin – Student Analytics only (tenant-scoped) ------ #}
      {% if role == 'university_admin'
            and not current_user.is_super_admin
            and not current_user.is_ultra_admin %}
        <a href="{{ url_for('admin.analytics') }}"
           class="nav-link {% if active_tab in ['analytics', 'student_analytics'] %}nav-active{% endif %}">
          Student Analytics
        </a>
      {% endif %}

      {# Global Admins (Super / Ultra) – show all platform functions ----- #}
      {% if current_user.is_super_admin or current_user.is_ultra_admin %}
        <span class="inline-flex items-center px-1 text-slate-500/80 text-[10px] ml-1">
          · Platform
        </span>

        <a href="{{ url_for('admin.universities') }}"
           class="nav-link {% if active_tab == 'universities' %}nav-active{% endif %}">
          Universities
        </a>

        <a href="{{ url_for('admin.university_wallets') }}"
           class="nav-link {% if active_tab == 'wallets' %}nav-active{% endif %}">
          Wallets
        </a>

        <a href="{{ url_for('admin.deals') }}"
           class="nav-link {% if active_tab == 'deals' %}nav-active{% endif %}">
          Deals
        </a>

        <a href="{{ url_for('admin.vouchers') }}"
           class="nav-link {% if active_tab == 'vouchers' %}nav-active{% endif %}">
          Vouchers
        </a>
      {% endif %}

      {# Ultra Admin ONLY – Audit -------------------------------------- #}
      {% if current_user.is_ultra_admin %}
        <span class="inline-flex items-center px-1 text-slate-500/80 text-[10px] ml-1">
          · Security
        </span>
        <a href="{{ url_for('admin.audit') }}"
           class="nav-link {% if active_tab == 'audit' %}nav-active{% endif %}">
          Audit
        </a>
      {% endif %}

      <span class="ml-auto text-[11px] text-slate-400/80">
        Changes are tenant-scoped unless you're a global admin.
      </span>
    </nav>
  </div>

  {# ------------------------------------------------------------------ #}
  {# Actual page content                                                #}
  {# ------------------------------------------------------------------ #}
  <div>
    {% block admin_body %}{% endblock %}
  </div>

</div>
{% endblock %}
