{# templates/admin/vouchers.html #}
{% extends "admin/_layout.html" %}

{% block title %}Admin ¬∑ Vouchers ¬∑ CareerAI{% endblock %}
{% set active_tab = 'vouchers' %}

{% block admin_body %}
<div>

  <h1 class="text-xl sm:text-2xl font-semibold tracking-tight mb-4">
    Admin ¬∑ Voucher Campaigns
  </h1>

  {% if not current_user.is_super_admin and not current_user.is_ultra_admin %}
    <p class="text-[12px] text-amber-300/80 mb-4">
      You do not have permission to manage voucher campaigns.
    </p>
  {% else %}

  <div class="grid gap-6 lg:grid-cols-2 mb-6 text-[13px]">

    <!-- Create voucher form -->
    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-3">Create voucher campaign</h2>

      <form method="post" class="space-y-3">

        <!-- Code -->
        <div>
          <label class="block text-xs font-semibold mb-1 text-slate-200/90">Code</label>
          <input
            type="text"
            name="code"
            required
            placeholder="VELTECH50, CAMPUS2025"
            class="w-full rounded-lg border border-slate-600/70 bg-slate-950/70 px-3 py-2 text-sm uppercase focus:outline-none focus:ring-1 focus:ring-indigo-400"
          />
        </div>

        <!-- Description -->
        <div>
          <label class="block text-xs font-semibold mb-1 text-slate-200/90">Description</label>
          <input
            type="text"
            name="description"
            placeholder="Influencer code, campus event, partner offer‚Ä¶"
            class="w-full rounded-lg border border-slate-600/70 bg-slate-950/70 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"
          />
        </div>

        <!-- Discount + credits -->
        <div class="grid gap-3 sm:grid-cols-3">
          <div>
            <label class="block text-xs font-semibold mb-1 text-slate-200/90">Discount %</label>
            <input
              type="number"
              name="discount_percent"
              min="0" max="100"
              placeholder="50"
              class="w-full rounded-lg border border-slate-600/70 bg-slate-950/70 px-3 py-2 text-sm"
            />
          </div>

          <div>
            <label class="block text-xs font-semibold mb-1 text-slate-200/90">Bonus Silver ü™ô</label>
            <input
              type="number"
              name="bonus_silver"
              min="0"
              value="0"
              class="w-full rounded-lg border border-slate-600/70 bg-slate-950/70 px-3 py-2 text-sm"
            />
          </div>

          <div>
            <label class="block text-xs font-semibold mb-1 text-slate-200/90">Bonus Gold ‚≠ê</label>
            <input
              type="number"
              name="bonus_gold"
              min="0"
              value="0"
              class="w-full rounded-lg border border-slate-600/70 bg-slate-950/70 px-3 py-2 text-sm"
            />
          </div>
        </div>

        <!-- University + max uses -->
        <div class="grid gap-3 sm:grid-cols-3">
          <div class="sm:col-span-2">
            <label class="block text-xs font-semibold mb-1 text-slate-200/90">
              Limit to university (optional)
            </label>
            <select
              name="university_id"
              class="w-full rounded-lg border border-slate-600/70 bg-slate-950/70 px-3 py-2 text-sm"
            >
              <option value="">Global (any tenant)</option>
              {% for uni in universities %}
                <option value="{{ uni.id }}">{{ uni.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="block text-xs font-semibold mb-1 text-slate-200/90">
              Max uses
            </label>
            <input
              type="number"
              name="max_uses"
              min="1"
              placeholder="100"
              class="w-full rounded-lg border border-slate-600/70 bg-slate-950/70 px-3 py-2 text-sm"
            />
          </div>
        </div>

        <!-- Expiry -->
        <div>
          <label class="block text-xs font-semibold mb-1 text-slate-200/90">
            Expires at (optional)
          </label>
          <input
            type="date"
            name="expires_at"
            class="w-full rounded-lg border border-slate-600/70 bg-slate-950/70 px-3 py-2 text-sm"
          />
        </div>

        <button type="submit" class="btn-primary text-xs mt-1">
          Create voucher campaign
        </button>

      </form>
    </div>

    <!-- Voucher list -->
    <div class="glass-card rounded-2xl px-4 py-4 text-[12px]">

      <h2 class="text-sm font-semibold mb-3">Voucher campaigns</h2>

      {% if vouchers %}
        <div class="overflow-x-auto -mx-2 text-[11px]">
          <table class="min-w-full">
            <thead class="bg-slate-900/80 text-slate-200/80">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">Code</th>
                <th class="px-3 py-2 text-left font-semibold">Offer</th>
                <th class="px-3 py-2 text-left font-semibold">Scope</th>
                <th class="px-3 py-2 text-left font-semibold">Usage</th>
                <th class="px-3 py-2 text-left font-semibold">Status</th>
              </tr>
            </thead>
            <tbody>

              {% for v in vouchers %}
              <tr class="border-t border-slate-700/60">

                <!-- Code -->
                <td class="px-3 py-2 text-slate-100/90">
                  <a href="{{ url_for('admin.voucher_detail', campaign_id=v.id) }}"
                     class="underline decoration-slate-400/70 hover:decoration-indigo-400">
                    {{ v.code }}
                  </a>
                  <div class="text-[10px] text-slate-400/80">
                    {{ v.description or "‚Äî" }}
                  </div>
                </td>

                <!-- Offer -->
                <td class="px-3 py-2 text-slate-200/80">
                  {% set parts = [] %}
                  {% if v.discount_percent %}
                    {% set _ = parts.append(v.discount_percent ~ "% off") %}
                  {% endif %}
                  {% if v.bonus_silver %}
                    {% set _ = parts.append("+" ~ v.bonus_silver ~ " ü™ô") %}
                  {% endif %}
                  {% if v.bonus_gold %}
                    {% set _ = parts.append("+" ~ v.bonus_gold ~ " ‚≠ê") %}
                  {% endif %}

                  {% if parts %}
                    {{ parts|join(" + ") }}
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>

                <!-- Scope -->
                <td class="px-3 py-2 text-slate-200/80">
                  {% if v.university %}
                    {{ v.university.name }}
                  {% else %}
                    Global
                  {% endif %}
                </td>

                <!-- Usage -->
                <td class="px-3 py-2 text-slate-200/80">
                  {% if v.max_uses %}
                    {{ v.used_count or 0 }} / {{ v.max_uses }}
                  {% else %}
                    {{ v.used_count or 0 }} used
                  {% endif %}
                </td>

                <!-- Status -->
                <td class="px-3 py-2">
                  {% if not v.is_active %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full border border-slate-500/60 bg-slate-800/40 text-slate-300 text-[10px]">
                      Inactive
                    </span>
                  {% else %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full border border-emerald-400/60 bg-emerald-500/10 text-emerald-200 text-[10px]">
                      Active
                    </span>
                  {% endif %}
                </td>

              </tr>
              {% endfor %}

            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-[11px] text-slate-400/80">
          No voucher campaigns yet. Create one to start giving promo codes to partners or universities.
        </p>
      {% endif %}

    </div>

  </div>

  {% endif %}

</div>
{% endblock %}
