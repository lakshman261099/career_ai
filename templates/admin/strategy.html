{% extends "admin/_layout.html" %}
{% block title %}Dean Dashboard · CareerAI{% endblock %}
{% set active_tab = 'strategy' %}

{% block admin_body %}
<div>
  {# Safe defaults so template never crashes #}
  {% set tenant = tenant|default(None) %}
  {% set departments = departments|default([]) %}
  {% set selected_department = selected_department|default('') %}
  {% set start = start|default('') %}
  {% set end = end|default('') %}
  {% set min_ready = min_ready|default(0) %}

  {% set funnel = funnel|default([]) %}
  {% set top_gaps = top_gaps|default([]) %}
  {% set top_blockers = top_blockers|default([]) %}
  {% set top_warnings = top_warnings|default([]) %}
  {% set top_missing_keywords = top_missing_keywords|default([]) %}
  {% set watchlist = watchlist|default([]) %}
  {% set summary = summary|default({}) %}

  <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
    <div>
      <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">
        Dean Dashboard · {{ tenant.name if tenant else "University" }}
      </h1>
      <div class="text-[11px] text-slate-400/80 mt-1">
        One page to understand placements: where students get stuck, what skills are missing, what is blocking interviews, and who needs help now.
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="glass-card rounded-2xl px-4 py-4 mb-5 text-[12px]">
    <h2 class="text-sm font-semibold mb-2">Filters</h2>
    <form method="get" action="{{ url_for('admin.strategy') }}" class="grid gap-3 md:grid-cols-12">
      <div class="md:col-span-3">
        <label class="block text-[11px] text-slate-400/80 mb-1">Department</label>
        <select name="department" class="w-full rounded-xl bg-slate-900/60 border border-slate-700/60 px-3 py-2 text-[12px] outline-none">
          <option value="">All departments</option>
          {% for d in departments %}
            <option value="{{ d }}" {% if selected_department == d %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="md:col-span-2">
        <label class="block text-[11px] text-slate-400/80 mb-1">Start date</label>
        <input type="date" name="start" value="{{ start }}"
               class="w-full rounded-xl bg-slate-900/60 border border-slate-700/60 px-3 py-2 text-[12px] outline-none"/>
      </div>

      <div class="md:col-span-2">
        <label class="block text-[11px] text-slate-400/80 mb-1">End date</label>
        <input type="date" name="end" value="{{ end }}"
               class="w-full rounded-xl bg-slate-900/60 border border-slate-700/60 px-3 py-2 text-[12px] outline-none"/>
      </div>

      <div class="md:col-span-2">
        <label class="block text-[11px] text-slate-400/80 mb-1">Show readiness ≥</label>
        <input type="number" name="min_ready" min="0" max="100"
               value="{{ min_ready if min_ready is not none else 0 }}"
               class="w-full rounded-xl bg-slate-900/60 border border-slate-700/60 px-3 py-2 text-[12px] outline-none"/>
      </div>

      <div class="md:col-span-3 flex items-end justify-end gap-2">
        <a href="{{ url_for('admin.strategy') }}" class="btn-ghost text-[11px] px-3 py-2">Reset</a>
        <button type="submit" class="btn-primary text-[11px] px-4 py-2">Apply</button>
      </div>
    </form>

    <div class="mt-3 text-[11px] text-slate-400/80">
      Tip: Use <span class="font-mono">Show readiness ≥ 60</span> to view only students close to placement level.
    </div>
  </div>

  {# Handy numbers #}
  {% set total_students = (summary.total_students if summary is defined and summary.total_students is defined else 0) %}
  {% set profile_done = (summary.profile_done if summary is defined and summary.profile_done is defined else 0) %}
  {% set has_project = (summary.has_project if summary is defined and summary.has_project is defined else 0) %}
  {% set has_devlog = (summary.has_devlog if summary is defined and summary.has_devlog is defined else 0) %}
  {% set has_public_portfolio = (summary.has_public_portfolio if summary is defined and summary.has_public_portfolio is defined else 0) %}
  {% set job_ready = (summary.job_ready if summary is defined and summary.job_ready is defined else 0) %}

  {# Simple action logic (dean loves this) #}
  {% set biggest_gap_label = (top_gaps[0].skill if top_gaps and top_gaps|length > 0 else None) %}
  {% set biggest_gap_pct = (top_gaps[0].percent if top_gaps and top_gaps|length > 0 else None) %}
  {% set top_blocker_text = (top_blockers[0].text if top_blockers and top_blockers|length > 0 else None) %}

  <!-- What to do next -->
  <div class="glass-card rounded-2xl px-4 py-4 mb-6">
    <h2 class="text-sm font-semibold mb-1">What to do next (simple actions)</h2>
    <p class="text-[11px] text-slate-400/80 mb-3">
      Based on this data, these are the fastest wins to improve placements.
    </p>

    <div class="grid gap-3 md:grid-cols-3 text-[12px]">
      <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-3">
        <div class="text-[11px] text-slate-400/80 font-semibold">1) Project Week</div>
        <div class="text-slate-200/90 mt-1">
          If students have no projects, companies don’t shortlist.
          <div class="text-[11px] text-slate-400/80 mt-2">
            Today: <span class="font-semibold text-slate-100">{{ has_project }}</span> / {{ total_students }} students have a project.
          </div>
        </div>
      </div>

      <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-3">
        <div class="text-[11px] text-slate-400/80 font-semibold">2) Resume Clinic</div>
        <div class="text-slate-200/90 mt-1">
          Fix the common resume mistakes and interview calls increase.
          {% if top_blocker_text %}
            <div class="text-[11px] text-slate-400/80 mt-2">
              Most common issue: <span class="font-semibold text-slate-100">{{ top_blocker_text }}</span>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-3">
        <div class="text-[11px] text-slate-400/80 font-semibold">3) Skill Workshop</div>
        <div class="text-slate-200/90 mt-1">
          Teach the missing skill(s) that most students lack.
          {% if biggest_gap_label %}
            <div class="text-[11px] text-slate-400/80 mt-2">
              Biggest gap: <span class="font-semibold text-slate-100">{{ biggest_gap_label }}</span>
              {% if biggest_gap_pct is not none %} ({{ biggest_gap_pct }}%) {% endif %}
            </div>
          {% else %}
            <div class="text-[11px] text-slate-400/80 mt-2">
              No gap data yet — ask students to run Skill Mapper once.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Placement Progress -->
  <div class="glass-card rounded-2xl px-4 py-4 mb-6">
    <h2 class="text-sm font-semibold mb-1">Placement progress (where students get stuck)</h2>
    <p class="text-[11px] text-slate-400/80 mb-3">
      This shows how many students reached each step. Focus on the biggest drop.
    </p>

    {% set ns = namespace(prev=None) %}
    <div class="grid gap-3 sm:grid-cols-2 md:grid-cols-5 text-[12px]">
      {% for step in funnel %}
        {% set c = (step.count|int) %}
        {% set pct_total = ( (c / total_students) * 100 ) if total_students|int > 0 else 0 %}
        {% set pct_prev = ( (c / ns.prev) * 100 ) if ns.prev is not none and ns.prev|int > 0 else None %}

        <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-3">
          <div class="text-[11px] text-slate-400/80">{{ step.label }}</div>
          <div class="text-xl font-semibold mt-1">{{ c }}</div>
          <div class="text-[11px] text-slate-400/80 mt-1">
            {{ pct_total|round(1) }}% of batch
            {% if pct_prev is not none %}
              · {{ pct_prev|round(1) }}% reached this from previous step
            {% endif %}
          </div>
        </div>

        {% set ns.prev = c %}
      {% endfor %}
    </div>

    <div class="mt-3 text-[11px] text-slate-400/80">
      “Hiring-ready (80+)” means students are close to placement level inside CareerAI.
    </div>
  </div>

  <!-- Skill gaps + Resume issues -->
  <div class="grid gap-5 md:grid-cols-2 mb-6">

    <!-- Skill gaps -->
    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-1">Skills students are missing (batch-level)</h2>
      <p class="text-[11px] text-slate-400/80 mb-3">
        These missing skills come from Skill Mapper reports. Use this to plan workshops and curriculum add-ons.
      </p>

      {% if top_gaps and top_gaps|length > 0 %}
      <div class="overflow-x-auto -mx-2 text-[11px]">
        <table class="min-w-full">
          <thead class="bg-slate-900/80 text-slate-200/80">
            <tr>
              <th class="px-3 py-2 text-left font-semibold">Skill</th>
              <th class="px-3 py-2 text-right font-semibold">% of students</th>
              <th class="px-3 py-2 text-right font-semibold">Students</th>
              <th class="px-3 py-2 text-right font-semibold">Times seen</th>
            </tr>
          </thead>
          <tbody>
            {% for row in top_gaps %}
            <tr class="border-t border-slate-700/60">
              <td class="px-3 py-2 text-slate-100/90">{{ row.skill }}</td>
              <td class="px-3 py-2 text-right text-slate-200/90">{{ row.percent }}%</td>
              <td class="px-3 py-2 text-right text-slate-200/90">{{ row.students }}</td>
              <td class="px-3 py-2 text-right text-slate-200/90">{{ row.mentions }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-[11px] text-slate-400/80">
          No skill gap data yet. Ask students to run Skill Mapper once to make this accurate.
        </p>
      {% endif %}

      <div class="mt-2 text-[11px] text-slate-400/80">
        Note: More Skill Mapper usage = more accurate “missing skills” for the batch.
      </div>
    </div>

    <!-- Resume issues -->
    <div class="glass-card rounded-2xl px-4 py-4">
      <h2 class="text-sm font-semibold mb-1">Resume issues blocking interview calls</h2>
      <p class="text-[11px] text-slate-400/80 mb-3">
        Common problems found by Job Pack’s resume check. Fix these and shortlisting improves.
      </p>

      <div class="grid gap-3">

        <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-3">
          <div class="text-[11px] text-slate-400/80 font-semibold">Must fix first</div>
          {% if top_blockers and top_blockers|length > 0 %}
            <ul class="mt-2 space-y-1 text-[11px] text-slate-200/90">
              {% for it in top_blockers %}
                <li>• {{ it.text }} <span class="text-slate-400/80">({{ it.count }})</span></li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-[11px] text-slate-400/80 mt-2">No data yet.</div>
          {% endif %}
        </div>

        <div class="rounded-xl border border-slate-700/60 bg-slate-900/40 px-3 py-3">
          <div class="text-[11px] text-slate-400/80 font-semibold">Important words missing in resumes</div>
          <div class="text-[11px] text-slate-400/80 mt-1">
            These are common words recruiters search for (from job descriptions).
          </div>
          {% if top_missing_keywords and top_missing_keywords|length > 0 %}
            <div class="mt-2 flex flex-wrap gap-1">
              {% for it in top_missing_keywords %}
                <span class="px-2 py-0.5 rounded-full bg-slate-900/40 border border-slate-700/40 text-[10px]">
                  {{ it.text }} <span class="text-slate-400/80">({{ it.count }})</span>
                </span>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-[11px] text-slate-400/80 mt-2">No data yet.</div>
          {% endif %}
        </div>

      </div>
    </div>
  </div>

  <!-- Students needing support -->
  <div class="glass-card rounded-2xl px-4 py-4 mb-6">
    <h2 class="text-sm font-semibold mb-1">Students who need support now</h2>
    <p class="text-[11px] text-slate-400/80 mb-3">
      These students are at risk because they have low readiness or no proof of work (no projects / no weekly logs).
      Intervene early instead of waiting until placement season.
    </p>

    {% if watchlist and watchlist|length > 0 %}
      <div class="overflow-x-auto -mx-2 text-[11px]">
        <table class="min-w-full">
          <thead class="bg-slate-900/80 text-slate-200/80">
            <tr>
              <th class="px-3 py-2 text-left font-semibold">Student</th>
              <th class="px-3 py-2 text-right font-semibold">Readiness</th>
              <th class="px-3 py-2 text-right font-semibold">Active days</th>
              <th class="px-3 py-2 text-right font-semibold">Projects</th>
              <th class="px-3 py-2 text-right font-semibold">Weekly logs</th>
              <th class="px-3 py-2 text-left font-semibold">Reason</th>
            </tr>
          </thead>
          <tbody>
            {% for s in watchlist %}
            <tr class="border-t border-slate-700/60">
              <td class="px-3 py-2">
                <div class="text-slate-100/90 font-medium">{{ s.name }}</div>
                <div class="text-slate-400/80">{{ s.email }}</div>
                {% if s.department %}
                  <div class="text-slate-400/80">Dept: {{ s.department }}</div>
                {% endif %}
              </td>
              <td class="px-3 py-2 text-right text-slate-100/90 font-semibold">{{ s.ready_score }}</td>
              <td class="px-3 py-2 text-right text-slate-200/90">{{ s.current_streak }}</td>
              <td class="px-3 py-2 text-right text-slate-200/90">{{ s.projects }}</td>
              <td class="px-3 py-2 text-right text-slate-200/90">{{ s.devlogs }}</td>

              <td class="px-3 py-2 text-slate-200/90">
                {% for t in (s.tags or []) %}
                  {% set label = t %}
                  {% if t == 'Low readiness' %}{% set label = 'Low job readiness' %}{% endif %}
                  {% if t == 'Inactive' %}{% set label = 'Not active' %}{% endif %}
                  {% if t == 'No projects' %}{% set label = 'No projects yet' %}{% endif %}
                  {% if t == 'No DevLogs' %}{% set label = 'No weekly work logs' %}{% endif %}

                  <span class="px-2 py-0.5 rounded-full bg-slate-900/40 border border-slate-700/40 text-[10px] mr-1">
                    {{ label }}
                  </span>
                {% endfor %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-[11px] text-slate-400/80">No students flagged by current rules.</p>
    {% endif %}
  </div>

  <p class="text-[11px] text-slate-400/80">
    How to say it to the Dean: “This dashboard shows where placements are getting blocked, what skills the batch lacks, what resume mistakes reduce interview calls, and which students need early support.”
  </p>
</div>
{% endblock %}
