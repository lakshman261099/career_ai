{# templates/admin/users.html #}
{% extends "admin/_layout.html" %}

{% block title %}Admin ¬∑ Users ¬∑ CareerAI{% endblock %}
{% set active_tab = 'users' %}

{% block admin_body %}
<div>

  <!-- Title + description -->
  <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
    <div>
      <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">
        Admin ¬∑ Users
      </h1>
      <p class="text-[11px] text-slate-300/80 mt-1">
        Manage roles, university assignments, and credit visibility.
        {% if not is_super_admin and not is_ultra_admin %}
          <span class="block mt-0.5 text-[10px] text-amber-300/80">
            You are a tenant-scoped admin. You can manage only users in your university.
          </span>
        {% endif %}
      </p>
    </div>
  </div>

  <!-- Filters -->
  <div class="glass-card rounded-2xl px-4 py-3 mb-4 text-[13px]">
    <form method="get" class="flex flex-col sm:flex-row gap-3 items-start sm:items-end">
      
      <!-- Search -->
      <div class="flex-1 w-full">
        <label class="block text-xs font-semibold mb-1 text-slate-200/90">
          Search (email or name)
        </label>
        <input
          type="text"
          name="q"
          value="{{ q or '' }}"
          placeholder="student@example.com"
          class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"
        />
      </div>

      <!-- Role filter -->
      <div class="w-full sm:w-40">
        <label class="block text-xs font-semibold mb-1 text-slate-200/90">
          Role
        </label>
        <select
          name="role"
          class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"
        >
          <option value="">All</option>
          <option value="student" {% if role_filter=='student' %}selected{% endif %}>Student</option>
          <option value="university_admin" {% if role_filter=='university_admin' %}selected{% endif %}>University admin</option>
          <option value="super_admin" {% if role_filter=='super_admin' %}selected{% endif %}>Super admin</option>
          <option value="ultra_admin" {% if role_filter=='ultra_admin' %}selected{% endif %}>Ultra admin</option>
        </select>
      </div>

      <div>
        <button type="submit" class="btn-primary text-xs px-3 py-2">
          Apply filters
        </button>
      </div>

    </form>

    <p class="mt-2 text-[10px] text-slate-400/80">
      Showing up to 100 users. Use filters to narrow down.
    </p>
  </div>

  <!-- User list -->
  {% if users %}
    <div class="glass-card rounded-2xl overflow-hidden text-[11px]">
      <table class="min-w-full">

        <!-- Table head -->
        <thead class="bg-slate-900/80 text-slate-200/80 text-[10px] uppercase tracking-[0.16em]">
          <tr>
            <th class="px-3 py-2 text-left">User</th>
            <th class="px-3 py-2 text-left">Role</th>
            <th class="px-3 py-2 text-left">University & Role edit</th>
            <th class="px-3 py-2 text-left">Plan</th>
            <th class="px-3 py-2 text-right">Balances</th>
            <th class="px-3 py-2 text-right">Joined</th>
            <th class="px-3 py-2 text-right">Actions</th>
          </tr>
        </thead>

        <!-- Table body -->
        <tbody>
        {% for u in users %}
          {% set target_role = u.role or "student" %}
          {% set cannot_edit = false %}

          {# Permission rules ------------------------------------------------ #}
          {% if target_role == 'ultra_admin' and not is_ultra_admin %}
            {% set cannot_edit = true %}
          {% endif %}

          {% if not is_super_admin and not is_ultra_admin and target_role in ['super_admin', 'ultra_admin'] %}
            {% set cannot_edit = true %}
          {% endif %}

          {% set plan_raw = (u.subscription_status or "free") %}
          {% set plan = plan_raw.lower() %}

          <tr class="border-t border-slate-700/60">
            
            <!-- User info -->
            <td class="px-3 py-2 align-top">
              <div class="font-semibold text-slate-50 text-[11px] flex items-center gap-1.5 flex-wrap">
                {{ u.email }}
                {% if current_user.id == u.id %}
                  <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-emerald-500/10 border border-emerald-400/60 text-emerald-200">
                    You
                  </span>
                {% endif %}
                {% if u.verified %}
                  <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-emerald-500/10 border border-emerald-400/60 text-emerald-200">
                    Verified
                  </span>
                {% else %}
                  <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-amber-500/10 border border-amber-400/60 text-amber-200">
                    Not verified
                  </span>
                {% endif %}
              </div>
              <div class="text-slate-300/80 mt-0.5">
                {{ u.name or "No name" }}
              </div>
              {% if u.university %}
                <div class="mt-0.5 text-[10px] text-slate-400/80">
                  {{ u.university.name }}
                </div>
              {% endif %}
            </td>

            <!-- Role badge -->
            <td class="px-3 py-2 align-top">
              {% set role_color = {
                "student": "border-slate-500/60 bg-slate-900/80 text-slate-200",
                "university_admin": "border-blue-400/50 bg-blue-500/10 text-blue-200",
                "super_admin": "border-purple-400/50 bg-purple-500/10 text-purple-200",
                "ultra_admin": "border-red-400/50 bg-red-500/10 text-red-200"
              } %}
              <span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] {{ role_color[target_role] }}">
                {{ target_role }}
              </span>
            </td>

            <!-- Edit form -->
            <td class="px-3 py-2 align-top">
              {% if universities %}
                <form method="post" class="space-y-1">
                  <input type="hidden" name="user_id" value="{{ u.id }}"/>

                  <!-- University -->
                  <label class="block text-[10px] text-slate-300/80 mb-0.5">University</label>
                  <select
                    name="university_id"
                    class="w-full rounded-md border border-slate-600/70 bg-slate-950/80 px-2 py-1 text-[11px]
                           {% if cannot_edit %}opacity-40 cursor-not-allowed{% endif %}"
                    {% if cannot_edit %}disabled{% endif %}
                  >
                    {% if is_super_admin or is_ultra_admin %}
                      <option value="" {% if not u.university_id %}selected{% endif %}>(None)</option>
                      {% for uni in universities %}
                        <option value="{{ uni.id }}" {% if u.university_id == uni.id %}selected{% endif %}>
                          {{ uni.name }}
                        </option>
                      {% endfor %}
                    {% else %}
                      {% for uni in universities %}
                        <option value="{{ uni.id }}" {% if u.university_id == uni.id %}selected{% endif %}>
                          {{ uni.name }}
                        </option>
                      {% endfor %}
                    {% endif %}
                  </select>

                  <!-- Role -->
                  <label class="block text-[10px] text-slate-300/80 mt-1 mb-0.5">Role</label>
                  <select
                    name="role"
                    class="w-full rounded-md border border-slate-600/70 bg-slate-950/80 px-2 py-1 text-[11px]
                           {% if cannot_edit %}opacity-40 cursor-not-allowed{% endif %}"
                    {% if cannot_edit %}disabled{% endif %}
                  >
                    <option value="student" {% if target_role=='student' %}selected{% endif %}>Student</option>
                    <option value="university_admin" {% if target_role=='university_admin' %}selected{% endif %}>University admin</option>

                    {% if is_super_admin or is_ultra_admin %}
                      <option value="super_admin" {% if target_role=='super_admin' %}selected{% endif %}>Super admin</option>
                    {% endif %}
                    {% if is_ultra_admin %}
                      <option value="ultra_admin" {% if target_role=='ultra_admin' %}selected{% endif %}>Ultra admin</option>
                    {% endif %}
                  </select>

                  <!-- Save -->
                  <div class="flex justify-end pt-1">
                    {% if cannot_edit %}
                      <button type="button"
                        class="btn-secondary opacity-40 cursor-not-allowed text-[10px] px-3 py-1.5"
                        disabled>
                        Restricted
                      </button>
                    {% else %}
                      <button type="submit" class="btn-primary text-[10px] px-3 py-1.5">
                        Save
                      </button>
                    {% endif %}
                  </div>
                </form>
              {% else %}
                <p class="text-[10px] text-slate-500/80">
                  No universities available for assignment.
                </p>
              {% endif %}
            </td>

            <!-- Plan -->
            <td class="px-3 py-2 align-top text-[11px]">
              <div class="flex flex-col gap-0.5">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full border border-slate-600/70 bg-slate-950/70 text-[10px]">
                  {{ plan_raw | capitalize }}
                </span>
                {% if plan == 'pro' %}
                  <span class="text-[10px] text-emerald-300/80">
                    Active Pro
                  </span>
                {% elif plan == 'canceled' %}
                  <span class="text-[10px] text-slate-400/80">
                    Canceled / expired
                  </span>
                {% else %}
                  <span class="text-[10px] text-slate-400/80">
                    Free
                  </span>
                {% endif %}
              </div>
            </td>

            <!-- Balances -->
            <td class="px-3 py-2 align-top text-right text-[11px]">
              <div>
                ü™ô <span class="font-semibold">{{ u.coins_free or 0 }}</span>
                <span class="text-slate-400/70">Silver</span>
              </div>
              <div class="mt-0.5">
                ‚≠ê <span class="font-semibold">{{ u.coins_pro or 0 }}</span>
                <span class="text-slate-400/70">Gold</span>
              </div>
            </td>

            <!-- Joined -->
            <td class="px-3 py-2 align-top text-right text-[10px] text-slate-300/80">
              {{ u.created_at.strftime('%Y-%m-%d') if u.created_at }}
            </td>

            <!-- Actions -->
            <td class="px-3 py-2 align-top text-right text-[11px]">
              <div class="flex flex-col items-end gap-1.5">

                <!-- Credits link -->
                <a href="{{ url_for('admin.credits') }}?email={{ u.email | urlencode }}"
                   class="btn-ghost inline-flex justify-center text-[10px] px-2 py-1">
                  Credits ‚Üí
                </a>

                {% if is_super_admin or is_ultra_admin %}
                  <!-- Verification controls -->
                  <div class="flex flex-wrap justify-end gap-1 mt-0.5">
                    {% if u.verified %}
                      <form method="post" action="{{ url_for('admin.user_unverify', user_id=u.id) }}">
                        <button
                          type="submit"
                          class="inline-flex items-center px-2 py-0.5 rounded-full border border-amber-400/70 bg-amber-500/10 text-amber-100 text-[9px] hover:bg-amber-500/20"
                        >
                          Unverify
                        </button>
                      </form>
                    {% else %}
                      <form method="post" action="{{ url_for('admin.user_verify', user_id=u.id) }}">
                        <button
                          type="submit"
                          class="inline-flex items-center px-2 py-0.5 rounded-full border border-emerald-400/70 bg-emerald-500/10 text-emerald-100 text-[9px] hover:bg-emerald-500/20"
                        >
                          Mark as verified
                        </button>
                      </form>
                    {% endif %}
                  </div>

                  <!-- Pro plan controls -->
                  <div class="flex flex-wrap justify-end gap-1 mt-0.5">
                    {% if plan == 'pro' %}
                      <form method="post" action="{{ url_for('admin.user_revoke_pro', user_id=u.id) }}">
                        <button
                          type="submit"
                          class="inline-flex items-center px-2 py-0.5 rounded-full border border-rose-400/70 bg-rose-500/10 text-rose-100 text-[9px] hover:bg-rose-500/20"
                        >
                          Revoke Pro
                        </button>
                      </form>
                    {% else %}
                      <form method="post" action="{{ url_for('admin.user_grant_pro', user_id=u.id) }}">
                        <button
                          type="submit"
                          class="inline-flex items-center px-2 py-0.5 rounded-full border border-indigo-400/70 bg-indigo-500/10 text-indigo-100 text-[9px] hover:bg-indigo-500/20"
                        >
                          Grant Pro
                        </button>
                      </form>
                    {% endif %}
                  </div>
                {% endif %}

              </div>
            </td>

          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

  {% else %}
    <p class="text-[11px] text-slate-400/80">
      No users match this filter. Try clearing filters.
    </p>
  {% endif %}
</div>
{% endblock %}
