{# templates/admin/users.html #}
{% extends "admin/_layout.html" %}

{% block title %}Admin ¬∑ Users ¬∑ CareerAI{% endblock %}
{% set active_tab = 'users' %}

{% block admin_body %}
<div>

  <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
    <div>
      <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">
        Admin ¬∑ Users
      </h1>
      <p class="text-[11px] text-slate-300/80 mt-1">
        Manage roles, university assignments, and credit visibility.
        {% if not is_super_admin and not is_ultra_admin %}
          <span class="block mt-0.5 text-[10px] text-amber-300/80">
            You are a tenant-scoped admin. You can manage only users in your university.
          </span>
        {% endif %}
      </p>
    </div>
  </div>

  <!-- Filters / search -->
  <div class="glass-card rounded-2xl px-4 py-3 mb-4 text-[13px]">
    <form method="get" class="flex flex-col sm:flex-row gap-3 items-start sm:items-end">
      <div class="flex-1 w-full">
        <label class="block text-xs font-semibold mb-1 text-slate-200/90">
          Search (email or name)
        </label>
        <input
          type="text"
          name="q"
          value="{{ q or '' }}"
          placeholder="student@example.com"
          class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"
        />
      </div>
      <div class="w-full sm:w-40">
        <label class="block text-xs font-semibold mb-1 text-slate-200/90">
          Role
        </label>
        <select
          name="role"
          class="w-full rounded-lg border border-slate-500/70 bg-slate-950/60 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"
        >
          <option value="">All</option>
          <option value="student" {% if role_filter=='student' %}selected{% endif %}>Student</option>
          <option value="university_admin" {% if role_filter=='university_admin' %}selected{% endif %}>University admin</option>
          <option value="super_admin" {% if role_filter=='super_admin' %}selected{% endif %}>Super admin</option>
          <option value="ultra_admin" {% if role_filter=='ultra_admin' %}selected{% endif %}>Ultra admin</option>
        </select>
      </div>
      <div>
        <button type="submit" class="btn-primary text-xs">
          Apply filters
        </button>
      </div>
    </form>
    <p class="mt-2 text-[10px] text-slate-400/80">
      Showing up to 100 users. Use the search box to narrow down.
    </p>
  </div>

  {% if users %}
    <div class="glass-card rounded-2xl overflow-hidden text-[11px]">
      <table class="min-w-full">
        <thead class="bg-slate-900/80 text-slate-200/80 text-[10px] uppercase tracking-[0.16em]">
          <tr>
            <th class="px-3 py-2 text-left">User</th>
            <th class="px-3 py-2 text-left">Role</th>
            <th class="px-3 py-2 text-left">University &amp; Role edit</th>
            <th class="px-3 py-2 text-left">Plan</th>
            <th class="px-3 py-2 text-right">Balances</th>
            <th class="px-3 py-2 text-right">Joined</th>
            <th class="px-3 py-2 text-right">Actions</th>
          </tr>
        </thead>

        <tbody>
          {% for u in users %}

          {% set target_role = (u.role or 'student') %}
          {% set cannot_edit = false %}

          {# Rule: Super admin CANNOT touch ultra admin #}
          {% if target_role == 'ultra_admin' and not is_ultra_admin %}
            {% set cannot_edit = true %}
          {% endif %}

          {# Rule: University admins CANNOT modify any global admins #}
          {% if not is_super_admin and not is_ultra_admin and target_role in ['super_admin', 'ultra_admin'] %}
            {% set cannot_edit = true %}
          {% endif %}

          <tr class="border-t border-slate-700/60">
            <td class="px-3 py-2 align-top">
              <div class="font-semibold text-slate-50 text-[11px]">
                {{ u.email }}
                {% if current_user.id == u.id %}
                  <span class="ml-1 text-[9px] px-1.5 py-0.5 rounded-full bg-emerald-500/10 border border-emerald-400/60 text-emerald-200">
                    You
                  </span>
                {% endif %}
              </div>
              <div class="text-slate-300/80 mt-0.5">
                {{ u.name or "No name" }}
              </div>
              {% if u.university %}
                <div class="mt-0.5 text-[10px] text-slate-400">
                  {{ u.university.name }}
                </div>
              {% endif %}
            </td>

            <td class="px-3 py-2 align-top">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full border border-slate-500/60 text-[10px] text-slate-100 bg-slate-900/80">
                {{ u.role or "student" }}
              </span>
            </td>

            <td class="px-3 py-2 align-top">
              {% if universities %}
                <form method="post" class="space-y-1">
                  <input type="hidden" name="user_id" value="{{ u.id }}"/>

                  <label class="block text-[10px] text-slate-300/80 mb-0.5">
                    University
                  </label>
                  <select
                    name="university_id"
                    class="w-full rounded-md border border-slate-600/70 bg-slate-950/80 px-2 py-1 text-[11px]"
                    {% if cannot_edit %}disabled class="opacity-40 cursor-not-allowed"{% endif %}
                  >
                    {% if is_super_admin or is_ultra_admin %}
                      <option value="" {% if not u.university_id %}selected{% endif %}>(None)</option>
                      {% for uni in universities %}
                        <option value="{{ uni.id }}" {% if u.university_id == uni.id %}selected{% endif %}>
                          {{ uni.name }}
                        </option>
                      {% endfor %}
                    {% else %}
                      {% for uni in universities %}
                        <option value="{{ uni.id }}" {% if u.university_id == uni.id %}selected{% endif %}>
                          {{ uni.name }}
                        </option>
                      {% endfor %}
                    {% endif %}
                  </select>

                  <label class="block text-[10px] text-slate-300/80 mt-1 mb-0.5">
                    Role
                  </label>
                  <select
                    name="role"
                    class="w-full rounded-md border border-slate-600/70 bg-slate-950/80 px-2 py-1 text-[11px]"
                    {% if cannot_edit %}disabled class="opacity-40 cursor-not-allowed"{% endif %}
                  >
                    <option value="student" {% if target_role=='student' %}selected{% endif %}>Student</option>
                    <option value="university_admin" {% if target_role=='university_admin' %}selected{% endif %}>University admin</option>

                    {% if is_super_admin or is_ultra_admin %}
                      <option value="super_admin" {% if target_role=='super_admin' %}selected{% endif %}>Super admin</option>
                    {% endif %}

                    {% if is_ultra_admin %}
                      <option value="ultra_admin" {% if target_role=='ultra_admin' %}selected{% endif %}>Ultra admin</option>
                    {% endif %}
                  </select>

                  <div class="flex justify-end pt-1">
                    {% if cannot_edit %}
                      <button type="button"
                        class="btn-secondary opacity-40 cursor-not-allowed text-[10px] px-3 py-1.5"
                        disabled>
                        Restricted
                      </button>
                    {% else %}
                      <button type="submit" class="btn-primary text-[10px] px-3 py-1.5">
                        Save
                      </button>
                    {% endif %}
                  </div>
                </form>
              {% else %}
                <p class="text-[10px] text-slate-500/80">
                  No universities available for assignment.
                </p>
              {% endif %}
            </td>

            <td class="px-3 py-2 align-top text-[11px]">
              {{ (u.subscription_status or "free") | capitalize }}
            </td>

            <td class="px-3 py-2 align-top text-right text-[11px]">
              <div>
                ü™ô <span class="font-semibold">{{ u.coins_free or 0 }}</span>
                <span class="text-slate-400/70">Silver</span>
              </div>
              <div class="mt-0.5">
                ‚≠ê <span class="font-semibold">{{ u.coins_pro or 0 }}</span>
                <span class="text-slate-400/70">Gold</span>
              </div>
            </td>

            <td class="px-3 py-2 align-top text-right text-[10px] text-slate-300/80">
              {% if u.created_at %}{{ u.created_at.strftime('%Y-%m-%d') }}{% endif %}
            </td>

            <td class="px-3 py-2 align-top text-right text-[11px]">
              <a href="{{ url_for('admin.credits') }}?email={{ u.email | urlencode }}"
                 class="btn-ghost inline-flex justify-center text-[10px] px-2 py-1">
                Credits ‚Üí
              </a>
            </td>

          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  {% else %}
    <p class="text-[11px] text-slate-400/80">
      No users match this filter yet. Try clearing filters.
    </p>
  {% endif %}
</div>
{% endblock %}
