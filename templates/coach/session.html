{% extends "base.html" %}
{% block title %}Weekly Coach — Focus Session{% endblock %}

{% block content %}
{% set path_type = (path_type or 'job') %}
{% set phase_label = phase_label|default('Phase 1 · Foundation', true) %}
{% set week_label = week_label|default('Week 1', true) %}
{% set session_scope_label = session_scope_label|default('This week', true) %}

<section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 mb-16 space-y-6 text-white">

  <!-- HEADER -->
  <header class="glass-card rounded-2xl p-6 sm:p-7 border border-white/10 shadow-xl relative overflow-hidden">
    <!-- Gradient overlay pushed behind everything so it never blocks navbar -->
    <div class="pointer-events-none absolute inset-0 opacity-60 -z-10">
      <div class="w-full h-full bg-[radial-gradient(circle_at_top_left,rgba(129,140,248,0.25),transparent_55%),radial-gradient(circle_at_bottom_right,rgba(16,185,129,0.24),transparent_55%)]"></div>
    </div>

    <div class="relative flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div class="space-y-2">
        <div class="inline-flex flex-wrap items-center gap-2 text-[11px] uppercase tracking-[0.16em] text-white/65">
          <span class="px-2 py-0.5 rounded-full bg-black/30 border border-white/15 inline-flex items-center gap-1">
            <i data-lucide="calendar-check" class="w-3.5 h-3.5"></i>
            <span>Weekly Coach</span>
          </span>
          <span class="px-2 py-0.5 rounded-full bg-black/20 border border-white/10">
            {% if path_type == 'startup' %}Startup{% else %}Job{% endif %} path · {{ phase_label }}
          </span>
          <span class="hidden sm:inline px-2 py-0.5 rounded-full bg-black/20 border border-white/10">
            {{ week_label }}
          </span>
        </div>

        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">
          This week’s focus
        </h1>

        <p class="text-sm sm:text-base text-white/80 max-w-xl leading-relaxed">
          This is your <span class="font-semibold">execution view</span> for {{ session_scope_label|lower }} —
          a set of realistic, weekly-sized moves drawn from your Dream Plan. Treat this as your
          main checklist and use the timer below for deep work blocks.
        </p>

        {% if plan_title %}
          <p class="text-xs text-white/70">
            Plan: <span class="font-semibold">{{ plan_title }}</span>
          </p>
        {% endif %}
      </div>

      <div class="space-y-2 text-xs text-right">
        {% if streak_count %}
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/40 border border-white/20">
            <i data-lucide="flame" class="w-3.5 h-3.5"></i>
            <span>Streak:</span>
            <span class="font-semibold">{{ streak_count }} week{{ '' if streak_count == 1 else 's' }}</span>
          </div>
        {% endif %}
        {% if session_date %}
          <p class="text-[11px] text-white/65">
            Session created on {{ session_date }}
          </p>
        {% endif %}
        <div>
          <a href="{{ url_for('coach.index', path_type=path_type) }}"
             class="inline-flex items-center gap-1 text-[11px] text-white/70 hover:text-white underline-offset-2 hover:underline">
            <i data-lucide="arrow-left" class="w-3 h-3"></i>
            Back to Coach overview
          </a>
        </div>
      </div>
    </div>
  </header>

  {% if not tasks %}
    <div class="glass-card rounded-2xl p-6 border border-white/10 text-center text-sm text-white/70">
      No tasks were generated for this session yet. <br>
      This screen will show your weekly checklist once a Coach session is active.
      <div class="mt-3">
        <a href="{{ url_for('coach.index', path_type=path_type) }}" class="btn-primary inline-flex items-center gap-1 px-4 py-2">
          <i data-lucide="arrow-left" class="w-4 h-4"></i>
          <span>Back to Coach</span>
        </a>
      </div>
    </div>
  {% else %}

    {# ====== MULTI-WEEK ROADMAP RAIL (SESSION VIEW) ====== #}
    {% set total_weeks = 12 %}
    {% set active_week = (day_index or 1) %}
    {% if active_week < 1 %}{% set active_week = 1 %}{% endif %}
    {% if active_week > total_weeks %}{% set active_week = total_weeks %}{% endif %}

    {# If week is closed, visually "unlock" the next one; backend still enforces actual gating #}
    {% if session_is_closed %}
      {% set unlocked_through = active_week + 1 %}
    {% else %}
      {% set unlocked_through = active_week %}
    {% endif %}
    {% if unlocked_through > total_weeks %}{% set unlocked_through = total_weeks %}{% endif %}

    <section class="glass-card rounded-2xl p-4 sm:p-5 border border-white/10 space-y-3">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div class="space-y-1">
          <p class="text-[11px] uppercase tracking-[0.16em] text-white/55 flex items-center gap-1.5">
            <i data-lucide="radar" class="w-3.5 h-3.5"></i>
            <span>Weekly roadmap</span>
          </p>
          <p class="text-xs sm:text-sm text-white/80">
            You are on
            <span class="font-semibold">Week {{ active_week }}</span>
            inside your 3-phase Dream Plan.
            {% if session_is_closed %}
              This week is <span class="font-semibold text-emerald-300">marked as done</span> — the next week is unlocked on the main Coach page.
            {% else %}
              Close this week when you’ve honestly done what you could.
            {% endif %}
          </p>
        </div>

        <div class="flex flex-wrap items-center gap-3 text-[11px] text-white/60">
          <div class="inline-flex items-center gap-1">
            <i data-lucide="sparkles" class="w-3.5 h-3.5"></i>
            <span>Active</span>
          </div>
          <div class="inline-flex items-center gap-1">
            <i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i>
            <span>Completed</span>
          </div>
          <div class="inline-flex items-center gap-1">
            <i data-lucide="circle-dot" class="w-3.5 h-3.5"></i>
            <span>Next up</span>
          </div>
          <div class="inline-flex items-center gap-1">
            <i data-lucide="lock" class="w-3.5 h-3.5"></i>
            <span>Locked</span>
          </div>
        </div>
      </div>

      <div class="mt-2 flex flex-col gap-2 text-[11px]">
        <div class="flex items-center justify-between text-white/55">
          <span class="flex items-center gap-1">
            <i data-lucide="layers" class="w-3.5 h-3.5"></i>
            <span>Phase 1 · Weeks 1–4</span>
          </span>
          <span>Foundation</span>
        </div>
        <div class="flex items-center gap-1 overflow-x-auto pb-1">
          {% for week in range(1, 5) %}
            {% set status = 'locked' %}
            {% if week < active_week %}
              {% set status = 'completed' %}
            {% elif week == active_week %}
              {% set status = 'active' %}
            {% elif week == active_week + 1 and week <= unlocked_through %}
              {% set status = 'next' %}
            {% elif week <= unlocked_through %}
              {% set status = 'unlocked' %}
            {% endif %}

            <div class="flex flex-col items-center gap-0.5 min-w-[56px]">
              <div
                class="
                  flex items-center justify-center rounded-full border
                  {% if status == 'active' %}
                    w-9 h-9 border-emerald-300/80 bg-emerald-500/20 shadow-lg shadow-emerald-500/30
                  {% elif status == 'completed' %}
                    w-8 h-8 border-emerald-400/70 bg-emerald-500/15
                  {% elif status == 'next' %}
                    w-8 h-8 border-white/60 bg-black/40
                  {% elif status == 'unlocked' %}
                    w-7 h-7 border-white/40 bg-black/40
                  {% else %}
                    w-7 h-7 border-white/20 bg-black/20 opacity-50
                  {% endif %}
                "
              >
                {% if status == 'active' %}
                  <i data-lucide="sparkles" class="w-4 h-4"></i>
                {% elif status == 'completed' %}
                  <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                {% elif status == 'next' %}
                  <i data-lucide="circle-dot" class="w-4 h-4"></i>
                {% elif status == 'unlocked' %}
                  <i data-lucide="circle" class="w-3.5 h-3.5"></i>
                {% else %}
                  <i data-lucide="lock" class="w-3.5 h-3.5"></i>
                {% endif %}
              </div>
              <span
                class="
                  mt-0.5
                  {% if status == 'active' %}
                    text-emerald-200 font-semibold
                  {% elif status == 'completed' %}
                    text-emerald-200
                  {% elif status == 'locked' %}
                    text-white/45
                  {% else %}
                    text-white/75
                  {% endif %}
                "
              >
                W{{ week }}
              </span>
            </div>
          {% endfor %}
        </div>

        <div class="flex items-center justify-between text-white/55 mt-2">
          <span class="flex items-center gap-1">
            <i data-lucide="cpu" class="w-3.5 h-3.5"></i>
            <span>Phase 2 · Weeks 5–8</span>
          </span>
          <span>Projects & depth</span>
        </div>
        <div class="flex items-center gap-1 overflow-x-auto pb-1">
          {% for week in range(5, 9) %}
            {% set status = 'locked' %}
            {% if week < active_week %}
              {% set status = 'completed' %}
            {% elif week == active_week %}
              {% set status = 'active' %}
            {% elif week == active_week + 1 and week <= unlocked_through %}
              {% set status = 'next' %}
            {% elif week <= unlocked_through %}
              {% set status = 'unlocked' %}
            {% endif %}

            <div class="flex flex-col items-center gap-0.5 min-w-[56px]">
              <div
                class="
                  flex items-center justify-center rounded-full border
                  {% if status == 'active' %}
                    w-9 h-9 border-emerald-300/80 bg-emerald-500/20 shadow-lg shadow-emerald-500/30
                  {% elif status == 'completed' %}
                    w-8 h-8 border-emerald-400/70 bg-emerald-500/15
                  {% elif status == 'next' %}
                    w-8 h-8 border-white/60 bg-black/40
                  {% elif status == 'unlocked' %}
                    w-7 h-7 border-white/40 bg-black/40
                  {% else %}
                    w-7 h-7 border-white/20 bg-black/20 opacity-50
                  {% endif %}
                "
              >
                {% if status == 'active' %}
                  <i data-lucide="sparkles" class="w-4 h-4"></i>
                {% elif status == 'completed' %}
                  <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                {% elif status == 'next' %}
                  <i data-lucide="circle-dot" class="w-4 h-4"></i>
                {% elif status == 'unlocked' %}
                  <i data-lucide="circle" class="w-3.5 h-3.5"></i>
                {% else %}
                  <i data-lucide="lock" class="w-3.5 h-3.5"></i>
                {% endif %}
              </div>
              <span
                class="
                  mt-0.5
                  {% if status == 'active' %}
                    text-emerald-200 font-semibold
                  {% elif status == 'completed' %}
                    text-emerald-200
                  {% elif status == 'locked' %}
                    text-white/45
                  {% else %}
                    text-white/75
                  {% endif %}
                "
              >
                W{{ week }}
              </span>
            </div>
          {% endfor %}
        </div>

        <div class="flex items-center justify-between text-white/55 mt-2">
          <span class="flex items-center gap-1">
            <i data-lucide="send" class="w-3.5 h-3.5"></i>
            <span>Phase 3 · Weeks 9–12</span>
          </span>
          <span>Showcase & applications</span>
        </div>
        <div class="flex items-center gap-1 overflow-x-auto pb-1">
          {% for week in range(9, total_weeks + 1) %}
            {% set status = 'locked' %}
            {% if week < active_week %}
              {% set status = 'completed' %}
            {% elif week == active_week %}
              {% set status = 'active' %}
            {% elif week == active_week + 1 and week <= unlocked_through %}
              {% set status = 'next' %}
            {% elif week <= unlocked_through %}
              {% set status = 'unlocked' %}
            {% endif %}

            <div class="flex flex-col items-center gap-0.5 min-w-[56px]">
              <div
                class="
                  flex items-center justify-center rounded-full border
                  {% if status == 'active' %}
                    w-9 h-9 border-emerald-300/80 bg-emerald-500/20 shadow-lg shadow-emerald-500/30
                  {% elif status == 'completed' %}
                    w-8 h-8 border-emerald-400/70 bg-emerald-500/15
                  {% elif status == 'next' %}
                    w-8 h-8 border-white/60 bg-black/40
                  {% elif status == 'unlocked' %}
                    w-7 h-7 border-white/40 bg-black/40
                  {% else %}
                    w-7 h-7 border-white/20 bg-black/20 opacity-50
                  {% endif %}
                "
              >
                {% if status == 'active' %}
                  <i data-lucide="sparkles" class="w-4 h-4"></i>
                {% elif status == 'completed' %}
                  <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                {% elif status == 'next' %}
                  <i data-lucide="circle-dot" class="w-4 h-4"></i>
                {% elif status == 'unlocked' %}
                  <i data-lucide="circle" class="w-3.5 h-3.5"></i>
                {% else %}
                  <i data-lucide="lock" class="w-3.5 h-3.5"></i>
                {% endif %}
              </div>
              <span
                class="
                  mt-0.5
                  {% if status == 'active' %}
                    text-emerald-200 font-semibold
                  {% elif status == 'completed' %}
                    text-emerald-200
                  {% elif status == 'locked' %}
                    text-white/45
                  {% else %}
                    text-white/75
                  {% endif %}
                "
              >
                W{{ week }}
              </span>
            </div>
          {% endfor %}
        </div>
      </div>

      <p class="text-[11px] text-white/55 mt-1">
        The roadmap above is a visual guide. Actual unlocking of new weeks still happens on the main Weekly Coach page
        when you start the next focus pack.
      </p>
    </section>

    {% if ai_note %}
      <section class="glass-card rounded-2xl p-4 sm:p-5 border border-emerald-400/40 bg-emerald-900/20 space-y-2">
        <h2 class="text-sm sm:text-base font-semibold flex items-center gap-1.5">
          <i data-lucide="messages-square" class="w-4 h-4"></i>
          <span>Coach note for this week</span>
        </h2>
        <p class="text-sm sm:text-base text-white/85 leading-relaxed">
          {{ ai_note }}
        </p>
        <p class="text-[11px] text-white/60">
          Re-read this whenever you feel lost. It’s your <span class="font-semibold">anchor</span> for the current phase.
        </p>
      </section>
    {% endif %}

    <!-- TASK LIST -->
    <section class="glass-card rounded-2xl p-5 sm:p-6 border border-white/10 space-y-4">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
        <div>
          <h2 class="text-lg sm:text-xl font-semibold flex items-center gap-1.5">
            <i data-lucide="check-square" class="w-4 h-4"></i>
            <span>This week’s checklist</span>
          </h2>
          <p class="text-[11px] text-white/60 mt-1 max-w-md">
            These are <span class="font-semibold">weekly-sized</span> tasks. It’s okay if you don’t finish all of them —
            aim for honest, visible progress.
          </p>
        </div>

        {% if day_index is defined and day_index is not none %}
          <div class="text-[11px] text-white/65 text-left sm:text-right space-y-1">
            <p>
              Week <span class="font-semibold">{{ day_index }}</span> inside your 3-phase roadmap.
            </p>
            <p class="text-white/50">
              Try to complete at least 60–70% before starting the next week’s pack.
            </p>
          </div>
        {% endif %}
      </div>

      {# Small phase rail #}
      <div class="mt-1 rounded-xl bg-black/30 border border-white/10 p-3 text-[11px] flex flex-wrap items-center justify-between gap-3">
        <div class="flex flex-wrap items-center gap-2">
          <span class="uppercase tracking-[0.18em] text-white/55 flex items-center gap-1">
            <i data-lucide="map" class="w-3.5 h-3.5"></i>
            <span>Phase rail</span>
          </span>
          <span class="px-2 py-0.5 rounded-full bg-white/5 border border-white/20">
            {{ phase_label }}
          </span>
          <span class="px-2 py-0.5 rounded-full bg-white/5 border border-white/20">
            {{ week_label }}
          </span>
        </div>
        <p class="text-white/55">
          Finish this week, then come back to Weekly Coach to unlock your next focus pack.
        </p>
      </div>

      {% set total = tasks|length %}
      {% set done = (tasks | selectattr('is_done') | list | length) if tasks else 0 %}
      {% set pct = (done * 100 // total) if total > 0 else 0 %}
      <div class="space-y-1 mt-3">
        <div class="flex items-center justify-between text-[11px] text-white/65">
          <span>Weekly progress</span>
          <span>{{ done }}/{{ total }} tasks · {{ pct }}%</span>
        </div>
        <div class="w-full h-2 rounded-full bg-black/40 overflow-hidden">
          <div class="h-2 rounded-full bg-emerald-400" style="width: {{ pct }}%;"></div>
        </div>
      </div>

      <form method="POST" action="{{ url_for('coach.update_session', session_id=session_id) }}">
        <input type="hidden" name="session_id" value="{{ session_id }}">

        <ul class="mt-4 space-y-3">
          {% for t in tasks %}
            {% set est = t.suggested_minutes if t.suggested_minutes is not none else None %}
            <li class="flex items-start gap-3 text-sm sm:text-base">
              <label class="flex items-start gap-3 w-full cursor-pointer">
                <input
                  type="checkbox"
                  name="task_{{ t.id }}"
                  value="done"
                  class="mt-1 w-4 h-4 rounded border-white/30 bg-black/40"
                  {% if t.is_done %}checked{% endif %}
                >
                <div class="flex-1 space-y-1.5">
                  <div class="flex items-center justify-between gap-2">
                    <p class="leading-snug {% if t.is_done %}line-through text-white/60{% else %}text-white/90{% endif %}">
                      {{ t.title }}
                    </p>
                    <div class="flex items-center gap-1 flex-wrap justify-end">
                      {% if est %}
                        <span class="px-2 py-0.5 rounded-full text-[10px] bg-emerald-500/10 border border-emerald-300/60 text-emerald-100 inline-flex items-center gap-1">
                          <i data-lucide="clock-3" class="w-3 h-3"></i>
                          <span>{{ est }} min</span>
                        </span>
                      {% endif %}
                      {% if t.category %}
                        <span class="px-2 py-0.5 rounded-full text-[10px] bg-white/5 border border-white/20">
                          {{ t.category }}
                        </span>
                      {% endif %}
                    </div>
                  </div>

                  {% if t.detail %}
                    <p class="text-[11px] sm:text-xs text-white/70 leading-snug">
                      {{ t.detail }}
                    </p>
                  {% endif %}

                  {% if t.milestone_title or t.milestone_step %}
                    <p class="mt-1 text-[11px] sm:text-xs text-emerald-200/85 flex items-center gap-1.5">
                      <i data-lucide="flag" class="w-3.5 h-3.5"></i>
                      <span>
                        {% if t.milestone_title %}
                          <span class="font-semibold">{{ t.milestone_title }}</span>
                        {% endif %}
                        {% if t.milestone_step %}
                          {% if t.milestone_title %} · {% endif %}
                          <span>{{ t.milestone_step }}</span>
                        {% endif %}
                      </span>
                    </p>
                  {% endif %}

                  {% if t.guide %}
                    <div class="mt-1 p-2 rounded-lg bg-white/5 border border-white/10 text-[11px] sm:text-xs text-white/70">
                      {{ t.guide }}
                    </div>
                  {% endif %}

                  {% if t.tags %}
                    <div class="mt-1 flex flex-wrap gap-1.5">
                      {% for tag in t.tags %}
                        <span class="px-2 py-0.5 rounded-full bg-black/40 border border-white/15 text-[10px] text-white/75">
                          {{ tag }}
                        </span>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </label>
            </li>
          {% endfor %}
        </ul>

        <div class="mt-5 flex flex-col sm:flex-row sm:items-center justify-between gap-3 text-xs">
          <p class="text-white/65">
            Check off what you actually completed this week. Even if you only move 2–3 tasks forward,
            you’ve moved your whole roadmap forward — that’s what matters.
          </p>
          <div class="flex flex-wrap gap-2 justify-end">
            <button
              type="submit"
              class="inline-flex items-center justify-center gap-1 px-4 py-2 rounded-full border border-white/25 bg-white/5 hover:bg-white/10"
            >
              <i data-lucide="save" class="w-4 h-4"></i>
              <span>Save progress</span>
            </button>
            <button
              type="submit"
              name="mark_done"
              value="1"
              class="btn-primary inline-flex items-center justify-center gap-1 px-4 py-2"
            >
              <i data-lucide="check-circle-2" class="w-4 h-4"></i>
              <span>Save & mark week done</span>
            </button>
          </div>
        </div>
      </form>
    </section>

    <!-- FOCUS TIMER -->
    <section class="glass-card rounded-2xl p-5 border border-white/10 space-y-3">
      <h2 class="text-sm font-semibold flex items-center gap-1.5">
        <i data-lucide="timer" class="w-4 h-4"></i>
        <span>Focus timer & wellbeing coach</span>
      </h2>
      <p class="text-xs text-white/70">
        Pick a focus block and a break. Start the timer when you begin deep work on any task above.
        During breaks, actually step away — that’s when your brain consolidates what you just did.
      </p>

      <div class="grid sm:grid-cols-3 gap-4 text-xs">
        <div class="space-y-2">
          <p class="font-semibold">Focus duration</p>
          <div class="flex items-center gap-2">
            <div>
              <label class="block text-[11px] text-white/60">Hours</label>
              <input
                id="focusHours"
                type="number"
                min="0"
                max="8"
                value="0"
                class="w-16 rounded-lg bg-black/40 border border-white/25 px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-400"
              >
            </div>
            <div>
              <label class="block text-[11px] text-white/60">Minutes</label>
              <input
                id="focusMinutes"
                type="number"
                min="5"
                max="180"
                value="45"
                class="w-16 rounded-lg bg-black/40 border border-white/25 px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-400"
              >
            </div>
          </div>
        </div>

        <div class="space-y-2">
          <p class="font-semibold">Break duration</p>
          <div>
            <label class="block text-[11px] text-white/60">Minutes</label>
            <input
              id="breakMinutes"
              type="number"
              min="3"
              max="30"
              value="10"
              class="w-20 rounded-lg bg-black/40 border border-white/25 px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-400"
            >
          </div>
        </div>

        <div class="space-y-2">
          <p class="font-semibold">Controls</p>
          <div class="flex flex-wrap gap-2">
            <button
              id="timerStart"
              type="button"
              class="btn-primary inline-flex items-center gap-1 px-3 py-1.5 text-[11px]"
            >
              <i data-lucide="play" class="w-3.5 h-3.5"></i>
              <span>Start</span>
            </button>
            <button
              id="timerPause"
              type="button"
              class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full border border-white/25 bg-white/5 hover:bg-white/10 text-[11px]"
            >
              <i data-lucide="pause" class="w-3.5 h-3.5"></i>
              <span>Pause</span>
            </button>
            <button
              id="timerReset"
              type="button"
              class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full border border-white/25 bg-white/5 hover:bg-white/10 text-[11px]"
            >
              <i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i>
              <span>Reset</span>
            </button>
          </div>
        </div>
      </div>

      <div class="mt-4 grid sm:grid-cols-2 gap-4 items-center">
        <div class="space-y-1 text-center sm:text-left">
          <p id="timerPhase" class="text-xs text-white/60 uppercase tracking-[0.16em]">
            FOCUS PHASE
          </p>
          <p id="timerDisplay" class="text-3xl sm:text-4xl font-mono font-semibold">
            45:00
          </p>
        </div>
        <div class="text-xs text-white/75">
          <p class="font-semibold mb-1">Coach note for this phase</p>
          <p id="timerMessage">
            Set your phone away, close extra tabs, and give this block your full attention.
            Even 25–45 minutes of deep work beats 3 hours of half-focus.
          </p>
        </div>
      </div>
    </section>

    <!-- REFLECTION / NOTES -->
    <section class="glass-card rounded-2xl p-5 border border-white/10 space-y-3">
      <h2 class="text-sm font-semibold flex items-center gap-1.5">
        <i data-lucide="notebook-pen" class="w-4 h-4"></i>
        <span>Quick reflection</span>
      </h2>
      <p class="text-xs text-white/70">
        Spend 1–2 minutes writing what went well and what felt hard. This helps the coach adapt
        future weeks and helps <span class="font-semibold">you</span> notice your own patterns.
      </p>

      <form method="POST" action="{{ url_for('coach.reflect', session_id=session_id) }}">
        <input type="hidden" name="session_id" value="{{ session_id }}">
        <textarea
          name="reflection"
          rows="3"
          class="w-full mt-2 rounded-xl bg-black/40 border border-white/20 text-xs p-3 focus:outline-none focus:ring-1 focus:ring-emerald-400"
          placeholder="Example: Finished SQL tasks, but interview questions felt hard. Need more time for mock interviews."
        >{{ reflection or '' }}</textarea>

        <div class="mt-3 flex items-center justify-between gap-3 text-[11px] text-white/60">
          <span>Reflections will help future versions of Weekly Coach adapt your tasks and suggestions.</span>
          <button
            type="submit"
            class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full border border-white/25 bg-white/5 hover:bg-white/10"
          >
            <i data-lucide="pen" class="w-3.5 h-3.5"></i>
            <span>Save note</span>
          </button>
        </div>
      </form>
    </section>

    <!-- NAV + NEXT WEEK CTA -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 text-xs text-white/70">
      <div class="flex flex-wrap items-center gap-3">
        <a href="{{ url_for('coach.index', path_type=path_type) }}" class="inline-flex items-center gap-1 underline hover:text-white">
          <i data-lucide="timer-reset" class="w-3.5 h-3.5"></i>
          <span>Back to Coach</span>
        </a>
        <a href="{{ url_for('dream.index', path_type=path_type) }}" class="inline-flex items-center gap-1 underline hover:text-white">
          <i data-lucide="sparkles" class="w-3.5 h-3.5"></i>
          <span>Dream Planner</span>
        </a>
        {% if feature_paths is defined and feature_paths.skillmapper %}
          <a href="{{ feature_paths.skillmapper }}" class="inline-flex items-center gap-1 underline hover:text-white">
            <i data-lucide="route" class="w-3.5 h-3.5"></i>
            <span>Skill Mapper</span>
          </a>
        {% endif %}
      </div>

      {% if session_is_closed %}
        <form method="POST" action="{{ url_for('coach.start') }}" class="flex-shrink-0">
          <input type="hidden" name="path_type" value="{{ path_type }}">
          <button
            class="btn-primary inline-flex items-center gap-1 px-4 py-2"
          >
            <i data-lucide="fast-forward" class="w-3.5 h-3.5"></i>
            <span>Start next week’s focus pack</span>
          </button>
        </form>
      {% endif %}
    </div>

  {% endif %}

</section>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    if (window.lucide) {
      window.lucide.createIcons();
    }

    const focusHoursInput   = document.getElementById('focusHours');
    const focusMinutesInput = document.getElementById('focusMinutes');
    const breakMinutesInput = document.getElementById('breakMinutes');

    const timerDisplay = document.getElementById('timerDisplay');
    const timerPhase   = document.getElementById('timerPhase');
    const timerMessage = document.getElementById('timerMessage');

    const btnStart = document.getElementById('timerStart');
    const btnPause = document.getElementById('timerPause');
    const btnReset = document.getElementById('timerReset');

    if (!focusHoursInput || !focusMinutesInput || !breakMinutesInput ||
        !timerDisplay || !timerPhase || !timerMessage ||
        !btnStart || !btnPause || !btnReset) {
      return;
    }

    let timerId          = null;
    let remainingSeconds = 0;
    let phase            = 'focus';
    let isRunning        = false;

    const focusMessages = [
      "Set your phone away, close extra tabs, and give this block your full attention.",
      "You don’t need to be perfect, just present. One small chunk at a time.",
      "If your brain resists, that’s normal. Gently bring it back to the task.",
      "Imagine explaining this topic to a junior. Study as if you’ll teach it."
    ];

    const breakMessages = [
      "Stand up, stretch, drink some water. Your brain is doing background work.",
      "Try a few deep breaths. In for 4, hold for 4, out for 6.",
      "Look away from the screen for 30 seconds. Relax your eyes and shoulders.",
      "You’re allowed to rest. Good rest makes good focus possible."
    ];

    function pickRandom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function formatTime(seconds) {
      const m  = Math.floor(seconds / 60);
      const s  = seconds % 60;
      const mm = String(m).padStart(2, '0');
      const ss = String(s).padStart(2, '0');
      return `${mm}:${ss}`;
    }

    function setPhase(newPhase) {
      phase = newPhase;
      if (phase === 'focus') {
        timerPhase.textContent   = 'FOCUS PHASE';
        timerMessage.textContent = pickRandom(focusMessages);
      } else {
        timerPhase.textContent   = 'BREAK PHASE';
        timerMessage.textContent = pickRandom(breakMessages);
      }
    }

    function initFromInputs() {
      const h = parseInt(focusHoursInput.value || '0', 10);
      const m = parseInt(focusMinutesInput.value || '0', 10);
      const total = (isNaN(h) ? 0 : h) * 3600 + (isNaN(m) ? 0 : m) * 60;
      remainingSeconds = total > 0 ? total : 25 * 60;
      setPhase('focus');
      timerDisplay.textContent = formatTime(remainingSeconds);
    }

    function startTimer() {
      if (isRunning) return;
      if (!remainingSeconds) {
        initFromInputs();
      }
      isRunning = true;
      timerId = setInterval(() => {
        if (remainingSeconds > 0) {
          remainingSeconds -= 1;
          timerDisplay.textContent = formatTime(remainingSeconds);
        } else {
          if (phase === 'focus') {
            const breakM = parseInt(breakMinutesInput.value || '5', 10);
            const brSecs = (isNaN(breakM) ? 5 : breakM) * 60;
            remainingSeconds = brSecs > 0 ? brSecs : 300;
            setPhase('break');
            timerDisplay.textContent = formatTime(remainingSeconds);
          } else {
            clearInterval(timerId);
            timerId   = null;
            isRunning = false;
            initFromInputs();
          }
        }
      }, 1000);
    }

    function pauseTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      isRunning = false;
    }

    function resetTimer() {
      pauseTimer();
      initFromInputs();
    }

    initFromInputs();

    btnStart.addEventListener('click', startTimer);
    btnPause.addEventListener('click', pauseTimer);
    btnReset.addEventListener('click', resetTimer);

    focusHoursInput.addEventListener('change', () => {
      if (!isRunning) initFromInputs();
    });
    focusMinutesInput.addEventListener('change', () => {
      if (!isRunning) initFromInputs();
    });
  });
</script>
{% endblock %}
