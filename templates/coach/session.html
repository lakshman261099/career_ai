{% extends "base.html" %}
{% block title %}Weekly Coach â€” Focus Session{% endblock %}

{% block content %}
{% set path_type = (path_type or 'job') %}
{% set phase_label = phase_label|default('Phase 1 Â· Foundation', true) %}
{% set week_label = week_label|default('Week 1', true) %}
{% set session_scope_label = session_scope_label|default('This week', true) %}

{# Server should pass this, but default safely #}
{% set session_locked = session_locked|default(false, true) %}
{% set current_week_index = current_week_index|default(None, true) %}
{% set min_chars = min_chars|default(120, true) %}

{% if session and session.id %}
  {% set session_id = session.id %}
{% endif %}

<style>
  @keyframes coachStreakPop {
    0%   { transform: scale(0.95); opacity: 0; }
    25%  { transform: scale(1.05); opacity: 1; }
    100% { transform: scale(1.0); opacity: 0; }
  }
  .coach-streak-pop { animation: coachStreakPop 0.9s ease-out forwards; }

  @keyframes coachToastIn {
    0% { transform: translateY(8px); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
  }
  .coach-toast { animation: coachToastIn .18s ease-out forwards; }
</style>

<section class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 mb-16 space-y-6 text-white">

  <!-- HEADER -->
  <header class="glass-card rounded-2xl p-6 sm:p-7 border border-white/10 shadow-xl relative overflow-hidden">
    <div class="pointer-events-none absolute inset-0 opacity-60 -z-10">
      <div class="w-full h-full bg-[radial-gradient(circle_at_top_left,rgba(129,140,248,0.25),transparent_55%),radial-gradient(circle_at_bottom_right,rgba(16,185,129,0.24),transparent_55%)]"></div>
    </div>

    <div class="relative flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div class="space-y-2">
        <div class="inline-flex flex-wrap items-center gap-2 text-[11px] uppercase tracking-[0.16em] text-white/65">
          <span class="px-2 py-0.5 rounded-full bg-black/30 border border-white/15 inline-flex items-center gap-1">
            <i data-lucide="calendar-check" class="w-3.5 h-3.5"></i>
            <span>Weekly Coach</span>
          </span>
          <span class="px-2 py-0.5 rounded-full bg-black/20 border border-white/10">
            {% if path_type == 'startup' %}Startup{% else %}Job{% endif %} path Â· {{ phase_label }}
          </span>
          <span class="hidden sm:inline px-2 py-0.5 rounded-full bg-black/20 border border-white/10">
            {{ week_label }}
          </span>

          {% if session_locked %}
            <span class="px-2 py-0.5 rounded-full bg-amber-500/15 border border-amber-300/40 text-amber-100 inline-flex items-center gap-1">
              <i data-lucide="lock" class="w-3.5 h-3.5"></i>
              <span>Locked</span>
            </span>
          {% endif %}
        </div>

        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">
          This weekâ€™s focus
        </h1>

        <p class="text-sm sm:text-base text-white/80 max-w-2xl leading-relaxed">
          Execution view for {{ session_scope_label|lower }} â€” weekly-sized moves pulled from your Dream Plan.
          Weekly tasks require a DevLog (proof-of-work). Daily tasks can be ticked normally.
        </p>

        {% if plan_title %}
          <p class="text-xs text-white/70">
            Plan: <span class="font-semibold">{{ plan_title }}</span>
          </p>
        {% endif %}
      </div>

      <div class="space-y-2 text-xs text-right">
        {% if streak_count %}
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/40 border border-white/20">
            <i data-lucide="flame" class="w-3.5 h-3.5"></i>
            <span>Streak:</span>
            <span class="font-semibold">
              <span id="coach-streak-value" data-streak="{{ streak_count }}">{{ streak_count }}</span>
              day{{ '' if streak_count == 1 else 's' }}
            </span>
          </div>
        {% endif %}

        {% if session_date %}
          <p class="text-[11px] text-white/65">Session created on {{ session_date }}</p>
        {% endif %}

        <div class="space-y-2">
          <a href="{{ url_for('coach.index', path_type=path_type) }}"
             class="inline-flex items-center gap-1 text-[11px] text-white/70 hover:text-white underline-offset-2 hover:underline">
            <i data-lucide="arrow-left" class="w-3 h-3"></i>
            Back to Coach overview
          </a>
        </div>
      </div>
    </div>

    {% if session_locked %}
      <div class="mt-5 rounded-2xl border border-amber-400/25 bg-amber-500/10 p-4">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-xl bg-amber-500/20 flex items-center justify-center flex-shrink-0">
            <i data-lucide="lock" class="w-5 h-5 text-amber-200"></i>
          </div>
          <div class="space-y-1">
            <p class="text-sm font-semibold text-amber-100">This week is locked</p>
            <p class="text-[11px] text-white/70 leading-relaxed">
              You can view the plan, but you canâ€™t mark tasks complete until this week becomes active.
              {% if current_week_index %}
                (Current active week: <span class="font-semibold">Week {{ current_week_index }}</span>)
              {% endif %}
            </p>
          </div>
        </div>
      </div>
    {% endif %}
  </header>

  {% if not tasks %}
    <div class="glass-card rounded-2xl p-6 border border-white/10 text-center text-sm text-white/70">
      No tasks were generated for this session yet.
      <div class="mt-3">
        <a href="{{ url_for('coach.index', path_type=path_type) }}" class="btn-primary inline-flex items-center gap-1 px-4 py-2">
          <i data-lucide="arrow-left" class="w-4 h-4"></i>
          <span>Back to Coach</span>
        </a>
      </div>
    </div>
  {% else %}

    {% set total_weeks = 4 %}
    {% set active_week = (day_index or 1) %}
    {% if active_week < 1 %}{% set active_week = 1 %}{% endif %}
    {% if active_week > total_weeks %}{% set active_week = total_weeks %}{% endif %}

    {% if session_is_closed %}
      {% set unlocked_through = active_week + 1 %}
    {% else %}
      {% set unlocked_through = active_week %}
    {% endif %}
    {% if unlocked_through > total_weeks %}{% set unlocked_through = total_weeks %}{% endif %}

    <!-- Roadmap -->
    <section class="glass-card rounded-2xl p-4 sm:p-5 border border-white/10 space-y-3">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div class="space-y-1">
          <p class="text-[11px] uppercase tracking-[0.16em] text-white/55 flex items-center gap-1.5">
            <i data-lucide="radar" class="w-3.5 h-3.5"></i>
            <span>Weekly roadmap</span>
          </p>
          <p class="text-xs sm:text-sm text-white/80">
            You are on <span class="font-semibold">Week {{ active_week }}</span>.
            {% if session_is_closed %}
              This week is <span class="font-semibold text-emerald-300">marked as done</span>.
            {% else %}
              Weekly tasks require DevLog proof.
            {% endif %}
          </p>
        </div>

        <div class="flex flex-wrap items-center gap-3 text-[11px] text-white/60">
          <div class="inline-flex items-center gap-1"><i data-lucide="sparkles" class="w-3.5 h-3.5"></i><span>Active</span></div>
          <div class="inline-flex items-center gap-1"><i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i><span>Completed</span></div>
          <div class="inline-flex items-center gap-1"><i data-lucide="circle-dot" class="w-3.5 h-3.5"></i><span>Next up</span></div>
          <div class="inline-flex items-center gap-1"><i data-lucide="lock" class="w-3.5 h-3.5"></i><span>Locked</span></div>
        </div>
      </div>

      <div class="mt-2 flex flex-col gap-2 text-[11px]">
        <div class="flex items-center justify-between text-white/55">
          <span class="flex items-center gap-1">
            <i data-lucide="layers" class="w-3.5 h-3.5"></i>
            <span>Phase 1 Â· Weeks 1â€“4</span>
          </span>
          <span>Foundation</span>
        </div>

        <div class="flex items-center gap-1 overflow-x-auto pb-1">
          {% for week in range(1, 5) %}
            {% set status = 'locked' %}
            {% if week < active_week %}
              {% set status = 'completed' %}
            {% elif week == active_week %}
              {% set status = 'active' %}
            {% elif week == active_week + 1 and week <= unlocked_through %}
              {% set status = 'next' %}
            {% elif week <= unlocked_through %}
              {% set status = 'unlocked' %}
            {% endif %}

            <div class="flex flex-col items-center gap-0.5 min-w-[56px]">
              <div class="
                  flex items-center justify-center rounded-full border
                  {% if status == 'active' %}
                    w-9 h-9 border-emerald-300/80 bg-emerald-500/20 shadow-lg shadow-emerald-500/30
                  {% elif status == 'completed' %}
                    w-8 h-8 border-emerald-400/70 bg-emerald-500/15
                  {% elif status == 'next' %}
                    w-8 h-8 border-white/60 bg-black/40
                  {% elif status == 'unlocked' %}
                    w-7 h-7 border-white/40 bg-black/40
                  {% else %}
                    w-7 h-7 border-white/20 bg-black/20 opacity-50
                  {% endif %}
                ">
                {% if status == 'active' %}
                  <i data-lucide="sparkles" class="w-4 h-4"></i>
                {% elif status == 'completed' %}
                  <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                {% elif status == 'next' %}
                  <i data-lucide="circle-dot" class="w-4 h-4"></i>
                {% elif status == 'unlocked' %}
                  <i data-lucide="circle" class="w-3.5 h-3.5"></i>
                {% else %}
                  <i data-lucide="lock" class="w-3.5 h-3.5"></i>
                {% endif %}
              </div>
              <span class="
                  mt-0.5
                  {% if status == 'active' %}
                    text-emerald-200 font-semibold
                  {% elif status == 'completed' %}
                    text-emerald-200
                  {% elif status == 'locked' %}
                    text-white/45
                  {% else %}
                    text-white/75
                  {% endif %}
                ">
                W{{ week }}
              </span>
            </div>
          {% endfor %}
        </div>
      </div>

      <p class="text-[11px] text-white/55 mt-1">
        New weeks unlock as time progresses (and as you close sessions on the main Coach page).
      </p>
    </section>

    {% if ai_note %}
      <section class="glass-card rounded-2xl p-4 sm:p-5 border border-emerald-400/40 bg-emerald-900/20 space-y-2">
        <h2 class="text-sm sm:text-base font-semibold flex items-center gap-1.5">
          <i data-lucide="messages-square" class="w-4 h-4"></i>
          <span>Coach note for this week</span>
        </h2>
        <p class="text-sm sm:text-base text-white/85 leading-relaxed">
          {{ ai_note }}
        </p>
        <p class="text-[11px] text-white/60">
          This is your anchor for the week.
        </p>
      </section>
    {% endif %}

    <!-- TASK LIST -->
    <section class="glass-card rounded-2xl p-5 sm:p-6 border border-white/10 space-y-4">

      <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
        <div>
          <h2 class="text-lg sm:text-xl font-semibold flex items-center gap-1.5">
            <i data-lucide="check-square" class="w-4 h-4"></i>
            <span>This weekâ€™s checklist</span>
          </h2>
          <p class="text-[11px] text-white/60 mt-1 max-w-xl">
            Daily tasks can be ticked. Weekly tasks are <span class="font-semibold">DevLog-gated</span> (min {{ min_chars }} chars proof).
          </p>
        </div>

        {% if day_index is defined and day_index is not none %}
          <div class="text-[11px] text-white/65 text-left sm:text-right space-y-1">
            <p>Week <span class="font-semibold">{{ day_index }}</span></p>
            {% if session_locked %}
              <p class="text-amber-200/90">Locked until it becomes active.</p>
            {% endif %}
          </div>
        {% endif %}
      </div>

      {% set total = tasks|length %}
      {% set done = (tasks | selectattr('is_done') | list | length) if tasks else 0 %}
      {% set pct = (done * 100 // total) if total > 0 else 0 %}
      <div class="space-y-1 mt-1">
        <div class="flex items-center justify-between text-[11px] text-white/65">
          <span>Weekly progress</span>
          <span id="coach-week-progress-label">{{ done }}/{{ total }} tasks Â· {{ pct }}%</span>
        </div>
        <div class="w-full h-2 rounded-full bg-black/40 overflow-hidden">
          <div id="coach-week-progress-bar" class="h-2 rounded-full bg-emerald-400" style="width: {{ pct }}%;"></div>
        </div>
      </div>

      <ul class="mt-4 space-y-3">
        {% for t in tasks %}
          {% set est = (t.estimated_time_minutes if t.estimated_time_minutes is not none else (t.estimated_minutes if t.estimated_minutes is not none else None)) %}
          <li
            class="flex items-start gap-3 text-sm sm:text-base"
            data-coach-task-item
            data-task-id="{{ t.id }}"
            data-task-type="{{ t.task_type }}"
            data-task-done="{{ 1 if t.is_done else 0 }}"
          >
            <div class="w-full">

              {# =========================
                 WEEKLY TASK (DevLog gated)
                 ========================= #}
              {% if t.task_type == 'weekly' %}

                <div class="rounded-2xl border border-white/10 bg-black/25 p-4 sm:p-5">
                  <div class="flex items-start justify-between gap-3">
                    <div class="space-y-1.5">
                      <p class="text-[11px] uppercase tracking-[0.16em] text-white/55 flex items-center gap-1.5">
                        <i data-lucide="shield-check" class="w-3.5 h-3.5"></i>
                        Weekly Â· Proof required
                      </p>

                      <p class="leading-snug font-semibold {% if t.is_done %}text-white/70 line-through{% else %}text-white/95{% endif %}">
                        {{ t.title }}
                      </p>

                      {% if t.detail %}
                        <p class="text-[11px] sm:text-xs text-white/70 leading-snug">{{ t.detail }}</p>
                      {% endif %}

                      <div class="flex flex-wrap gap-2 text-[10px] text-white/70 mt-2">
                        {% if est %}
                          <span class="px-2 py-0.5 rounded-full bg-emerald-500/10 border border-emerald-300/40 text-emerald-100 inline-flex items-center gap-1">
                            <i data-lucide="clock-3" class="w-3 h-3"></i>
                            <span>{{ est }} min</span>
                          </span>
                        {% endif %}
                        {% if t.category %}
                          <span class="px-2 py-0.5 rounded-full bg-white/5 border border-white/20">{{ t.category }}</span>
                        {% endif %}
                        {% if t.target_lpa_level %}
                          <span class="px-2 py-0.5 rounded-full bg-white/5 border border-white/20">{{ t.target_lpa_level }} LPA</span>
                        {% endif %}
                        <span class="px-2 py-0.5 rounded-full bg-indigo-500/10 border border-indigo-400/25 text-indigo-100">
                          min {{ min_chars }} chars
                        </span>
                      </div>

                      {% if t.tips %}
                        <div class="mt-3 rounded-xl border border-amber-400/20 bg-amber-500/10 p-3">
                          <p class="text-[11px] font-semibold text-amber-200 flex items-center gap-2">
                            <i data-lucide="lightbulb" class="w-3.5 h-3.5"></i>
                            Expert tip
                          </p>
                          <p class="text-[11px] text-white/80 mt-1 leading-relaxed">{{ t.tips }}</p>
                        </div>
                      {% endif %}

                      {# Remove from_json to avoid template crash #}
                      {% set tags = [] %}
                      {% if t.skill_tags %}
                        {% if t.skill_tags is string %}
                          {% set raw = t.skill_tags %}
                          {% set raw = raw.replace('[','').replace(']','').replace('"','').replace("'",'') %}
                          {% set tags = raw.split(',')|map('trim')|select|list %}
                        {% else %}
                          {% set tags = t.skill_tags %}
                        {% endif %}
                      {% endif %}
                      {% if tags and tags|length > 0 %}
                        <div class="mt-3">
                          <p class="text-[11px] font-semibold text-white/70 flex items-center gap-2">
                            <i data-lucide="award" class="w-4 h-4 text-indigo-300"></i>
                            Skills unlocked by proof:
                          </p>
                          <div class="mt-2 flex flex-wrap gap-2">
                            {% for tag in tags %}
                              <span class="px-3 py-1.5 rounded-xl bg-indigo-500/20 border border-indigo-500/25 text-[11px] text-indigo-100">
                                {{ tag }}
                              </span>
                            {% endfor %}
                          </div>
                        </div>
                      {% endif %}
                    </div>

                    <div class="flex flex-col items-end gap-2 flex-shrink-0">
                      {% if t.is_done %}
                        <span class="px-2 py-1 rounded-full bg-emerald-500/15 border border-emerald-300/40 text-[11px] text-emerald-100 inline-flex items-center gap-1">
                          <i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i>
                          Completed
                        </span>
                        <a href="{{ url_for('coach.devlog', task_id=t.id) }}"
                           class="inline-flex items-center gap-2 px-3 py-2 rounded-full border border-white/20 bg-white/5 hover:bg-white/10 text-[11px]">
                          <i data-lucide="notebook-pen" class="w-4 h-4"></i>
                          View DevLog
                        </a>
                      {% else %}
                        <span class="px-2 py-1 rounded-full bg-black/30 border border-white/10 text-[11px] text-white/65 inline-flex items-center gap-1">
                          <i data-lucide="lock-keyhole" class="w-3.5 h-3.5"></i>
                          Tick disabled
                        </span>

                        {% if session_locked or session_is_closed %}
                          <button type="button" disabled
                            class="inline-flex items-center gap-2 px-3 py-2 rounded-full border border-white/15 bg-black/30 text-[11px] text-white/45 cursor-not-allowed">
                            <i data-lucide="lock" class="w-4 h-4"></i>
                            Locked
                          </button>
                        {% else %}
                          <a href="{{ url_for('coach.devlog', task_id=t.id) }}"
                             class="btn-primary inline-flex items-center gap-2 px-4 py-2 text-[11px]">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                            Log Work & Complete
                          </a>
                        {% endif %}
                      {% endif %}
                    </div>
                  </div>
                </div>

              {# =========================
                 DAILY TASK (tick allowed)
                 ========================= #}
              {% else %}

                <form
                  method="POST"
                  action="{{ url_for('coach.complete_task', task_id=t.id) }}"
                  data-coach-task-form
                  data-coach-task-form
                  data-task-type="{{ t.task_type }}"
                  {% if session_locked or session_is_closed %}data-locked="1"{% endif %}
                >
                  <div class="flex items-start gap-3">
                    <button
                      type="submit"
                      data-coach-task-toggle
                      {% if session_locked or session_is_closed %}disabled{% endif %}
                      class="mt-1 w-5 h-5 rounded border-2 flex items-center justify-center transition-all
                             {% if session_locked or session_is_closed %}
                               opacity-50 cursor-not-allowed border-white/20
                             {% else %}
                               {% if t.is_done %}bg-emerald-500 border-emerald-500{% else %}border-white/30 hover:border-white/50{% endif %}
                             {% endif %}"
                      aria-label="Toggle task complete"
                    >
                      {% if t.is_done %}
                        <i data-lucide="check" class="w-3.5 h-3.5 text-white"></i>
                      {% endif %}
                    </button>

                    <div class="flex-1 space-y-1.5">
                      <div class="flex items-center justify-between gap-2">
                        <p
                          data-coach-task-title
                          class="leading-snug {% if t.is_done %}line-through text-white/60{% else %}text-white/90{% endif %}"
                        >
                          {{ t.title }}
                          <span class="ml-2 text-[10px] uppercase tracking-[0.16em] text-white/50">Â· daily</span>
                        </p>
                        <div class="flex items-center gap-1 flex-wrap justify-end">
                          {% if est %}
                            <span class="px-2 py-0.5 rounded-full text-[10px] bg-emerald-500/10 border border-emerald-300/60 text-emerald-100 inline-flex items-center gap-1">
                              <i data-lucide="clock-3" class="w-3 h-3"></i>
                              <span>{{ est }} min</span>
                            </span>
                          {% endif %}
                          {% if t.category %}
                            <span class="px-2 py-0.5 rounded-full text-[10px] bg-white/5 border border-white/20">{{ t.category }}</span>
                          {% endif %}
                        </div>
                      </div>

                      {% if t.detail %}
                        <p class="text-[11px] sm:text-xs text-white/70 leading-snug">{{ t.detail }}</p>
                      {% endif %}
                    </div>
                  </div>
                </form>

              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>

      <div class="mt-5 flex flex-col sm:flex-row sm:items-center justify-between gap-3 text-xs">
        <p class="text-white/65">
          Daily ticks update instantly. Weekly completion is proof-based (DevLog).
        </p>
        <div class="flex flex-wrap gap-2 justify-end">
          <a
            href="{{ url_for('coach.index', path_type=path_type) }}"
            class="inline-flex items-center justify-center gap-1 px-4 py-2 rounded-full border border-white/25 bg-white/5 hover:bg-white/10"
          >
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            <span>Back to Coach</span>
          </a>
        </div>
      </div>
    </section>

    <!-- FOCUS TIMER (unchanged) -->
    <section class="glass-card rounded-2xl p-5 border border-white/10 space-y-3">
      <h2 class="text-sm font-semibold flex items-center gap-1.5">
        <i data-lucide="timer" class="w-4 h-4"></i>
        <span>Focus timer & wellbeing coach</span>
      </h2>
      <p class="text-xs text-white/70">
        Pick a focus block and a break. Start the timer when you begin deep work on any task above.
      </p>

      <div class="grid sm:grid-cols-3 gap-4 text-xs">
        <div class="space-y-2">
          <p class="font-semibold">Focus duration</p>
          <div class="flex items-center gap-2">
            <div>
              <label class="block text-[11px] text-white/60">Hours</label>
              <input id="focusHours" type="number" min="0" max="8" value="0"
                class="w-16 rounded-lg bg-black/40 border border-white/25 px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-400">
            </div>
            <div>
              <label class="block text-[11px] text-white/60">Minutes</label>
              <input id="focusMinutes" type="number" min="5" max="180" value="45"
                class="w-16 rounded-lg bg-black/40 border border-white/25 px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-400">
            </div>
          </div>
        </div>

        <div class="space-y-2">
          <p class="font-semibold">Break duration</p>
          <div>
            <label class="block text-[11px] text-white/60">Minutes</label>
            <input id="breakMinutes" type="number" min="3" max="30" value="10"
              class="w-20 rounded-lg bg-black/40 border border-white/25 px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-emerald-400">
          </div>
        </div>

        <div class="space-y-2">
          <p class="font-semibold">Controls</p>
          <div class="flex flex-wrap gap-2">
            <button id="timerStart" type="button" class="btn-primary inline-flex items-center gap-1 px-3 py-1.5 text-[11px]">
              <i data-lucide="play" class="w-3.5 h-3.5"></i><span>Start</span>
            </button>
            <button id="timerPause" type="button" class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full border border-white/25 bg-white/5 hover:bg-white/10 text-[11px]">
              <i data-lucide="pause" class="w-3.5 h-3.5"></i><span>Pause</span>
            </button>
            <button id="timerReset" type="button" class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full border border-white/25 bg-white/5 hover:bg-white/10 text-[11px]">
              <i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i><span>Reset</span>
            </button>
          </div>
        </div>
      </div>

      <div class="mt-4 grid sm:grid-cols-2 gap-4 items-center">
        <div class="space-y-1 text-center sm:text-left">
          <p id="timerPhase" class="text-xs text-white/60 uppercase tracking-[0.16em]">FOCUS PHASE</p>
          <p id="timerDisplay" class="text-3xl sm:text-4xl font-mono font-semibold">45:00</p>
        </div>
        <div class="text-xs text-white/75">
          <p class="font-semibold mb-1">Coach note for this phase</p>
          <p id="timerMessage">
            Set your phone away, close extra tabs, and give this block your full attention.
          </p>
        </div>
      </div>
    </section>

    <!-- REFLECTION (unchanged) -->
    <section class="glass-card rounded-2xl p-5 border border-white/10 space-y-3">
      <h2 class="text-sm font-semibold flex items-center gap-1.5">
        <i data-lucide="notebook-pen" class="w-4 h-4"></i>
        <span>Quick reflection</span>
      </h2>
      <p class="text-xs text-white/70">
        Saved locally in your browser for now.
      </p>

      <div>
        <textarea id="coachReflection" rows="3"
          class="w-full mt-2 rounded-xl bg-black/40 border border-white/20 text-xs p-3 focus:outline-none focus:ring-1 focus:ring-emerald-400"
          placeholder="Example: Finished SQL tasks, interview questions felt hard."
        >{{ reflection or '' }}</textarea>

        <div class="mt-3 flex items-center justify-between gap-3 text-[11px] text-white/60">
          <span>Your note stays on this device.</span>
          <button id="saveReflectionBtn" type="button"
            class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full border border-white/25 bg-white/5 hover:bg-white/10">
            <i data-lucide="pen" class="w-3.5 h-3.5"></i><span>Save note</span>
          </button>
        </div>
      </div>
    </section>

    <!-- NAV -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 text-xs text-white/70">
      <div class="flex flex-wrap items-center gap-3">
        <a href="{{ url_for('coach.index', path_type=path_type) }}" class="inline-flex items-center gap-1 underline hover:text-white">
          <i data-lucide="timer-reset" class="w-3.5 h-3.5"></i><span>Back to Coach</span>
        </a>
        <a href="{{ url_for('dream.index', path_type=path_type) }}" class="inline-flex items-center gap-1 underline hover:text-white">
          <i data-lucide="sparkles" class="w-3.5 h-3.5"></i><span>Dream Planner</span>
        </a>
      </div>

      {% if session_is_closed %}
        <p class="flex-shrink-0 text-right text-white/70">
          This week is closed. Open the next week from the Coach overview.
        </p>
      {% endif %}
    </div>

  {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    if (window.lucide) window.lucide.createIcons();

    // ===== Timer (same logic, minimal edits) =====
    const focusHoursInput   = document.getElementById('focusHours');
    const focusMinutesInput = document.getElementById('focusMinutes');
    const breakMinutesInput = document.getElementById('breakMinutes');

    const timerDisplay = document.getElementById('timerDisplay');
    const timerPhase   = document.getElementById('timerPhase');
    const timerMessage = document.getElementById('timerMessage');

    const btnStart = document.getElementById('timerStart');
    const btnPause = document.getElementById('timerPause');
    const btnReset = document.getElementById('timerReset');

    let timerId = null, remainingSeconds = 0, phase = 'focus', isRunning = false;

    const focusMessages = [
      "Set your phone away, close extra tabs, and give this block your full attention.",
      "One clean chunk beats hours of half-focus.",
      "If your brain resists, thatâ€™s normal. Bring it back gently.",
      "Study as if youâ€™ll teach it to someone else."
    ];
    const breakMessages = [
      "Stand up, stretch, drink some water.",
      "Deep breaths: in 4, hold 4, out 6.",
      "Look away from the screen and relax your shoulders.",
      "Rest is part of performance."
    ];
    function pickRandom(arr){ return arr[Math.floor(Math.random() * arr.length)]; }
    function formatTime(seconds){
      const m = Math.floor(seconds / 60), s = seconds % 60;
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    function setPhase(newPhase){
      phase = newPhase;
      if (!timerPhase || !timerMessage) return;
      if (phase === 'focus') {
        timerPhase.textContent = 'FOCUS PHASE';
        timerMessage.textContent = pickRandom(focusMessages);
      } else {
        timerPhase.textContent = 'BREAK PHASE';
        timerMessage.textContent = pickRandom(breakMessages);
      }
    }
    function initFromInputs(){
      if (!focusHoursInput || !focusMinutesInput || !timerDisplay) return;
      const h = parseInt(focusHoursInput.value || '0', 10);
      const m = parseInt(focusMinutesInput.value || '0', 10);
      const total = (isNaN(h) ? 0 : h) * 3600 + (isNaN(m) ? 0 : m) * 60;
      remainingSeconds = total > 0 ? total : 25 * 60;
      setPhase('focus');
      timerDisplay.textContent = formatTime(remainingSeconds);
    }
    function startTimer(){
      if (!timerDisplay || !breakMinutesInput) return;
      if (isRunning) return;
      if (!remainingSeconds) initFromInputs();
      isRunning = true;
      timerId = setInterval(() => {
        if (remainingSeconds > 0) {
          remainingSeconds -= 1;
          timerDisplay.textContent = formatTime(remainingSeconds);
        } else {
          if (phase === 'focus') {
            const breakM = parseInt(breakMinutesInput.value || '5', 10);
            remainingSeconds = (isNaN(breakM) ? 5 : breakM) * 60;
            setPhase('break');
            timerDisplay.textContent = formatTime(remainingSeconds);
          } else {
            clearInterval(timerId);
            timerId = null;
            isRunning = false;
            initFromInputs();
          }
        }
      }, 1000);
    }
    function pauseTimer(){ if (timerId) { clearInterval(timerId); timerId = null; } isRunning = false; }
    function resetTimer(){ pauseTimer(); initFromInputs(); }

    if (btnStart && btnPause && btnReset && focusHoursInput && focusMinutesInput && breakMinutesInput && timerDisplay && timerPhase && timerMessage) {
      initFromInputs();
      btnStart.addEventListener('click', startTimer);
      btnPause.addEventListener('click', pauseTimer);
      btnReset.addEventListener('click', resetTimer);
      focusHoursInput.addEventListener('change', () => { if (!isRunning) initFromInputs(); });
      focusMinutesInput.addEventListener('change', () => { if (!isRunning) initFromInputs(); });
    }

    // ===== Local reflection save =====
    const reflectionEl = document.getElementById('coachReflection');
    const saveBtn = document.getElementById('saveReflectionBtn');
    const key = "coach_reflection_session_{{ session_id or 0 }}";

    if (reflectionEl) {
      try {
        const existing = localStorage.getItem(key);
        if (existing && (!reflectionEl.value || reflectionEl.value.trim() === "")) reflectionEl.value = existing;
      } catch (e) {}
    }
    if (saveBtn && reflectionEl) {
      saveBtn.addEventListener('click', () => {
        try {
          localStorage.setItem(key, reflectionEl.value || "");
          saveBtn.innerHTML = '<i data-lucide="check" class="w-3.5 h-3.5"></i><span>Saved</span>';
          if (window.lucide) window.lucide.createIcons();
          setTimeout(() => {
            saveBtn.innerHTML = '<i data-lucide="pen" class="w-3.5 h-3.5"></i><span>Save note</span>';
            if (window.lucide) window.lucide.createIcons();
          }, 1200);
        } catch (e) {}
      });
    }

    // ===== Toast helper =====
    function toast(msg) {
      const el = document.createElement('div');
      el.className = 'fixed inset-x-0 top-4 flex justify-center z-[90] px-4 pointer-events-none';
      el.innerHTML = `
        <div class="coach-toast pointer-events-auto max-w-xl w-full rounded-2xl border border-white/15 bg-black/60 backdrop-blur px-4 py-3 text-[12px] text-white/90 shadow-xl">
          <div class="flex items-start justify-between gap-3">
            <div class="flex items-start gap-2">
              <i data-lucide="info" class="w-4 h-4 mt-0.5 text-white/70"></i>
              <div>${msg}</div>
            </div>
            <button type="button" class="text-white/60 hover:text-white" aria-label="Close">âœ•</button>
          </div>
        </div>`;
      document.body.appendChild(el);
      if (window.lucide) window.lucide.createIcons();
      const btn = el.querySelector('button');
      if (btn) btn.addEventListener('click', () => el.remove());
      setTimeout(() => { try { el.remove(); } catch(e){} }, 3200);
    }

    // âœ… NEW: Alert + toast (user asked for alert as well)
    function notify(msg) {
      try { alert(msg); } catch (e) {}
      toast(msg);
    }

    // ===== Streak + live progress (daily forms only) =====
    const streakValueEl = document.getElementById('coach-streak-value');
    let currentStreak = 0;
    if (streakValueEl) {
      const raw = streakValueEl.dataset.streak || streakValueEl.textContent || '0';
      currentStreak = parseInt(raw, 10) || 0;
    }
    const progressLabelEl = document.getElementById('coach-week-progress-label');
    const progressBarEl   = document.getElementById('coach-week-progress-bar');

    function recalcProgress() {
      if (!progressLabelEl || !progressBarEl) return;
      const items = document.querySelectorAll('[data-coach-task-item]');
      const total = items.length;
      let done = 0;
      items.forEach((el) => { if (el.getAttribute('data-task-done') === '1') done += 1; });
      const pct = total > 0 ? Math.round((done * 100) / total) : 0;
      progressLabelEl.textContent = `${done}/${total} tasks Â· ${pct}%`;
      progressBarEl.style.width = `${pct}%`;
    }

    function triggerStreakCelebration() {
      const container = document.createElement('div');
      container.className = 'fixed inset-0 flex items-start justify-center pointer-events-none z-[80]';
      container.innerHTML = `
        <div class="mt-20 px-4 py-2 rounded-full bg-emerald-500/20 border border-emerald-300/80 shadow-lg text-xs sm:text-sm text-emerald-50 coach-streak-pop">
          <span class="inline-flex items-center gap-1"><span>ðŸ”¥ Streak up!</span><span class="hidden sm:inline">Nice consistency.</span></span>
        </div>`;
      document.body.appendChild(container);
      setTimeout(() => container.classList.add('opacity-0'), 650);
      setTimeout(() => container.remove(), 1100);
    }

    const taskForms = document.querySelectorAll('form[data-coach-task-form]');
    taskForms.forEach((form) => {
      form.addEventListener('submit', function (e) {
        if (form.dataset.noAjax === '1') return;

        // âœ… Locked/closed â€” show alert + toast
        if (form.dataset.locked === '1') {
          e.preventDefault();
          notify("This week is locked. You canâ€™t complete tasks yet.");
          return;
        }

        e.preventDefault();
        const toggleBtn = form.querySelector('[data-coach-task-toggle]');
        const taskItem  = form.closest('[data-coach-task-item]');
        const taskType  = form.dataset.taskType || 'daily';

        fetch(form.action, {
          method: form.method || 'POST',
          body: new FormData(form),
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then((res) => { if (!res.ok) throw new Error('Network error'); return res.json(); })
        .then((data) => {
          if (!data) {
            notify("Action not allowed.");
            return;
          }

          // âœ… Backend blocked (future week / closed / weekly-devlog gating)
          if (data.ok === false) {
            const msg = data.message || "Action not allowed.";
            notify(msg);

            // If backend gives devlog_url, route them there
            if (data.devlog_url) {
              window.location.href = data.devlog_url;
            }
            return;
          }

          if (data.ok !== true) {
            const msg = data.message || "Action not allowed.";
            notify(msg);
            return;
          }

          const isDone = !!data.is_done;

          if (toggleBtn) {
            if (isDone) {
              toggleBtn.classList.add('bg-emerald-500', 'border-emerald-500');
              toggleBtn.classList.remove('border-white/30', 'hover:border-white/50');
              toggleBtn.innerHTML = '<i data-lucide="check" class="w-3.5 h-3.5 text-white"></i>';
            } else {
              toggleBtn.classList.remove('bg-emerald-500', 'border-emerald-500');
              toggleBtn.classList.add('border-white/30');
              toggleBtn.innerHTML = '';
            }
            if (window.lucide) window.lucide.createIcons();
          }

          if (taskItem) {
            taskItem.setAttribute('data-task-done', isDone ? '1' : '0');
            const titleEl = taskItem.querySelector('[data-coach-task-title]');
            if (titleEl) {
              if (isDone) {
                titleEl.classList.add('line-through', 'text-white/60');
              } else {
                titleEl.classList.remove('line-through', 'text-white/60');
              }
            }
          }

          recalcProgress();

          if (typeof data.user_streak === 'number' && streakValueEl) {
            const newStreak = data.user_streak || 0;
            if (newStreak > currentStreak) triggerStreakCelebration();
            currentStreak = newStreak;
            streakValueEl.dataset.streak = String(newStreak);
            streakValueEl.textContent = String(newStreak);
          }
        })
        .catch(() => {
          form.dataset.noAjax = '1';
          form.submit();
        });
      });
    });

    recalcProgress();
  });
</script>
{% endblock %}
