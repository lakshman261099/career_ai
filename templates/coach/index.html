{% extends "base.html" %}
{% block title %}Weekly Coach ‚Äî CareerAI{% endblock %}

{% block content %}
{% set path_type = (path_type or 'job') %}

<style>
  @keyframes coachStreakPop {
    0%   { transform: scale(0.95); opacity: 0; }
    25%  { transform: scale(1.05); opacity: 1; }
    100% { transform: scale(1.0); opacity: 0; }
  }
  .coach-streak-pop {
    animation: coachStreakPop 0.9s ease-out forwards;
  }
</style>

<section class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 mb-16 space-y-8 text-white">

  <!-- ‚úÖ NEW: Skill Suggestions -->
  {% if pending_skills and pending_skills|length > 0 %}
  <div class="glass-card rounded-2xl p-6 border-2 border-emerald-500/30 bg-emerald-500/10 mb-6">
    <div class="flex items-start justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center">
          <i data-lucide="star" class="w-6 h-6 text-emerald-400"></i>
        </div>
        <div>
          <h3 class="text-xl font-bold text-emerald-300">üéâ New Skills Unlocked!</h3>
          <p class="text-sm text-white/70 mt-1">Add these to your profile</p>
        </div>
      </div>
      <span class="px-3 py-1 rounded-full bg-emerald-500/20 text-xs text-emerald-300">
        {{ pending_skills|length }} New
      </span>
    </div>

    <div class="space-y-3">
      {% for skill in pending_skills %}
      <div class="p-4 rounded-xl bg-white/5 border border-white/10 flex items-center justify-between">
        <div>
          <div class="font-semibold">{{ skill.skill_name }}</div>
          <div class="text-xs text-white/60 mt-1">{{ skill.context_note }}</div>
        </div>
        <div class="flex gap-2">
          <form method="POST" action="{{ url_for('coach.accept_skill', suggestion_id=skill.id) }}" class="inline">
            <button type="submit" class="px-4 py-2 rounded-lg bg-emerald-500/20 border border-emerald-500/30
                                         text-sm text-emerald-300 hover:bg-emerald-500/30 transition-all">
              <i data-lucide="check" class="w-4 h-4 inline"></i> Add
            </button>
          </form>
          <form method="POST" action="{{ url_for('coach.reject_skill', suggestion_id=skill.id) }}" class="inline">
            <button type="submit" class="px-3 py-2 rounded-lg bg-white/5 text-white/50 hover:bg-white/10">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- HEADER / HERO -->
  <header class="glass-card rounded-2xl p-6 sm:p-7 border border-white/10 shadow-xl relative overflow-hidden">
    <!-- Gradient overlay pushed behind content so navbar stays clickable -->
    <div class="pointer-events-none absolute inset-0 opacity-60 -z-10">
      <div class="w-full h-full bg-[radial-gradient(circle_at_top_left,rgba(129,140,248,0.25),transparent_55%),radial-gradient(circle_at_bottom_right,rgba(16,185,129,0.24),transparent_55%)]"></div>
    </div>

    <div class="relative flex flex-col sm:flex-row sm:items-center sm:justify-between gap-5">
      <div class="space-y-2">
        <div class="inline-flex items-center gap-2 text-[11px] uppercase tracking-[0.16em] text-white/65">
          <span class="px-2 py-0.5 rounded-full bg-black/30 border border-white/15 inline-flex items-center gap-1">
            <i data-lucide="calendar-check" class="w-3.5 h-3.5"></i>
            <span>Weekly Coach</span>
          </span>
          <span class="hidden sm:inline px-2 py-0.5 rounded-full bg-black/20 border border-white/10">
            {% if path_type == 'startup' %}Startup path{% else %}Job path{% endif %}
          </span>
        </div>

        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">
          Turn your Dream Plan into weekly execution
        </h1>

        <p class="text-sm sm:text-base text-white/80 max-w-xl leading-relaxed">
          The coach turns your 3-phase Dream Plan into <span class="font-semibold">small weekly focus packs</span>:
          checklists, a focus timer, and short AI guidance. Use it 3‚Äì5 days a week to keep momentum.
        </p>

        {% if profile_snapshot %}
          <p class="text-[11px] text-white/60 mt-1">
            Profile completion:
            <span class="font-semibold">{{ profile_snapshot.profile_strength_score or 0 }}%</span>
            <span class="text-white/45">¬∑ More complete profiles ‚Üí sharper tasks</span>
          </p>
        {% endif %}
      </div>

      <div class="space-y-2 text-xs text-right">
        {% if streak_count %}
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/40 border border-white/20">
            <i data-lucide="flame" class="w-3.5 h-3.5"></i>
            <span>Streak:</span>
            <span class="font-semibold">
              <span id="coach-streak-value" data-streak="{{ streak_count }}">{{ streak_count }}</span>
              day{{ '' if streak_count == 1 else 's' }}
            </span>
          </div>
        {% endif %}
        <p class="text-[11px] text-white/65">
          Mode:
          <span class="font-semibold">
            {% if path_type == 'startup' %}Startup path{% else %}Job path{% endif %}
          </span>
        </p>

        <div class="mt-2 flex flex-col items-end gap-1 text-[11px]">
          <a href="{{ url_for('dream.index', path_type=path_type) }}" class="inline-flex items-center gap-1 text-white/60 hover:text-white">
            <i data-lucide="sparkles" class="w-3 h-3"></i>
            <span>Back to Dream Planner</span>
          </a>
          {% if feature_paths is defined and feature_paths and feature_paths.skillmapper %}
            <a href="{{ feature_paths.skillmapper }}" class="inline-flex items-center gap-1 text-white/60 hover:text-white">
              <i data-lucide="route" class="w-3 h-3"></i>
              <span>Skill Mapper</span>
            </a>
          {% endif %}
          <a href="/" class="inline-flex items-center gap-1 text-white/60 hover:text-white">
            <i data-lucide="arrow-left" class="w-3 h-3"></i>
            <span>Back to home</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- DUAL-TRACK DASHBOARD (if cycle exists) -->
  {% if cycle_sessions %}
  <div class="space-y-6">

    <!-- STREAK & READY SCORE BAR -->
    <div class="glass-card rounded-2xl p-6 border border-white/10">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">

        <!-- Streak Counter -->
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-orange-500/20 to-red-500/20 border border-orange-500/30 flex items-center justify-center">
            <i data-lucide="flame" class="w-7 h-7 text-orange-400"></i>
          </div>
          <div>
            <div class="text-2xl font-bold" id="coach-streak-main-value" data-streak-main="{{ user_streak }}">
              {{ user_streak }}
            </div>
            <div class="text-xs text-white/60">Day Streak üî•</div>
            <div class="text-[10px] text-white/50">
              Longest: {{ current_user.longest_streak|default(0) }}
              {% if (current_user.streak_freezes_remaining|default(0)) > 0 %}
              ¬∑ ‚ùÑÔ∏è {{ current_user.streak_freezes_remaining|default(0) }} freeze
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Ready Score -->
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-indigo-500/30 flex items-center justify-center">
            <i data-lucide="trophy" class="w-7 h-7 text-indigo-400"></i>
          </div>
          <div>
            <div class="text-2xl font-bold">{{ user_ready_score }}</div>
            <div class="text-xs text-white/60">Ready Score ‚≠ê</div>
            <div class="text-[10px] text-white/50">
              {% if user_ready_score >= 80 %}Top Tier
              {% elif user_ready_score >= 60 %}Job Ready
              {% elif user_ready_score >= 40 %}Building
              {% else %}Getting Started
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Milestones -->
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-emerald-500/20 to-teal-500/20 border border-emerald-500/30 flex items-center justify-center">
            <i data-lucide="award" class="w-7 h-7 text-emerald-400"></i>
          </div>
          <div>
            <div class="text-2xl font-bold">{{ current_user.weekly_milestones_completed|default(0) }}</div>
            <div class="text-xs text-white/60">Milestones üèÜ</div>
            <div class="text-[10px] text-white/50">
              Weekly goals completed
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- BENTO: TODAY'S PAIR + BIG ROCK -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

      {% set daily_tasks = today_daily_tasks if today_daily_tasks is defined and today_daily_tasks else [] %}
      {% set daily_total = daily_total if daily_total is defined else (daily_tasks | length) %}
      {% set daily_completed = daily_completed if daily_completed is defined else (daily_tasks | selectattr('is_done') | list | length) %}

      <!-- LEFT / TOP: TODAY'S PAIR (Daily Career Maintenance) -->
      {% if daily_total > 0 %}
        <div class="lg:col-span-2">
          <div class="glass-card rounded-2xl p-6 border border-white/10 h-full flex flex-col">
            <div class="flex items-start justify-between gap-4 mb-4">
              <div>
                <h3 class="text-lg font-semibold flex items-center gap-2">
                  <i data-lucide="coffee" class="w-5 h-5 text-amber-400"></i>
                  <span>Today‚Äôs Pair</span>
                </h3>
                <p class="text-xs text-white/60 mt-1">
                  Up to 2 micro-tasks ¬∑ 5‚Äì15 minutes each ¬∑ Keeps your streak alive.
                </p>
                <p class="text-[11px] text-emerald-200 mt-1">
                  +1 Ready Score ‚≠ê per daily task completed.
                </p>
              </div>

              <div class="flex flex-col items-end gap-2">
                <!-- Progress Ring -->
                <div
                  id="today-progress-ring"
                  class="relative w-20 h-20 rounded-full flex items-center justify-center shadow-lg shadow-emerald-500/25"
                  data-total="{{ daily_total or 1 }}"
                  data-completed="{{ daily_completed or 0 }}"
                >
                  <div class="absolute inset-[3px] rounded-full bg-slate-950 flex items-center justify-center border border-white/10">
                    <div class="text-center leading-tight">
                      <div class="text-xs font-semibold">
                        {{ daily_completed }}/{{ daily_total }}
                      </div>
                      <div class="text-[10px] text-white/60">
                        Today
                      </div>
                    </div>
                  </div>
                </div>

                <div class="px-3 py-1 rounded-full bg-amber-500/20 border border-amber-500/30 text-xs text-amber-300">
                  Daily
                </div>
              </div>
            </div>

            <div class="space-y-3 mt-auto">
              {% for task in daily_tasks %}
                <form
                  method="POST"
                  action="{{ url_for('coach.complete_task', task_id=task.id) }}"
                  class="space-y-2"
                  data-coach-task-form
                  data-task-type="daily"
                  data-is-done="{{ 1 if task.is_done else 0 }}"
                >
                  <div class="flex items-start gap-3">
                    <button
                      type="submit"
                      data-coach-task-toggle
                      class="mt-1 w-5 h-5 rounded border-2 flex items-center justify-center transition-all
                             {% if task.is_done %}
                             bg-emerald-500 border-emerald-400 shadow-glow
                             {% else %}
                             border-white/40 hover:border-emerald-300
                             {% endif %}"
                    >
                      {% if task.is_done %}
                      <i data-lucide="check" class="w-3.5 h-3.5 text-white"></i>
                      {% endif %}
                    </button>
                    <div class="flex-1">
                      <h4
                        class="font-medium {% if task.is_done %}line-through text-emerald-200/70{% else %}text-white{% endif %}"
                        data-coach-task-title
                      >
                        {{ task.title }}
                      </h4>
                      {% if task.detail %}
                      <p class="text-sm text-white/70 mt-1">{{ task.detail }}</p>
                      {% endif %}
                      <div class="flex items-center flex-wrap gap-2 mt-2 text-[11px] text-white/60">
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-black/40 border border-white/20">
                          <i data-lucide="clock-3" class="w-3 h-3"></i>
                          <span>{{ task.estimated_time_minutes or task.estimated_minutes or 10 }} min</span>
                        </span>
                        {% if task.category %}
                          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/5 border border-white/20">
                            <span class="capitalize">{{ task.category }}</span>
                          </span>
                        {% endif %}
                        {% if task.target_lpa_level %}
                          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/5 border border-white/20">
                            {{ task.target_lpa_level }} LPA
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </form>
              {% endfor %}
            </div>

            <p class="mt-3 text-[11px] text-white/55">
              Tip: If you finish these quickly, open your weekly ‚ÄúBig Rock‚Äù and move it forward by at least 10‚Äì15 minutes.
            </p>
          </div>
        </div>
      {% else %}
        <!-- Placeholder when no daily task -->
        <div class="lg:col-span-2">
          <div class="glass-card rounded-2xl p-6 border border-white/10 h-full flex flex-col justify-center">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-2">
              <i data-lucide="coffee" class="w-5 h-5 text-amber-400"></i>
              <span>Today‚Äôs Pair</span>
            </h3>
            <p class="text-sm text-white/65">
              No specific daily micro-tasks for today. You can still keep momentum by nudging your weekly Big Rock forward.
            </p>
          </div>
        </div>
      {% endif %}

      <!-- RIGHT / BOTTOM: THE BIG ROCK (Weekly Professional Momentum) -->
      {% if current_weekly_task %}
        <div>
          <div class="glass-card rounded-2xl p-6 border border-white/10 h-full flex flex-col">
            <div class="flex items-start justify-between gap-4 mb-4">
              <div>
                <h3 class="text-lg font-semibold flex items-center gap-2">
                  <i data-lucide="target" class="w-5 h-5 text-indigo-400"></i>
                  <span>The Big Rock</span>
                </h3>
                <p class="text-xs text-white/60 mt-1">
                  3‚Äì5 hours this week ¬∑ Builds portfolio & confidence.
                </p>
                <p class="text-[11px] text-indigo-200 mt-1">
                  +14 Ready Score ‚≠ê when completed (+10 task +4 badge).
                </p>
              </div>
              <div class="px-3 py-1 rounded-full bg-indigo-500/20 border border-indigo-500/30 text-xs text-indigo-300">
                Weekly
              </div>
            </div>

            <form
              method="POST"
              action="{{ url_for('coach.complete_task', task_id=current_weekly_task.id) }}"
              class="space-y-3"
              data-coach-task-form
              data-task-type="weekly"
            >
              <div class="flex items-start gap-3">
                <button
                  type="submit"
                  data-coach-task-toggle
                  class="mt-1 w-6 h-6 rounded border-2 flex items-center justify-center transition-all
                         {% if current_weekly_task.is_done %}
                         bg-indigo-500 border-indigo-400 shadow-glow
                         {% else %}
                         border-white/40 hover:border-indigo-300
                         {% endif %}"
                >
                  {% if current_weekly_task.is_done %}
                  <i data-lucide="check" class="w-4 h-4 text-white"></i>
                  {% endif %}
                </button>
                <div class="flex-1">
                  <h4
                    class="font-semibold text-sm sm:text-base {% if current_weekly_task.is_done %}line-through text-emerald-200/75{% else %}text-white{% endif %}"
                    data-coach-task-title
                  >
                    {{ current_weekly_task.title }}
                  </h4>
                  {% if current_weekly_task.detail %}
                  <p class="text-xs sm:text-sm text-white/70 mt-2">{{ current_weekly_task.detail }}</p>
                  {% endif %}
                  <div class="flex items-center gap-4 mt-3">
                    <div class="flex-1">
                      <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                        <div
                          id="big-rock-progress-bar"
                          class="h-full bg-gradient-to-r {% if current_weekly_task.is_done %}from-emerald-400 to-emerald-500{% else %}from-indigo-500 to-purple-500{% endif %} transition-all"
                          style="width: {% if current_weekly_task.is_done %}100{% elif current_week_session %}{{ current_week_session.progress_percent }}{% else %}0{% endif %}%"
                        ></div>
                      </div>
                      <div class="flex justify-between text-[11px] text-white/50 mt-1">
                        <span>Progress</span>
                        <span id="big-rock-progress-label">
                          {% if current_week_session %}{{ current_week_session.progress_percent }}%{% else %}0%{% endif %}
                        </span>
                      </div>
                    </div>
                    {% if current_weekly_task.milestone_badge and current_weekly_task.is_done %}
                    <div class="px-3 py-1 rounded-full bg-yellow-500/20 border border-yellow-500/30 text-[11px] text-yellow-200">
                      üèÜ {{ current_weekly_task.milestone_badge }}
                    </div>
                    {% endif %}
                  </div>
                  <div class="flex items-center flex-wrap gap-2 mt-2 text-[11px] text-white/60">
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-black/40 border border-white/20">
                      <i data-lucide="clock-3" class="w-3 h-3"></i>
                      <span>{{ (current_weekly_task.estimated_time_minutes or 240) // 60 }} hours</span>
                    </span>
                    {% if current_weekly_task.category %}
                      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/5 border border-white/20">
                        <span class="capitalize">{{ current_weekly_task.category }}</span>
                      </span>
                    {% endif %}
                    {% if current_weekly_task.target_lpa_level %}
                      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/5 border border-white/20">
                        {{ current_weekly_task.target_lpa_level }} LPA track
                      </span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </form>

            {% if current_week_session %}
              <a href="{{ url_for('coach.session', session_id=current_week_session.id) }}"
                 class="mt-4 inline-flex items-center justify-center gap-1 px-3 py-1.5 rounded-full border border-emerald-300/70 bg-emerald-500/15 hover:bg-emerald-500/25 text-[11px] sm:text-xs text-emerald-100">
                <i data-lucide="timer" class="w-3.5 h-3.5"></i>
                <span>Open Deep Work Timer</span>
              </a>
            {% endif %}

            <p class="mt-3 text-[11px] text-white/55">
              Aim to touch this at least twice this week. Progress, not perfection, is what builds your career story.
            </p>
          </div>
        </div>
      {% else %}
        <!-- Placeholder when no weekly task -->
        <div>
          <div class="glass-card rounded-2xl p-6 border border-white/10 h-full flex flex-col justify-center">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-2">
              <i data-lucide="target" class="w-5 h-5 text-indigo-400"></i>
              <span>The Big Rock</span>
            </h3>
            <p class="text-sm text-white/65">
              Your weekly milestone will appear here once a plan is generated. This is where you‚Äôll see your main project or deep-work goal.
            </p>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- WEEK VIEW (All 4 Weeks) -->
    <div class="glass-card rounded-2xl p-6 border border-white/10">
      <div class="flex items-center justify-between gap-3 mb-4">
        <h3 class="text-lg font-semibold flex items-center gap-2">
          <i data-lucide="calendar" class="w-5 h-5"></i>
          28-Day Roadmap
        </h3>

        <!-- ‚úÖ NEW: Abort Button -->
        <button onclick="showAbortModal()"
                class="px-4 py-2 rounded-lg bg-red-500/10 border border-red-500/30
                       text-sm text-red-300 hover:bg-red-500/20 transition-all">
          <i data-lucide="trash-2" class="w-4 h-4 inline"></i> Abort Plan
        </button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for session in cycle_sessions %}
        <a href="{{ url_for('coach.session', session_id=session.id) }}"
           class="block p-4 rounded-xl border transition-all
                  {% if session.is_closed %}
                  bg-emerald-500/10 border-emerald-500/30 hover:bg-emerald-500/20
                  {% elif current_week_session and session.day_index == current_week_session.day_index %}
                  bg-indigo-500/10 border-indigo-500/30 hover:bg-indigo-500/20
                  {% else %}
                  bg-white/5 border-white/10 hover:bg-white/10
                  {% endif %}">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-semibold">Week {{ session.day_index }}</span>
            {% if session.is_closed %}
            <i data-lucide="check-circle" class="w-4 h-4 text-emerald-400"></i>
            {% elif current_week_session and session.day_index == current_week_session.day_index %}
            <i data-lucide="play-circle" class="w-4 h-4 text-indigo-400"></i>
            {% else %}
            <i data-lucide="circle" class="w-4 h-4 text-white/30"></i>
            {% endif %}
          </div>

          <div class="text-xs text-white/60 space-y-1">
            <div>{{ session.daily_tasks_completed or 0 }} daily tasks done</div>
            <div>{% if session.weekly_task_completed %}‚úì{% else %}‚óã{% endif %} Weekly goal</div>
          </div>

          <div class="mt-3">
            <div class="h-1 bg-white/10 rounded-full overflow-hidden">
              <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500"
                   style="width: {{ session.progress_percent or 0 }}%"></div>
            </div>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>

  </div>
  {% elif locked_plans and locked_plans|length > 0 %}

  <!-- ‚úÖ NEW: SELECT DREAM PLAN TO START -->
  <div class="space-y-6">
    <div class="glass-card rounded-2xl p-6 sm:p-7 border border-white/10 shadow-xl">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-14 h-14 rounded-xl bg-indigo-500/20 flex items-center justify-center">
          <i data-lucide="target" class="w-7 h-7 text-indigo-400"></i>
        </div>
        <div>
          <h2 class="text-2xl sm:text-3xl font-bold">Start Your Weekly Coach</h2>
          <p class="text-sm text-white/70">Select a Dream Plan to begin your 28-day journey</p>
        </div>
      </div>

      <div class="space-y-4">
        {% for plan in locked_plans %}
        {% set plan_data = plan.plan_json_parsed or {} %}
        {% set input_data = plan_data.get('input', {}) %}
        {% set analysis = plan_data.get('analysis', {}) %}
        {% set selected_projects = plan_data.get('selected_projects', []) %}
        {% set target_lpa = input_data.get('target_lpa', '12') %}
        {% set timeline = input_data.get('timeline', '3_months') %}
        
        <div class="p-5 rounded-xl border-2 border-white/10 bg-white/5 hover:border-indigo-500/50 hover:bg-indigo-500/10 transition-all">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1 space-y-3">
              <!-- Plan Title -->
              <div>
                <h3 class="text-lg font-bold text-white">{{ input_data.get('target_role', plan.plan_title or 'Career Plan') }}</h3>
                <div class="flex items-center flex-wrap gap-2 mt-1">
                  <span class="px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-300 text-xs">
                    {{ target_lpa }}+ LPA Target
                  </span>
                  <span class="px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-300 text-xs">
                    {{ '28 Days' if timeline == '28_days' else '3 Months' }}
                  </span>
                  <span class="text-xs text-white/50">
                    Created {{ plan.created_at.strftime('%b %d, %Y') if plan.created_at else '' }}
                  </span>
                </div>
              </div>

              <!-- Selected Projects -->
              {% if selected_projects %}
              <div>
                <div class="text-xs text-white/60 mb-1">Selected Projects:</div>
                <div class="flex flex-wrap gap-2">
                  {% for proj in selected_projects[:3] %}
                  <span class="px-2 py-1 rounded-lg bg-purple-500/20 text-purple-300 text-xs">
                    {{ proj.get('title', 'Project') }}
                  </span>
                  {% endfor %}
                  {% if selected_projects|length > 3 %}
                  <span class="px-2 py-1 rounded-lg bg-white/10 text-white/50 text-xs">
                    +{{ selected_projects|length - 3 }} more
                  </span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              <!-- Probability Preview -->
              {% if analysis.get('probabilities') %}
              <div class="grid grid-cols-2 gap-2 text-xs">
                {% set probs = analysis.get('probabilities', {}) %}
                <div class="px-2 py-1 rounded bg-white/5">
                  <span class="text-white/60">Current:</span>
                  <span class="text-white ml-1">{{ probs.get(target_lpa, 0) }}%</span>
                </div>
                <div class="px-2 py-1 rounded bg-emerald-500/10">
                  <span class="text-white/60">Target:</span>
                  <span class="text-emerald-300 ml-1">{{ analysis.get('projected_probabilities', {}).get(target_lpa, 0) }}%</span>
                </div>
              </div>
              {% endif %}
            </div>

            <!-- Start Button -->
            <form method="POST" action="{{ url_for('coach.start') }}">
              <input type="hidden" name="path_type" value="{{ plan.path_type }}">
              <input type="hidden" name="snapshot_id" value="{{ plan.id }}">
              <button type="submit" 
                      class="px-6 py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 
                             hover:from-indigo-600 hover:to-purple-600 
                             text-white font-semibold transition-all shadow-lg hover:shadow-xl
                             flex items-center gap-2 whitespace-nowrap">
                <i data-lucide="play" class="w-5 h-5"></i>
                <span>Start Coach</span>
              </button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Create New Plan Link -->
      <div class="mt-6 text-center">
        <a href="{{ url_for('dream.index', path_type=path_type) }}" 
           class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 
                  text-sm text-white/70 hover:text-white transition-all border border-white/10">
          <i data-lucide="plus" class="w-4 h-4"></i>
          <span>Create New Dream Plan</span>
        </a>
      </div>
    </div>
  </div>

  {% else %}

  <!-- NO CYCLE YET - Show Start Button -->
  <div class="glass-card rounded-2xl p-8 border border-white/10 text-center">
    <div class="max-w-2xl mx-auto space-y-4">
      <div class="w-16 h-16 mx-auto rounded-xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-indigo-500/30 flex items-center justify-center">
        <i data-lucide="rocket" class="w-8 h-8 text-indigo-400"></i>
      </div>

      <h2 class="text-2xl font-bold">Ready to start your 28-day journey?</h2>

      <p class="text-white/70 max-w-lg mx-auto">
        Get a personalized dual-track plan:
        <span class="font-semibold">2 daily micro-tasks</span> (5‚Äì15 min each) +
        <span class="font-semibold">1 weekly goal</span> (3‚Äì5 hours) for 4 weeks.
      </p>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-w-md mx-auto text-left text-sm">
        <div class="p-3 rounded-lg bg-white/5 border border-white/10">
          <div class="font-semibold text-amber-300 mb-1">Daily Tasks</div>
          <div class="text-xs text-white/60">
            ‚Ä¢ LinkedIn updates<br>
            ‚Ä¢ Networking<br>
            ‚Ä¢ Job applications<br>
            ‚Ä¢ Quick learning
          </div>
        </div>
        <div class="p-3 rounded-lg bg-white/5 border border-white/10">
          <div class="font-semibold text-indigo-300 mb-1">Weekly Goals</div>
          <div class="text-xs text-white/60">
            ‚Ä¢ Project milestones<br>
            ‚Ä¢ Technical content<br>
            ‚Ä¢ Portfolio building<br>
            ‚Ä¢ Interview prep
          </div>
        </div>
      </div>

      <form method="POST" action="{{ url_for('coach.start', path_type=path_type) }}" class="mt-6">
        <button type="submit" class="btn-primary px-6 py-3 text-base">
          <i data-lucide="play" class="w-5 h-5"></i>
          <span>Generate My 28-Day Plan</span>
        </button>
        <p class="text-xs text-white/50 mt-2">
          Cost: 3 Gold ‚≠ê (one-time for the month)
        </p>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- GATED MESSAGE FOR FREE USERS -->
  {% if not is_pro_user %}
    <div class="glass-card rounded-2xl p-6 border border-white/10 text-center space-y-4">
      <h2 class="text-lg font-semibold">Weekly Coach is Pro-only ‚≠ê</h2>
      <p class="text-sm text-white/70 max-w-md mx-auto">
        Upgrade to Pro to unlock:
      </p>

      <ul class="space-y-1 text-sm text-white/75 max-w-md mx-auto text-left">
        <li>‚Ä¢ Weekly focus packs derived from your Dream Plan</li>
        <li>‚Ä¢ A checklist view with task-by-task progress</li>
        <li>‚Ä¢ Focus timer with guided breaks and wellbeing nudges</li>
        <li>‚Ä¢ Progress tracking, streaks and reflection notes</li>
      </ul>

      <a href="{{ url_for('billing.index') }}"
         class="btn-primary mt-4 inline-flex items-center justify-center gap-1 px-4 py-2">
        <i data-lucide="sparkles" class="w-4 h-4"></i>
        <span>Upgrade to Pro</span>
      </a>

      <div class="mt-3 space-y-1 text-xs text-white/60">
        <p>Already Pro? Please logout and login again.</p>
        <p>
          <a href="/" class="inline-flex items-center gap-1 text-white/70 hover:text-white underline underline-offset-2">
            <i data-lucide="arrow-left" class="w-3 h-3"></i>
            <span>Back to home</span>
          </a>
        </p>
      </div>
    </div>

  {% else %}

    <!-- PATH TOGGLE + GOLD STATUS -->
    <div class="grid md:grid-cols-3 gap-4">
      <div class="glass-card rounded-2xl p-4 border border-white/10 space-y-3 md:col-span-2">
        <h2 class="text-sm font-semibold flex items-center gap-2">
          <i data-lucide="route" class="w-4 h-4"></i>
          <span>Which path are you executing right now?</span>
        </h2>
        <p class="text-xs text-white/70">
          You can run separate streaks for your <span class="font-semibold">job</span> and <span class="font-semibold">startup</span> plans.
          Pick one path and stick with it for a few weeks.
        </p>

        <div class="mt-3 inline-flex items-center gap-2 rounded-full bg-black/40 p-1 border border-white/15">
          <a
            href="{{ url_for('coach.index', path_type='job') }}"
            class="px-3 py-1.5 rounded-full text-xs sm:text-[13px] inline-flex items-center gap-1
                   {% if path_type != 'startup' %}bg-white text-black font-semibold shadow{% else %}text-white/70 hover:text-white{% endif %}"
          >
            <i data-lucide="briefcase" class="w-3.5 h-3.5"></i>
            <span>Job path</span>
          </a>
          <a
            href="{{ url_for('coach.index', path_type='startup') }}"
            class="px-3 py-1.5 rounded-full text-xs sm:text-[13px] inline-flex items-center gap-1
                   {% if path_type == 'startup' %}bg-white text-black font-semibold shadow{% else %}text-white/70 hover:text-white{% endif %}"
          >
            <i data-lucide="rocket" class="w-3.5 h-3.5"></i>
            <span>Startup path</span>
          </a>
        </div>
      </div>

      <div class="glass-card rounded-2xl p-4 border border-white/10 space-y-2 text-sm">
        <h3 class="text-xs font-semibold flex items-center gap-2">
          <i data-lucide="coins" class="w-4 h-4"></i>
          <span>Gold credits</span>
        </h3>
        {% if has_gold %}
          <p class="text-emerald-300 text-xs sm:text-sm">
            You have enough Gold ‚≠ê credits to start a new coach session.
          </p>
          <p class="text-[11px] text-white/60">
            Credits are shared with Dream Planner. Each new session uses a small amount.
          </p>
        {% else %}
          <p class="text-red-300 text-xs sm:text-sm">
            You don‚Äôt have enough Gold ‚≠ê credits to start a new session.
          </p>
          <a href="{{ url_for('billing.index') }}"
             class="underline text-white hover:text-emerald-200 text-[11px] mt-1 inline-block">
            Add more Gold credits ‚Üí
          </a>
        {% endif %}
      </div>
    </div>

    {# === Derive current week + phase from sessions for the roadmap UI === #}
    {% set current_week = 1 %}
    {% if today_session and today_session.day_index %}
      {% set current_week = today_session.day_index %}
    {% elif last_session and last_session.day_index %}
      {% set current_week = last_session.day_index %}
    {% endif %}

    {% if current_week <= 4 %}
      {% set current_phase = 1 %}
    {% elif current_week <= 8 %}
      {% set current_phase = 2 %}
    {% else %}
      {% set current_phase = 3 %}
    {% endif %}

    {# Roadmap helpers #}
    {% set total_weeks = 12 %}
    {% set unlocked_through = 1 %}
    {% if last_session and last_session.day_index %}
      {% if last_session.is_closed %}
        {% set unlocked_through = last_session.day_index + 1 %}
      {% else %}
        {% set unlocked_through = last_session.day_index %}
      {% endif %}
    {% endif %}
    {% if today_session and today_session.day_index %}
      {% set unlocked_through = today_session.day_index %}
    {% endif %}
    {% if unlocked_through > total_weeks %}
      {% set unlocked_through = total_weeks %}
    {% endif %}

    {% set active_week_index = current_week %}
    {% if active_week_index < 1 %}
      {% set active_week_index = 1 %}
    {% endif %}
    {% if active_week_index > total_weeks %}
      {% set active_week_index = total_weeks %}
    {% endif %}

    {% set all_sessions = recent_sessions or [] %}

    <!-- MAIN SESSION BLOCK + PHASE ROADMAP -->
    <div class="glass-card rounded-2xl p-6 border border-white/10 space-y-6">

      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
        <!-- Left: explanation + status -->
        <div class="flex-1 space-y-4">
          <div class="space-y-2">
            <h2 class="text-lg sm:text-xl font-semibold flex items-center gap-2">
              <i data-lucide="check-square" class="w-5 h-5"></i>
              <span>Your next focus pack</span>
            </h2>
            <p class="text-sm sm:text-base text-white/80 leading-relaxed max-w-xl">
              Each coach session gives you a <span class="font-semibold">small, realistic task list</span> for this week or focus block,
              based on your 3 phases. Finish what you can, mark the week closed, and let the streak grow.
            </p>
          </div>

          <div class="text-xs text-white/70 space-y-1">
            <p class="font-semibold uppercase tracking-[0.16em] text-white/55">Session status</p>
            {% if today_session %}
              <p>
                You already have an active session:
                <span class="font-semibold">{{ today_session.plan_title or 'Weekly Coach session' }}</span>.
              </p>
              {% if today_session.is_closed %}
                <p class="text-emerald-300">
                  This session is marked as <span class="font-semibold">done</span>. You can still open it to review tasks.
                </p>
              {% else %}
                <p class="text-emerald-300">
                  This session is <span class="font-semibold">in progress</span>. Re-open it to continue this week‚Äôs tasks.
                </p>
              {% endif %}
            {% else %}
              <p>
                No active session for this path yet. Your next run will create a fresh focus pack aligned with your plan.
              </p>
            {% endif %}
          </div>
        </div>

        <!-- Right: phase roadmap mini-visual -->
        <aside class="w-full lg:w-72 rounded-2xl bg-black/35 border border-white/15 p-4 space-y-3 text-xs">
          <p class="font-semibold flex items-center gap-1.5 text-[11px] uppercase tracking-[0.16em] text-white/65">
            <i data-lucide="map" class="w-3.5 h-3.5"></i>
            <span>Your 3-phase roadmap</span>
          </p>
          <p class="text-[11px] text-white/65">
            Weekly Coach maps your weeks into the same 3 phases from Dream Planner. Finish most tasks in a week ‚Üí move to the next.
          </p>

          <div class="space-y-2">
            <!-- Phase 1 -->
            <div class="flex items-start gap-2">
              <div class="mt-1 h-2 w-2 rounded-full
                          {% if current_phase == 1 %}bg-emerald-400{% else %}bg-white/30{% endif %}"></div>
              <div class="flex-1">
                <div class="flex items-center justify-between gap-2">
                  <p class="font-semibold text-[13px]">
                    Phase 1 ¬∑ Foundation
                  </p>
                  <span class="text-[10px] text-white/55">Weeks 1‚Äì4</span>
                </div>
                <p class="text-[11px] text-white/65">
                  Fix basics, profile hygiene, and core skills. Ideal for your first 3‚Äì4 weeks using the coach.
                </p>
              </div>
            </div>

            <!-- Phase 2 -->
            <div class="flex items-start gap-2">
              <div class="mt-1 h-2 w-2 rounded-full
                          {% if current_phase == 2 %}bg-emerald-400{% else %}bg-white/30{% endif %}"></div>
              <div class="flex-1">
                <div class="flex items-center justify-between gap-2">
                  <p class="font-semibold text-[13px]">
                    Phase 2 ¬∑ Projects & depth
                  </p>
                  <span class="text-[10px] text-white/55">Weeks 5‚Äì8</span>
                </div>
                <p class="text-[11px] text-white/65">
                  Build or ship 1‚Äì2 real projects, deepen your stack, and start light interview prep.
                </p>
              </div>
            </div>

            <!-- Phase 3 -->
            <div class="flex items-start gap-2">
              <div class="mt-1 h-2 w-2 rounded-full
                          {% if current_phase == 3 %}bg-emerald-400{% else %}bg-white/30{% endif %}"></div>
              <div class="flex-1">
                <div class="flex items-center justify-between gap-2">
                  <p class="font-semibold text-[13px]">
                    Phase 3 ¬∑ Showcase & applications
                  </p>
                  <span class="text-[10px] text-white/55">Week 9+</span>
                </div>
                <p class="text-[11px] text-white/65">
                  Polish resume & LinkedIn, share your work, and run structured job or customer outreach.
                </p>
              </div>
            </div>
          </div>

          <p class="text-[10px] text-white/50">
            Rule of thumb: aim to honestly complete at least 60‚Äì70% of a week‚Äôs tasks before jumping ahead.
          </p>
        </aside>
      </div>

      <!-- MULTI-WEEK / MULTI-PHASE ROADMAP UI -->
      <div class="rounded-2xl bg-black/35 border border-white/15 p-4 sm:p-5 space-y-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <div class="space-y-1">
            <p class="text-[11px] uppercase tracking-[0.16em] text-white/55 flex items-center gap-1.5">
              <i data-lucide="radar" class="w-3.5 h-3.5"></i>
              <span>Weekly roadmap</span>
            </p>
            <p class="text-sm">
              Phase
              <span class="font-semibold">
                {% if current_phase == 1 %}1 ¬∑ Foundation{% elif current_phase == 2 %}2 ¬∑ Projects & depth{% else %}3 ¬∑ Showcase & applications{% endif %}
              </span>
              ¬∑ Week <span class="font-semibold">{{ active_week_index }}</span> of <span class="font-semibold">{{ total_weeks }}</span>
            </p>
          </div>

          <div class="flex items-center gap-3 text-[11px] text-white/60">
            <div class="inline-flex items-center gap-1">
              <span class="inline-flex items-center justify-center w-4 h-4 rounded-full border border-emerald-400/70">
                <i data-lucide="sparkles" class="w-3 h-3"></i>
              </span>
              <span>Active</span>
            </div>
            <div class="inline-flex items-center gap-1">
              <i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i>
              <span>Completed</span>
            </div>
            <div class="inline-flex items-center gap-1">
              <i data-lucide="circle-dot" class="w-3.5 h-3.5"></i>
              <span>Unlocked</span>
            </div>
            <div class="inline-flex items-center gap-1">
              <i data-lucide="lock" class="w-3.5 h-3.5"></i>
              <span>Locked</span>
            </div>
          </div>
        </div>

        <!-- Phase blocks with week nodes (1‚Äì4, 5‚Äì8, 9‚Äì12) -->
        <div class="space-y-4 text-xs">
          <!-- Phase 1 Weeks 1‚Äì4 -->
          <div>
            <div class="flex items-center justify-between gap-2 mb-2">
              <p class="font-semibold flex items-center gap-1.5 text-[12px]">
                <i data-lucide="layers" class="w-3.5 h-3.5"></i>
                <span>Phase 1 ¬∑ Foundation</span>
              </p>
              <span class="text-[11px] text-white/55">Weeks 1‚Äì4</span>
            </div>
            <div class="flex items-center gap-2 overflow-x-auto pb-1">
              {% for week in range(1, 5) %}
                {% set matching = all_sessions | selectattr('day_index', 'equalto', week) | list %}
                {% if matching|length > 0 %}
                  {% set week_session = matching[0] %}
                {% else %}
                  {% set week_session = None %}
                {% endif %}
                {% set is_completed = week_session and week_session.is_closed %}
                {% set is_active = (week == active_week_index) %}
                {% set is_locked = (week > unlocked_through) %}

                {% if is_locked %}
                  <div class="flex flex-col items-center gap-1 min-w-[64px] opacity-40">
                    <div class="w-9 h-9 rounded-full border border-white/20 bg-black/40 flex items-center justify-center">
                      <i data-lucide="lock" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[11px] text-white/70">Week {{ week }}</span>
                  </div>
                {% elif is_completed and week_session %}
                  <a href="{{ url_for('coach.session', session_id=week_session.id) }}"
                     class="group flex flex-col items-center gap-1 min-w-[64px]">
                    <div class="w-9 h-9 rounded-full border border-emerald-400/70 bg-emerald-500/15 flex items-center justify-center group-hover:bg-emerald-500/25 transition-all">
                      <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[11px] text-emerald-200 font-semibold">Week {{ week }}</span>
                  </a>
                {% elif is_active and week_session %}
                  <a href="{{ url_for('coach.session', session_id=week_session.id) }}"
                     class="group flex flex-col items-center gap-1 min-w-[70px]">
                    <div class="w-10 h-10 rounded-full border border-emerald-300/80 bg-emerald-400/15 flex items-center justify-center shadow-lg shadow-emerald-500/20 group-hover:bg-emerald-400/25 transition-all">
                      <i data-lucide="sparkles" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[11px] text-emerald-200 font-semibold">Week {{ week }}</span>
                  </a>
                {% else %}
                  <div class="flex flex-col items-center gap-1 min-w-[64px]">
                    <div class="w-8 h-8 rounded-full border border-white/30 bg-black/40 flex items-center justify-center">
                      <i data-lucide="circle-dot" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[11px] text-white/75">Week {{ week }}</span>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <!-- Phase 2 Weeks 5‚Äì8 -->
          <div>
            <div class="flex items-center justify-between gap-2 mb-2">
              <p class="font-semibold flex items-center gap-1.5 text-[12px]">
                <i data-lucide="cpu" class="w-3.5 h-3.5"></i>
                <span>Phase 2 ¬∑ Projects & depth</span>
              </p>
              <span class="text-[11px] text-white/55">Weeks 5‚Äì8</span>
            </div>
            <div class="flex items-center gap-2 overflow-x-auto pb-1">
              {% for week in range(5, 9) %}
                {% set matching = all_sessions | selectattr('day_index', 'equalto', week) | list %}
                {% if matching|length > 0 %}
                  {% set week_session = matching[0] %}
                {% else %}
                  {% set week_session = None %}
                {% endif %}
                {% set is_completed = week_session and week_session.is_closed %}
                {% set is_active = (week == active_week_index) %}
                {% set is_locked = (week > unlocked_through) %}

                {% if is_locked %}
                  <div class="flex flex-col items-center gap-1 min-w-[64px] opacity-40">
                    <div class="w-9 h-9 rounded-full border border-white/20 bg-black/40 flex items-center justify-center">
                      <i data-lucide="lock" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[11px] text-white/70">Week {{ week }}</span>
                  </div>
                {% elif is_completed and week_session %}
                  <a href="{{ url_for('coach.session', session_id=week_session.id) }}"
                     class="group flex flex-col items-center gap-1 min-w-[64px]">
                    <div class="w-9 h-9 rounded-full border border-emerald-400/70 bg-emerald-500/15 flex items-center justify-center group-hover:bg-emerald-500/25 transition-all">
                      <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[11px] text-emerald-200 font-semibold">Week {{ week }}</span>
                  </a>
                {% elif is_active and week_session %}
                  <a href="{{ url_for('coach.session', session_id=week_session.id) }}"
                     class="group flex flex-col items-center gap-1 min-w-[70px]">
                    <div class="w-10 h-10 rounded-full border border-emerald-300/80 bg-emerald-400/15 flex items-center justify-center shadow-lg shadow-emerald-500/20 group-hover:bg-emerald-400/25 transition-all">
                      <i data-lucide="sparkles" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[11px] text-emerald-200 font-semibold">Week {{ week }}</span>
                  </a>
                {% else %}
                  <div class="flex flex-col items-center gap-1 min-w-[64px]">
                    <div class="w-8 h-8 rounded-full border border-white/30 bg-black/40 flex items-center justify-center">
                      <i data-lucide="circle-dot" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[11px] text-white/75">Week {{ week }}</span>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <!-- Phase 3 Weeks 9‚Äì12 -->
          <div>
            <div class="flex items-center justify-between gap-2 mb-2">
              <p class="font-semibold flex items-center gap-1.5 text-[12px]">
                <i data-lucide="send" class="w-3.5 h-3.5"></i>
                <span>Phase 3 ¬∑ Showcase & applications</span>
              </p>
              <span class="text-[11px] text-white/55">Weeks 9‚Äì12</span>
            </div>
            <div class="flex items-center gap-2 overflow-x-auto pb-1">
              {% for week in range(9, total_weeks + 1) %}
                {% set matching = all_sessions | selectattr('day_index', 'equalto', week) | list %}
                {% if matching|length > 0 %}
                  {% set week_session = matching[0] %}
                {% else %}
                  {% set week_session = None %}
                {% endif %}
                {% set is_completed = week_session and week_session.is_closed %}
                {% set is_active = (week == active_week_index) %}
                {% set is_locked = (week > unlocked_through) %}

                {% if is_locked %}
                  <div class="flex flex-col items-center gap-1 min-w-[64px] opacity-40">
                    <div class="w-9 h-9 rounded-full border border-white/20 bg-black/40 flex items-center justify-center">
                      <i data-lucide="lock" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[11px] text-white/70">Week {{ week }}</span>
                  </div>
                {% elif is_completed and week_session %}
                  <a href="{{ url_for('coach.session', session_id=week_session.id) }}"
                     class="group flex flex-col items-center gap-1 min-w-[64px]">
                    <div class="w-9 h-9 rounded-full border border-emerald-400/70 bg-emerald-500/15 flex items-center justify-center group-hover:bg-emerald-500/25 transition-all">
                      <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[11px] text-emerald-200 font-semibold">Week {{ week }}</span>
                  </a>
                {% elif is_active and week_session %}
                  <a href="{{ url_for('coach.session', session_id=week_session.id) }}"
                     class="group flex flex-col items-center gap-1 min-w-[70px]">
                    <div class="w-10 h-10 rounded-full border border-emerald-300/80 bg-emerald-400/15 flex items-center justify-center shadow-lg shadow-emerald-500/20 group-hover:bg-emerald-400/25 transition-all">
                      <i data-lucide="sparkles" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[11px] text-emerald-200 font-semibold">Week {{ week }}</span>
                  </a>
                {% else %}
                  <div class="flex flex-col items-center gap-1 min-w-[64px]">
                    <div class="w-8 h-8 rounded-full border border-white/30 bg-black/40 flex items-center justify-center">
                      <i data-lucide="circle-dot" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[11px] text-white/75">Week {{ week }}</span>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>

        <p class="text-[11px] text-white/55 mt-1">
          You can click completed weeks to review past focus packs. Future weeks stay locked until you close the previous one.
        </p>
      </div>

      <!-- TODAY / LAST SESSION DETAILS -->
      <div class="grid md:grid-cols-2 gap-4 text-xs sm:text-sm text-white/80">

        <div class="rounded-xl bg-black/30 border border-white/10 p-4 space-y-2">
          <p class="font-semibold flex items-center gap-1.5">
            <i data-lucide="clock" class="w-4 h-4"></i>
            <span>Current session</span>
          </p>
          {% if today_session %}
            <p>
              Session date:
              <span class="font-semibold">
                {{ today_session.session_date.strftime("%d %b %Y") if today_session.session_date else "Unknown date" }}
              </span>
            </p>
            <p>
              Tasks:
              {% set t_total = (today_session.tasks|length) if today_session.tasks is defined and today_session.tasks else 0 %}
              {% set t_done = (today_session.tasks | selectattr('is_done') | list | length) if today_session.tasks is defined and today_session.tasks else 0 %}
              <span class="font-semibold">{{ t_done }}/{{ t_total }}</span> completed
            </p>
            <a href="{{ url_for('coach.session', session_id=today_session.id) }}"
               class="inline-flex items-center gap-1 mt-2 text-emerald-300 underline hover:text-emerald-100">
              <i data-lucide="play" class="w-3.5 h-3.5"></i>
              <span>Open current coach session</span>
            </a>
          {% else %}
            <p>You don‚Äôt have an active session yet.</p>
            <p class="text-white/60">
              Start one to get tasks and a focus timer for the next block of deep work.
            </p>
          {% endif %}
        </div>

        <div class="rounded-xl bg-black/30 border border-white/10 p-4 space-y-2">
          <p class="font-semibold flex items-center gap-1.5">
            <i data-lucide="calendar-range" class="w-4 h-4"></i>
            <span>Last session</span>
          </p>
          {% if last_session %}
            <p>
              Date:
              <span class="font-semibold">
                {{ last_session.session_date.strftime("%d %b %Y") if last_session.session_date else "Unknown date" }}
              </span>
            </p>
            {% set lt_total = (last_session.tasks|length) if last_session.tasks is defined and last_session.tasks else 0 %}
            {% set lt_done = (last_session.tasks | selectattr('is_done') | list | length) if last_session.tasks is defined and last_session.tasks else 0 %}
            <p>
              Tasks: <span class="font-semibold">{{ lt_done }}/{{ lt_total }}</span> completed
              {% if last_session.is_closed %}
                ¬∑ closed
              {% else %}
                ¬∑ still open
              {% endif %}
            </p>
            <a href="{{ url_for('coach.session', session_id=last_session.id) }}"
               class="inline-flex items-center gap-1 mt-2 underline hover:text-white">
              <i data-lucide="eye" class="w-3.5 h-3.5"></i>
              <span>Review last session</span>
            </a>
          {% else %}
            <p>You haven‚Äôt run Weekly Coach yet. Your first session will appear here.</p>
          {% endif %}
        </div>

      </div>

      <!-- CTA BUTTON -->
      <form method="POST" action="{{ url_for('coach.start') }}">
        <input type="hidden" name="path_type" value="{{ path_type }}">

        <button
          {% if not has_gold %}disabled{% endif %}
          class="btn-primary w-full mt-3 flex items-center justify-center gap-2 disabled:opacity-40 disabled:cursor-not-allowed"
        >
          <i data-lucide="play" class="w-4 h-4"></i>
          {% if today_session %}
            <span>Open / refresh current focus pack</span>
          {% else %}
            <span>Start a new focus pack</span>
          {% endif %}
        </button>
      </form>

      <p class="text-[11px] text-white/60 mt-3 text-center">
        Sessions are meant to be <span class="font-semibold">small weekly blocks</span>. Missing a week is okay ‚Äî
        just restart. Consistency beats perfection.
      </p>

      <div class="mt-4 flex flex-wrap items-center justify-center gap-3 text-[11px] text-white/65">
        <a href="/" class="inline-flex items-center gap-1 hover:text-white underline underline-offset-2">
          <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
          <span>Back to home</span>
        </a>
        <a href="{{ url_for('dream.index', path_type=path_type) }}" class="inline-flex items-center gap-1 hover:text-white underline underline-offset-2">
          <i data-lucide="sparkles" class="w-3.5 h-3.5"></i>
          <span>Dream Planner</span>
        </a>
      </div>
    </div>

    <!-- RECENT SESSIONS HISTORY -->
    {% if recent_sessions %}
      <div class="glass-card rounded-2xl p-6 border border-white/10 space-y-3">
        <div class="flex items-center justify-between gap-2">
          <h3 class="text-sm font-semibold flex items-center gap-2">
            <i data-lucide="history" class="w-4 h-4"></i>
            <span>Recent sessions</span>
          </h3>
          <p class="text-[11px] text-white/55">
            Last {{ recent_sessions|length }} {{ 'session' if recent_sessions|length == 1 else 'sessions' }} for this path
          </p>
        </div>

        <div class="space-y-1 text-xs sm:text-sm">
          {% for s in recent_sessions %}
            {% set s_total = (s.tasks|length) if s.tasks is defined and s.tasks else 0 %}
            {% set s_done = (s.tasks | selectattr('is_done') | list | length) if s.tasks is defined and s.tasks else 0 %}
            <a href="{{ url_for('coach.session', session_id=s.id) }}"
               class="flex items-center justify-between gap-3 px-3 py-2 rounded-lg bg-black/30 border border-white/10 hover:bg-black/50 hover:border-white/25 transition-all">
              <div class="flex flex-col">
                <span class="font-semibold text-white">
                  {{ s.session_date.strftime("%d %b %Y") if s.session_date else "Unknown date" }}
                </span>
                <span class="text-[11px] text-white/60">
                  {{ s.plan_title or 'Weekly Coach session' }}
                  {% if s.day_index %}¬∑ Week {{ s.day_index }}{% endif %}
                </span>
              </div>
              <div class="flex items-center gap-3 text-[11px] text-white/65">
                <span>{{ s_done }}/{{ s_total }} tasks</span>
                {% if s.is_closed %}
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-500/10 border border-emerald-500/40 text-emerald-300">
                    <i data-lucide="check-circle-2" class="w-3 h-3"></i>
                    <span>Closed</span>
                  </span>
                {% else %}
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-yellow-500/10 border border-yellow-500/40 text-yellow-200">
                    <i data-lucide="circle-dot" class="w-3 h-3"></i>
                    <span>Open</span>
                  </span>
                {% endif %}
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
    {% endif %}

  {% endif %}

  <!-- ‚úÖ NEW: Abort Modal -->
  <div id="abortModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
    <div class="glass-card rounded-2xl max-w-md w-full p-8 border border-red-500/30 bg-gradient-to-br from-red-500/10 to-orange-500/10">
      <div class="text-center mb-6">
        <div class="w-16 h-16 rounded-2xl bg-red-500/20 flex items-center justify-center mx-auto mb-4">
          <i data-lucide="alert-triangle" class="w-8 h-8 text-red-400"></i>
        </div>
        <h3 class="text-2xl font-bold text-red-300 mb-2">Abort Current Plan?</h3>
        <p class="text-white/80">
          This will delete all tasks in your current cycle. You can restart anytime.
        </p>
      </div>

      <div class="space-y-3">
        <form method="POST" action="{{ url_for('coach.abort_plan') }}">
          <input type="hidden" name="path_type" value="{{ path_type }}">
          <input type="hidden" name="month_cycle_id" value="{{ month_cycle_id }}">
          <button type="submit"
                  class="w-full px-6 py-3 rounded-xl bg-red-500/20 border border-red-500/30
                         text-red-300 font-semibold hover:bg-red-500/30 transition-all">
            <i data-lucide="trash-2" class="w-5 h-5 inline"></i> Yes, Abort Plan
          </button>
        </form>

        <button onclick="hideAbortModal()"
                class="w-full px-6 py-3 rounded-xl bg-white/10 border border-white/20
                       text-white hover:bg-white/20 transition-all">
          Cancel
        </button>
      </div>
    </div>
  </div>

</section>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>
  function showAbortModal() {
    const el = document.getElementById('abortModal');
    if (el) el.classList.remove('hidden');
  }
  function hideAbortModal() {
    const el = document.getElementById('abortModal');
    if (el) el.classList.add('hidden');
  }
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') hideAbortModal();
  });

  document.addEventListener('DOMContentLoaded', function () {
    if (window.lucide) {
      window.lucide.createIcons();
    }

    // ----- Daily progress ring -----
    function updateDailyRing() {
      const ring = document.getElementById('today-progress-ring');
      if (!ring) return;
      const total = parseInt(ring.getAttribute('data-total') || '1', 10) || 1;
      const completed = parseInt(ring.getAttribute('data-completed') || '0', 10) || 0;
      const pct = Math.max(0, Math.min(100, Math.round((completed / total) * 100)));

      ring.style.backgroundImage =
        'conic-gradient(rgba(16,185,129,0.95) ' + pct + '%, rgba(15,23,42,0.9) ' + pct + '%)';
    }
    updateDailyRing();

    // ----- Streak + celebration -----
    const headerStreakEl = document.getElementById('coach-streak-value');
    const mainStreakEl   = document.getElementById('coach-streak-main-value');
    let currentStreak = 0;
    if (headerStreakEl) {
      currentStreak = parseInt(headerStreakEl.dataset.streak || headerStreakEl.textContent || '0', 10) || 0;
    } else if (mainStreakEl) {
      currentStreak = parseInt(mainStreakEl.dataset.streakMain || mainStreakEl.textContent || '0', 10) || 0;
    }

    function triggerStreakCelebration(taskType) {
      const container = document.createElement('div');
      container.className = 'fixed inset-0 flex items-start justify-center pointer-events-none z-[80]';
      const message = taskType === 'weekly'
        ? 'Weekly milestone locked in ‚Äî nice.'
        : 'Another day in your streak. Keep it going.';
      container.innerHTML = `
        <div class="mt-20 px-4 py-2 rounded-full bg-emerald-500/20 border border-emerald-300/80 shadow-lg text-xs sm:text-sm text-emerald-50 coach-streak-pop">
          <span class="inline-flex items-center gap-1">
            <span>üî• Streak up!</span>
            <span class="hidden sm:inline">${message}</span>
          </span>
        </div>
      `;
      document.body.appendChild(container);
      setTimeout(() => {
        container.classList.add('opacity-0');
      }, 650);
      setTimeout(() => {
        container.remove();
      }, 1100);
    }

    function applyStreakUpdate(newStreak, taskType) {
      if (typeof newStreak !== 'number') return;
      if (newStreak > currentStreak) {
        triggerStreakCelebration(taskType);
      }
      currentStreak = newStreak;
      if (headerStreakEl) {
        headerStreakEl.dataset.streak = String(newStreak);
        headerStreakEl.textContent = String(newStreak);
      }
      if (mainStreakEl) {
        mainStreakEl.dataset.streakMain = String(newStreak);
        mainStreakEl.textContent = String(newStreak);
      }
    }

    // ----- AJAX toggle for daily + weekly tasks -----
    const taskForms = document.querySelectorAll('form[data-coach-task-form]');
    taskForms.forEach((form) => {
      form.addEventListener('submit', function (e) {
        if (form.dataset.noAjax === '1') return; // fallback case
        e.preventDefault();

        const taskType  = form.dataset.taskType || 'daily';
        const toggleBtn = form.querySelector('[data-coach-task-toggle]');
        const titleEl   = form.querySelector('[data-coach-task-title]');
        const isDailyTask = taskType === 'daily';
        const prevDoneAttr = form.dataset.isDone;
        const prevDone = prevDoneAttr === '1';

        fetch(form.action, {
          method: form.method || 'POST',
          body: new FormData(form),
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then((res) => {
          if (!res.ok) throw new Error('Network error');
          return res.json();
        })
        .then((data) => {
          if (!data || !data.ok) throw new Error('Bad response');

          const isDone = !!data.is_done;

          // Button visual
          if (toggleBtn) {
            if (taskType === 'weekly') {
              if (isDone) {
                toggleBtn.classList.add('bg-indigo-500', 'border-indigo-400', 'shadow-glow');
                toggleBtn.classList.remove('border-white/40', 'hover:border-indigo-300');
                toggleBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-white"></i>';
              } else {
                toggleBtn.classList.remove('bg-indigo-500', 'border-indigo-400', 'shadow-glow');
                toggleBtn.classList.add('border-white/40');
                toggleBtn.innerHTML = '';
              }
            } else { // daily
              if (isDone) {
                toggleBtn.classList.add('bg-emerald-500', 'border-emerald-400', 'shadow-glow');
                toggleBtn.classList.remove('border-white/40', 'hover:border-emerald-300');
                toggleBtn.innerHTML = '<i data-lucide="check" class="w-3.5 h-3.5 text-white"></i>';
              } else {
                toggleBtn.classList.remove('bg-emerald-500', 'border-emerald-400', 'shadow-glow');
                toggleBtn.classList.add('border-white/40');
                toggleBtn.innerHTML = '';
              }
            }
            if (window.lucide) window.lucide.createIcons();
          }

          // Title styling
          if (titleEl) {
            if (isDone) {
              titleEl.classList.add('line-through');
              titleEl.classList.add(taskType === 'weekly' ? 'text-emerald-200/75' : 'text-emerald-200/70');
            } else {
              titleEl.classList.remove('line-through');
              titleEl.classList.remove('text-emerald-200/75', 'text-emerald-200/70');
              titleEl.classList.add('text-white');
            }
          }

          // Daily ring update (for pair of micro-tasks)
          if (isDailyTask) {
            const ring = document.getElementById('today-progress-ring');
            if (ring) {
              const total = parseInt(ring.getAttribute('data-total') || '1', 10) || 1;
              let completed = parseInt(ring.getAttribute('data-completed') || '0', 10) || 0;

              if (isDone && !prevDone) {
                completed += 1;
              } else if (!isDone && prevDone && completed > 0) {
                completed -= 1;
              }

              if (completed < 0) completed = 0;
              if (completed > total) completed = total;

              ring.setAttribute('data-completed', String(completed));
              updateDailyRing();
            }
            form.dataset.isDone = isDone ? '1' : '0';
          }

          // Big Rock progress bar simple update
          if (taskType === 'weekly') {
            const bar   = document.getElementById('big-rock-progress-bar');
            const label = document.getElementById('big-rock-progress-label');
            if (bar && label) {
              const pct = isDone ? 100 : 0;
              bar.style.width = pct + '%';
              label.textContent = pct + '%';
            }
          }

          // Streak update
          if (typeof data.user_streak === 'number') {
            applyStreakUpdate(data.user_streak || 0, taskType);
          }
        })
        .catch(() => {
          // Fallback: let the normal POST handle it
          form.dataset.noAjax = '1';
          form.submit();
        });
      });
    });
  });
</script>
{% endblock %}