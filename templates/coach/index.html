{% extends "base.html" %}
{% block title %}Weekly Coach ‚Äî CareerAI{% endblock %}

{% block content %}
{% set path_type = (path_type or 'job') %}

{# ‚úÖ UPGRADE-IN-PLACE: compatibility shims #}
{% set streak_count = (streak_count if streak_count is defined else (user_streak if user_streak is defined else 0)) %}

{# ‚úÖ NEW: "today" shim for UI locking (backend passes `today` already) #}
{% set _today = (today if today is defined else none) %}

{# locked_plans (legacy) OR saved_plans (new) #}
{% set locked_plans = (locked_plans if locked_plans is defined and locked_plans else (saved_plans if saved_plans is defined and saved_plans else [])) %}

{# daily tasks (legacy list) OR today_daily_task (new single) #}
{% if today_daily_tasks is defined and today_daily_tasks %}
  {% set _today_daily_tasks = today_daily_tasks %}
{% elif today_daily_task is defined and today_daily_task %}
  {% set _today_daily_tasks = [today_daily_task] %}
{% else %}
  {% set _today_daily_tasks = [] %}
{% endif %}

<style>
  @keyframes coachStreakPop {
    0%   { transform: scale(0.95); opacity: 0; }
    25%  { transform: scale(1.05); opacity: 1; }
    100% { transform: scale(1.0); opacity: 0; }
  }
  .coach-streak-pop {
    animation: coachStreakPop 0.9s ease-out forwards;
  }
</style>

<section class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 mb-16 space-y-8 text-white">

  <!-- ‚úÖ NEW: Skill Suggestions -->
  {% if pending_skills and pending_skills|length > 0 %}
  <div class="glass-card rounded-2xl p-6 border-2 border-emerald-500/30 bg-emerald-500/10 mb-6">
    <div class="flex items-start justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center">
          <i data-lucide="star" class="w-6 h-6 text-emerald-400"></i>
        </div>
        <div>
          <h3 class="text-xl font-bold text-emerald-300">üéâ New Skills Unlocked!</h3>
          <p class="text-sm text-white/70 mt-1">Add these to your profile</p>
        </div>
      </div>
      <span class="px-3 py-1 rounded-full bg-emerald-500/20 text-xs text-emerald-300">
        {{ pending_skills|length }} New
      </span>
    </div>

    <div class="space-y-3">
      {% for skill in pending_skills %}
      <div class="p-4 rounded-xl bg-white/5 border border-white/10 flex items-center justify-between">
        <div>
          <div class="font-semibold">{{ skill.skill_name }}</div>
          <div class="text-xs text-white/60 mt-1">{{ skill.context_note }}</div>
        </div>
        <div class="flex gap-2">
          <form method="POST" action="{{ url_for('coach.accept_skill', suggestion_id=skill.id) }}" class="inline">
            <button type="submit" class="px-4 py-2 rounded-lg bg-emerald-500/20 border border-emerald-500/30
                                         text-sm text-emerald-300 hover:bg-emerald-500/30 transition-all">
              <i data-lucide="check" class="w-4 h-4 inline"></i> Add
            </button>
          </form>
          <form method="POST" action="{{ url_for('coach.reject_skill', suggestion_id=skill.id) }}" class="inline">
            <button type="submit" class="px-3 py-2 rounded-lg bg-white/5 text-white/50 hover:bg-white/10">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- HEADER / HERO -->
  <header class="glass-card rounded-2xl p-6 sm:p-7 border border-white/10 shadow-xl relative overflow-hidden">
    <!-- Gradient overlay pushed behind content so navbar stays clickable -->
    <div class="pointer-events-none absolute inset-0 opacity-60 -z-10">
      <div class="w-full h-full bg-[radial-gradient(circle_at_top_left,rgba(129,140,248,0.25),transparent_55%),radial-gradient(circle_at_bottom_right,rgba(16,185,129,0.24),transparent_55%)]"></div>
    </div>

    <div class="relative flex flex-col sm:flex-row sm:items-center sm:justify-between gap-5">
      <div class="space-y-2">
        <div class="inline-flex items-center gap-2 text-[11px] uppercase tracking-[0.16em] text-white/65">
          <span class="px-2 py-0.5 rounded-full bg-black/30 border border-white/15 inline-flex items-center gap-1">
            <i data-lucide="calendar-check" class="w-3.5 h-3.5"></i>
            <span>Weekly Coach</span>
          </span>
          <span class="hidden sm:inline px-2 py-0.5 rounded-full bg-black/20 border border-white/10">
            {% if path_type == 'startup' %}Startup path{% else %}Job path{% endif %}
          </span>
        </div>

        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">
          Turn your Dream Plan into weekly execution
        </h1>

        <p class="text-sm sm:text-base text-white/80 max-w-xl leading-relaxed">
          The coach turns your 3-phase Dream Plan into <span class="font-semibold">small weekly focus packs</span>:
          checklists, a focus timer, and short AI guidance. Use it 3‚Äì5 days a week to keep momentum.
        </p>

        {% if profile_snapshot %}
          <p class="text-[11px] text-white/60 mt-1">
            Profile completion:
            <span class="font-semibold">{{ profile_snapshot.profile_strength_score or 0 }}%</span>
            <span class="text-white/45">¬∑ More complete profiles ‚Üí sharper tasks</span>
          </p>
        {% endif %}

        {# ‚úÖ NEW: Plan library shortcut (assumes /coach/plans exists) #}
        <div class="mt-2 flex flex-wrap items-center gap-2 text-[11px] text-white/65">
          <a href="{{ url_for('coach.manage_plans', path_type=path_type) }}"
             class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full bg-white/5 hover:bg-white/10 border border-white/10">
            <i data-lucide="layers" class="w-3.5 h-3.5"></i>
            <span>Manage saved plans</span>
          </a>
        </div>
      </div>

      <div class="space-y-2 text-xs text-right">
        {% if streak_count %}
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/40 border border-white/20">
            <i data-lucide="flame" class="w-3.5 h-3.5"></i>
            <span>Streak:</span>
            <span class="font-semibold">
              <span id="coach-streak-value" data-streak="{{ streak_count }}">{{ streak_count }}</span>
              day{{ '' if streak_count == 1 else 's' }}
            </span>
          </div>
        {% endif %}
        <p class="text-[11px] text-white/65">
          Mode:
          <span class="font-semibold">
            {% if path_type == 'startup' %}Startup path{% else %}Job path{% endif %}
          </span>
        </p>

        <div class="mt-2 flex flex-col items-end gap-1 text-[11px]">
          <a href="{{ url_for('dream.index', path_type=path_type) }}" class="inline-flex items-center gap-1 text-white/60 hover:text-white">
            <i data-lucide="sparkles" class="w-3 h-3"></i>
            <span>Back to Dream Planner</span>
          </a>
          {% if feature_paths is defined and feature_paths and feature_paths.skillmapper %}
            <a href="{{ feature_paths.skillmapper }}" class="inline-flex items-center gap-1 text-white/60 hover:text-white">
              <i data-lucide="route" class="w-3 h-3"></i>
              <span>Skill Mapper</span>
            </a>
          {% endif %}
          <a href="/" class="inline-flex items-center gap-1 text-white/60 hover:text-white">
            <i data-lucide="arrow-left" class="w-3 h-3"></i>
            <span>Back to home</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- DUAL-TRACK DASHBOARD (if cycle exists) -->
  {% if cycle_sessions %}
  <div class="space-y-6">

    <!-- STREAK & READY SCORE BAR -->
    <div class="glass-card rounded-2xl p-6 border border-white/10">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">

        <!-- Streak Counter -->
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-orange-500/20 to-red-500/20 border border-orange-500/30 flex items-center justify-center">
            <i data-lucide="flame" class="w-7 h-7 text-orange-400"></i>
          </div>
          <div>
            <div class="text-2xl font-bold" id="coach-streak-main-value" data-streak-main="{{ user_streak if user_streak is defined else streak_count }}">
              {{ user_streak if user_streak is defined else streak_count }}
            </div>
            <div class="text-xs text-white/60">Day Streak üî•</div>
            <div class="text-[10px] text-white/50">
              Longest: {{ current_user.longest_streak|default(0) }}
              {% if (current_user.streak_freezes_remaining|default(0)) > 0 %}
              ¬∑ ‚ùÑÔ∏è {{ current_user.streak_freezes_remaining|default(0) }} freeze
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Ready Score -->
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-indigo-500/30 flex items-center justify-center">
            <i data-lucide="trophy" class="w-7 h-7 text-indigo-400"></i>
          </div>
          <div>
            <div class="text-2xl font-bold">{{ user_ready_score if user_ready_score is defined else 0 }}</div>
            <div class="text-xs text-white/60">Ready Score ‚≠ê</div>
            <div class="text-[10px] text-white/50">
              {% set _rs = (user_ready_score if user_ready_score is defined else 0) %}
              {% if _rs >= 80 %}Top Tier
              {% elif _rs >= 60 %}Job Ready
              {% elif _rs >= 40 %}Building
              {% else %}Getting Started
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Milestones -->
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-emerald-500/20 to-teal-500/20 border border-emerald-500/30 flex items-center justify-center">
            <i data-lucide="award" class="w-7 h-7 text-emerald-400"></i>
          </div>
          <div>
            <div class="text-2xl font-bold">{{ current_user.weekly_milestones_completed|default(0) }}</div>
            <div class="text-xs text-white/60">Milestones üèÜ</div>
            <div class="text-[10px] text-white/50">
              Weekly goals completed
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- BENTO: TODAY'S PAIR + BIG ROCK -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

      {% set daily_tasks = _today_daily_tasks %}
      {% set daily_total = daily_total if daily_total is defined else (daily_tasks | length) %}
      {% set daily_completed = daily_completed if daily_completed is defined else (daily_tasks | selectattr('is_done') | list | length) %}

      <!-- LEFT / TOP: TODAY'S PAIR (Daily Career Maintenance) -->
      {% if daily_total > 0 %}
        <div class="lg:col-span-2">
          <div class="glass-card rounded-2xl p-6 border border-white/10 h-full flex flex-col">
            <div class="flex items-start justify-between gap-4 mb-4">
              <div>
                <h3 class="text-lg font-semibold flex items-center gap-2">
                  <i data-lucide="coffee" class="w-5 h-5 text-amber-400"></i>
                  <span>Today‚Äôs Pair</span>
                </h3>
                <p class="text-xs text-white/60 mt-1">
                  Up to 2 micro-tasks ¬∑ 5‚Äì15 minutes each ¬∑ Keeps your streak alive.
                </p>
                <p class="text-[11px] text-emerald-200 mt-1">
                  +1 Ready Score ‚≠ê per daily task completed.
                </p>
              </div>

              <div class="flex flex-col items-end gap-2">
                <!-- Progress Ring -->
                <div
                  id="today-progress-ring"
                  class="relative w-20 h-20 rounded-full flex items-center justify-center shadow-lg shadow-emerald-500/25"
                  data-total="{{ daily_total or 1 }}"
                  data-completed="{{ daily_completed or 0 }}"
                >
                  <div class="absolute inset-[3px] rounded-full bg-slate-950 flex items-center justify-center border border-white/10">
                    <div class="text-center leading-tight">
                      <div class="text-xs font-semibold">
                        {{ daily_completed }}/{{ daily_total }}
                      </div>
                      <div class="text-[10px] text-white/60">
                        Today
                      </div>
                    </div>
                  </div>
                </div>

                <div class="px-3 py-1 rounded-full bg-amber-500/20 border border-amber-500/30 text-xs text-amber-300">
                  Daily
                </div>
              </div>
            </div>

            <div class="space-y-3 mt-auto">
              {% for task in daily_tasks %}
                <form
                  method="POST"
                  action="{{ url_for('coach.complete_task', task_id=task.id) }}"
                  class="space-y-2"
                  data-coach-task-form
                  data-task-type="daily"
                  data-is-done="{{ 1 if task.is_done else 0 }}"
                >
                  <div class="flex items-start gap-3">
                    <button
                      type="submit"
                      data-coach-task-toggle
                      class="mt-1 w-5 h-5 rounded border-2 flex items-center justify-center transition-all
                             {% if task.is_done %}
                             bg-emerald-500 border-emerald-400 shadow-glow
                             {% else %}
                             border-white/40 hover:border-emerald-300
                             {% endif %}"
                    >
                      {% if task.is_done %}
                      <i data-lucide="check" class="w-3.5 h-3.5 text-white"></i>
                      {% endif %}
                    </button>
                    <div class="flex-1">
                      <h4
                        class="font-medium {% if task.is_done %}line-through text-emerald-200/70{% else %}text-white{% endif %}"
                        data-coach-task-title
                      >
                        {{ task.title }}
                      </h4>
                      {% if task.detail %}
                      <p class="text-sm text-white/70 mt-1">{{ task.detail }}</p>
                      {% endif %}
                      <div class="flex items-center flex-wrap gap-2 mt-2 text-[11px] text-white/60">
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-black/40 border border-white/20">
                          <i data-lucide="clock-3" class="w-3 h-3"></i>
                          <span>{{ task.estimated_time_minutes or task.estimated_minutes or 10 }} min</span>
                        </span>
                        {% if task.category %}
                          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/5 border border-white/20">
                            <span class="capitalize">{{ task.category }}</span>
                          </span>
                        {% endif %}
                        {% if task.target_lpa_level %}
                          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/5 border border-white/20">
                            {{ task.target_lpa_level }} LPA
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </form>
              {% endfor %}
            </div>

            <p class="mt-3 text-[11px] text-white/55">
              Tip: If you finish these quickly, open your weekly ‚ÄúBig Rock‚Äù and move it forward by at least 10‚Äì15 minutes.
            </p>
          </div>
        </div>
      {% else %}
        <!-- Placeholder when no daily task -->
        <div class="lg:col-span-2">
          <div class="glass-card rounded-2xl p-6 border border-white/10 h-full flex flex-col justify-center">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-2">
              <i data-lucide="coffee" class="w-5 h-5 text-amber-400"></i>
              <span>Today‚Äôs Pair</span>
            </h3>
            <p class="text-sm text-white/65">
              No specific daily micro-tasks for today. You can still keep momentum by nudging your weekly Big Rock forward.
            </p>
          </div>
        </div>
      {% endif %}

      <!-- RIGHT / BOTTOM: THE BIG ROCK (Weekly Professional Momentum) -->
      {% if current_weekly_task %}
        <div>
          <div class="glass-card rounded-2xl p-6 border border-white/10 h-full flex flex-col">
            <div class="flex items-start justify-between gap-4 mb-4">
              <div>
                <h3 class="text-lg font-semibold flex items-center gap-2">
                  <i data-lucide="target" class="w-5 h-5 text-indigo-400"></i>
                  <span>The Big Rock</span>
                </h3>
                <p class="text-xs text-white/60 mt-1">
                  3‚Äì5 hours this week ¬∑ Builds portfolio & confidence.
                </p>
                <p class="text-[11px] text-indigo-200 mt-1">
                  +14 Ready Score ‚≠ê when completed (+10 task +4 badge).
                </p>
              </div>
              <div class="px-3 py-1 rounded-full bg-indigo-500/20 border border-indigo-500/30 text-xs text-indigo-300">
                Weekly
              </div>
            </div>

            <form
              method="POST"
              action="{{ url_for('coach.complete_task', task_id=current_weekly_task.id) }}"
              class="space-y-3"
              data-coach-task-form
              data-task-type="weekly"
            >
              <div class="flex items-start gap-3">
                <button
                  type="submit"
                  data-coach-task-toggle
                  class="mt-1 w-6 h-6 rounded border-2 flex items-center justify-center transition-all
                         {% if current_weekly_task.is_done %}
                         bg-indigo-500 border-indigo-400 shadow-glow
                         {% else %}
                         border-white/40 hover:border-indigo-300
                         {% endif %}"
                >
                  {% if current_weekly_task.is_done %}
                  <i data-lucide="check" class="w-4 h-4 text-white"></i>
                  {% endif %}
                </button>
                <div class="flex-1">
                  <h4
                    class="font-semibold text-sm sm:text-base {% if current_weekly_task.is_done %}line-through text-emerald-200/75{% else %}text-white{% endif %}"
                    data-coach-task-title
                  >
                    {{ current_weekly_task.title }}
                  </h4>
                  {% if current_weekly_task.detail %}
                  <p class="text-xs sm:text-sm text-white/70 mt-2">{{ current_weekly_task.detail }}</p>
                  {% endif %}
                  <div class="flex items-center gap-4 mt-3">
                    <div class="flex-1">
                      <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                        <div
                          id="big-rock-progress-bar"
                          class="h-full bg-gradient-to-r {% if current_weekly_task.is_done %}from-emerald-400 to-emerald-500{% else %}from-indigo-500 to-purple-500{% endif %} transition-all"
                          style="width: {% if current_weekly_task.is_done %}100{% elif current_week_session %}{{ current_week_session.progress_percent }}{% else %}0{% endif %}%"
                        ></div>
                      </div>
                      <div class="flex justify-between text-[11px] text-white/50 mt-1">
                        <span>Progress</span>
                        <span id="big-rock-progress-label">
                          {% if current_week_session %}{{ current_week_session.progress_percent }}%{% else %}0%{% endif %}
                        </span>
                      </div>
                    </div>
                    {% if current_weekly_task.milestone_badge and current_weekly_task.is_done %}
                    <div class="px-3 py-1 rounded-full bg-yellow-500/20 border border-yellow-500/30 text-[11px] text-yellow-200">
                      üèÜ {{ current_weekly_task.milestone_badge }}
                    </div>
                    {% endif %}
                  </div>
                  <div class="flex items-center flex-wrap gap-2 mt-2 text-[11px] text-white/60">
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-black/40 border border-white/20">
                      <i data-lucide="clock-3" class="w-3 h-3"></i>
                      <span>{{ (current_weekly_task.estimated_time_minutes or 240) // 60 }} hours</span>
                    </span>
                    {% if current_weekly_task.category %}
                      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/5 border border-white/20">
                        <span class="capitalize">{{ current_weekly_task.category }}</span>
                      </span>
                    {% endif %}
                    {% if current_weekly_task.target_lpa_level %}
                      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/5 border border-white/20">
                        {{ current_weekly_task.target_lpa_level }} LPA track
                      </span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </form>

            {% if current_week_session %}
              <a href="{{ url_for('coach.session', session_id=current_week_session.id) }}"
                 class="mt-4 inline-flex items-center justify-center gap-1 px-3 py-1.5 rounded-full border border-emerald-300/70 bg-emerald-500/15 hover:bg-emerald-500/25 text-[11px] sm:text-xs text-emerald-100">
                <i data-lucide="timer" class="w-3.5 h-3.5"></i>
                <span>Open Deep Work Timer</span>
              </a>
            {% endif %}

            <p class="mt-3 text-[11px] text-white/55">
              Aim to touch this at least twice this week. Progress, not perfection, is what builds your career story.
            </p>
          </div>
        </div>
      {% else %}
        <!-- Placeholder when no weekly task -->
        <div>
          <div class="glass-card rounded-2xl p-6 border border-white/10 h-full flex flex-col justify-center">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-2">
              <i data-lucide="target" class="w-5 h-5 text-indigo-400"></i>
              <span>The Big Rock</span>
            </h3>
            <p class="text-sm text-white/65">
              Your weekly milestone will appear here once a plan is generated. This is where you‚Äôll see your main project or deep-work goal.
            </p>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- WEEK VIEW (All Weeks) -->
    <div class="glass-card rounded-2xl p-6 border border-white/10">
      <div class="flex items-center justify-between gap-3 mb-4">
        <h3 class="text-lg font-semibold flex items-center gap-2">
          <i data-lucide="calendar" class="w-5 h-5"></i>
          28-Day Roadmap
        </h3>

        <!-- ‚úÖ NEW: Abort Button -->
        <button onclick="showAbortModal()"
                class="px-4 py-2 rounded-lg bg-red-500/10 border border-red-500/30
                       text-sm text-red-300 hover:bg-red-500/20 transition-all">
          <i data-lucide="trash-2" class="w-4 h-4 inline"></i> Abort Plan
        </button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for session in cycle_sessions %}
          {# ‚úÖ UI LOCK for future weeks (backend enforces too) #}
          {% set is_future_week = (_today and session.session_date and session.session_date > _today) %}

          {% if is_future_week %}
            <div
              class="block p-4 rounded-xl border transition-all bg-white/5 border-white/10 opacity-60 cursor-not-allowed"
              aria-disabled="true"
              title="Locked until {{ session.session_date.strftime('%d %b %Y') if session.session_date else 'next week' }}"
            >
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-semibold">Week {{ session.day_index }}</span>
                <i data-lucide="lock" class="w-4 h-4 text-white/40"></i>
              </div>

              <div class="text-xs text-white/60 space-y-1">
                <div>Locked</div>
                <div>
                  Unlocks on
                  {{ session.session_date.strftime('%d %b %Y') if session.session_date else '' }}
                </div>
              </div>

              <div class="mt-3">
                <div class="h-1 bg-white/10 rounded-full overflow-hidden">
                  <div class="h-full bg-white/20" style="width: 0%"></div>
                </div>
              </div>
            </div>

          {% else %}
            <a href="{{ url_for('coach.session', session_id=session.id) }}"
               class="block p-4 rounded-xl border transition-all
                      {% if session.is_closed %}
                      bg-emerald-500/10 border-emerald-500/30 hover:bg-emerald-500/20
                      {% elif current_week_session and session.day_index == current_week_session.day_index %}
                      bg-indigo-500/10 border-indigo-500/30 hover:bg-indigo-500/20
                      {% else %}
                      bg-white/5 border-white/10 hover:bg-white/10
                      {% endif %}">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-semibold">Week {{ session.day_index }}</span>
                {% if session.is_closed %}
                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-400"></i>
                {% elif current_week_session and session.day_index == current_week_session.day_index %}
                <i data-lucide="play-circle" class="w-4 h-4 text-indigo-400"></i>
                {% else %}
                <i data-lucide="circle" class="w-4 h-4 text-white/30"></i>
                {% endif %}
              </div>

              <div class="text-xs text-white/60 space-y-1">
                <div>{{ session.daily_tasks_completed or 0 }} daily tasks done</div>
                <div>{% if session.weekly_task_completed %}‚úì{% else %}‚óã{% endif %} Weekly goal</div>
              </div>

              <div class="mt-3">
                <div class="h-1 bg-white/10 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500"
                       style="width: {{ session.progress_percent or 0 }}%"></div>
                </div>
              </div>
            </a>
          {% endif %}
        {% endfor %}
      </div>
    </div>

  </div>

  {% elif locked_plans and locked_plans|length > 0 %}

  <!-- ‚úÖ SELECT PLAN TO START -->
  <div class="space-y-6">
    <div class="glass-card rounded-2xl p-6 sm:p-7 border border-white/10 shadow-xl">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-14 h-14 rounded-xl bg-indigo-500/20 flex items-center justify-center">
          <i data-lucide="target" class="w-7 h-7 text-indigo-400"></i>
        </div>
        <div>
          <h2 class="text-2xl sm:text-3xl font-bold">Start Your Weekly Coach</h2>
          <p class="text-sm text-white/70">Select a saved plan to begin your journey</p>
        </div>
      </div>

      <div class="space-y-4">
        {% for plan in locked_plans %}

        {% set plan_data = plan.plan_json_parsed if plan.plan_json_parsed is defined and plan.plan_json_parsed else {} %}
        {% set input_data = plan_data.get('input', {}) if plan_data else {} %}
        {% set analysis = plan_data.get('analysis', {}) if plan_data else {} %}
        {% set selected_projects = plan_data.get('selected_projects', []) if plan_data else [] %}
        {% set target_lpa = input_data.get('target_lpa', '12') if input_data else '12' %}
        {% set timeline = input_data.get('timeline', '3_months') if input_data else '3_months' %}

        <div class="p-5 rounded-xl border-2 border-white/10 bg-white/5 hover:border-indigo-500/50 hover:bg-indigo-500/10 transition-all">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1 space-y-3">
              <div>
                <h3 class="text-lg font-bold text-white">
                  {% if input_data and input_data.get('target_role') %}
                    {{ input_data.get('target_role') }}
                  {% else %}
                    {{ plan.title if plan.title is defined and plan.title else (plan.plan_title if plan.plan_title is defined and plan.plan_title else 'Career Plan') }}
                  {% endif %}
                </h3>

                <div class="flex items-center flex-wrap gap-2 mt-1">
                  {% if input_data %}
                    <span class="px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-300 text-xs">
                      {{ target_lpa }}+ LPA Target
                    </span>
                    <span class="px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-300 text-xs">
                      {{ '28 Days' if timeline == '28_days' else '3 Months' }}
                    </span>
                  {% else %}
                    <span class="px-2 py-0.5 rounded-full bg-white/10 text-white/70 text-xs">
                      Locked Plan
                    </span>
                  {% endif %}

                  <span class="text-xs text-white/50">
                    Created
                    {% if plan.created_at is defined and plan.created_at %}
                      {{ plan.created_at.strftime('%b %d, %Y') }}
                    {% endif %}
                  </span>
                </div>
              </div>

              {% if selected_projects %}
              <div>
                <div class="text-xs text-white/60 mb-1">Selected Projects:</div>
                <div class="flex flex-wrap gap-2">
                  {% for proj in selected_projects[:3] %}
                  <span class="px-2 py-1 rounded-lg bg-purple-500/20 text-purple-300 text-xs">
                    {{ proj.get('title', 'Project') }}
                  </span>
                  {% endfor %}
                  {% if selected_projects|length > 3 %}
                  <span class="px-2 py-1 rounded-lg bg-white/10 text-white/50 text-xs">
                    +{{ selected_projects|length - 3 }} more
                  </span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {% if analysis and analysis.get('probabilities') %}
              <div class="grid grid-cols-2 gap-2 text-xs">
                {% set probs = analysis.get('probabilities', {}) %}
                <div class="px-2 py-1 rounded bg-white/5">
                  <span class="text-white/60">Current:</span>
                  <span class="text-white ml-1">{{ probs.get(target_lpa, 0) }}%</span>
                </div>
                <div class="px-2 py-1 rounded bg-emerald-500/10">
                  <span class="text-white/60">Target:</span>
                  <span class="text-emerald-300 ml-1">{{ analysis.get('projected_probabilities', {}).get(target_lpa, 0) }}%</span>
                </div>
              </div>
              {% endif %}
            </div>

            <form method="POST" action="{{ url_for('coach.start') }}">
              <input type="hidden" name="path_type" value="{{ plan.path_type if plan.path_type is defined else path_type }}">
              <input type="hidden" name="plan_id" value="{{ plan.id }}">
              {% if plan.dream_snapshot_id is defined and plan.dream_snapshot_id %}
                <input type="hidden" name="snapshot_id" value="{{ plan.dream_snapshot_id }}">
              {% else %}
                <input type="hidden" name="snapshot_id" value="{{ plan.id }}">
              {% endif %}

              <button type="submit"
                      class="px-6 py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500
                             hover:from-indigo-600 hover:to-purple-600
                             text-white font-semibold transition-all shadow-lg hover:shadow-xl
                             flex items-center gap-2 whitespace-nowrap">
                <i data-lucide="play" class="w-5 h-5"></i>
                <span>Start Coach</span>
              </button>
            </form>
          </div>
        </div>

        {% endfor %}
      </div>

      <div class="mt-6 text-center space-y-2">
        <a href="{{ url_for('dream.index', path_type=path_type) }}"
           class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10
                  text-sm text-white/70 hover:text-white transition-all border border-white/10">
          <i data-lucide="plus" class="w-4 h-4"></i>
          <span>Create New Dream Plan</span>
        </a>

        <div class="text-[11px] text-white/55">
          Tip: Lock your Dream Plan (select projects) to add it to your saved Coach plans.
        </div>
      </div>
    </div>
  </div>

  {% else %}

  <!-- NO CYCLE + NO SAVED PLANS -->
  <div class="glass-card rounded-2xl p-8 border border-white/10 text-center">
    <div class="max-w-2xl mx-auto space-y-4">
      <div class="w-16 h-16 mx-auto rounded-xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-indigo-500/30 flex items-center justify-center">
        <i data-lucide="rocket" class="w-8 h-8 text-indigo-400"></i>
      </div>

      <h2 class="text-2xl font-bold">Ready to start your journey?</h2>

      <p class="text-white/70 max-w-lg mx-auto">
        Weekly Coach runs from a <span class="font-semibold">locked Dream Plan</span>.
        First generate a Dream Plan, select projects, and lock it ‚Äî then it becomes available here.
      </p>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-w-md mx-auto text-left text-sm">
        <div class="p-3 rounded-lg bg-white/5 border border-white/10">
          <div class="font-semibold text-amber-300 mb-1">Daily Tasks</div>
          <div class="text-xs text-white/60">
            ‚Ä¢ Micro-tasks to maintain momentum<br>
            ‚Ä¢ 5‚Äì15 min each<br>
            ‚Ä¢ Keeps your streak alive
          </div>
        </div>
        <div class="p-3 rounded-lg bg-white/5 border border-white/10">
          <div class="font-semibold text-indigo-300 mb-1">Weekly Goals</div>
          <div class="text-xs text-white/60">
            ‚Ä¢ Portfolio milestones<br>
            ‚Ä¢ Deep work blocks<br>
            ‚Ä¢ Proof-of-work DevLog
          </div>
        </div>
      </div>

      <div class="mt-6 flex flex-col sm:flex-row items-center justify-center gap-3">
        <a href="{{ url_for('dream.index', path_type=path_type) }}"
           class="btn-primary px-6 py-3 text-base inline-flex items-center gap-2">
          <i data-lucide="sparkles" class="w-5 h-5"></i>
          <span>Generate Dream Plan</span>
        </a>

        <a href="{{ url_for('coach.manage_plans', path_type=path_type) }}"
           class="px-6 py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10
                  text-white/80 hover:text-white transition-all inline-flex items-center gap-2">
          <i data-lucide="layers" class="w-5 h-5"></i>
          <span>View saved plans</span>
        </a>
      </div>

      <p class="text-xs text-white/50 mt-2">
        Weekly Coach is included with Dream Plan execution (no extra credits deducted at Coach start).
      </p>
    </div>
  </div>
  {% endif %}

  <!-- GATED MESSAGE FOR FREE USERS -->
  {% if not is_pro_user %}
    <div class="glass-card rounded-2xl p-6 border border-white/10 text-center space-y-4">
      <h2 class="text-lg font-semibold">Weekly Coach is Pro-only ‚≠ê</h2>
      <p class="text-sm text-white/70 max-w-md mx-auto">
        Upgrade to Pro to unlock:
      </p>

      <ul class="space-y-1 text-sm text-white/75 max-w-md mx-auto text-left">
        <li>‚Ä¢ Weekly focus packs derived from your Dream Plan</li>
        <li>‚Ä¢ A checklist view with task-by-task progress</li>
        <li>‚Ä¢ Focus timer with guided breaks and wellbeing nudges</li>
        <li>‚Ä¢ Progress tracking, streaks and reflection notes</li>
      </ul>

      <a href="{{ url_for('billing.index') }}"
         class="btn-primary mt-4 inline-flex items-center justify-center gap-1 px-4 py-2">
        <i data-lucide="sparkles" class="w-4 h-4"></i>
        <span>Upgrade to Pro</span>
      </a>

      <div class="mt-3 space-y-1 text-xs text-white/60">
        <p>Already Pro? Please logout and login again.</p>
        <p>
          <a href="/" class="inline-flex items-center gap-1 text-white/70 hover:text-white underline underline-offset-2">
            <i data-lucide="arrow-left" class="w-3 h-3"></i>
            <span>Back to home</span>
          </a>
        </p>
      </div>
    </div>

  {% else %}

    <!-- (your existing Pro-only blocks remain unchanged below) -->
    <!-- ... your full remaining content stays as-is ... -->

  {% endif %}

  <!-- ‚úÖ NEW: Abort Modal -->
  <div id="abortModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
    <div class="glass-card rounded-2xl max-w-md w-full p-8 border border-red-500/30 bg-gradient-to-br from-red-500/10 to-orange-500/10">
      <div class="text-center mb-6">
        <div class="w-16 h-16 rounded-2xl bg-red-500/20 flex items-center justify-center mx-auto mb-4">
          <i data-lucide="alert-triangle" class="w-8 h-8 text-red-400"></i>
        </div>
        <h3 class="text-2xl font-bold text-red-300 mb-2">Abort Current Plan?</h3>
        <p class="text-white/80">
          This will delete all tasks in your current cycle. You can restart anytime.
        </p>
      </div>

      <div class="space-y-3">
        <form method="POST" action="{{ url_for('coach.abort_plan') }}">
          <input type="hidden" name="path_type" value="{{ path_type }}">
          <input type="hidden" name="month_cycle_id" value="{{ month_cycle_id }}">
          <button type="submit"
                  class="w-full px-6 py-3 rounded-xl bg-red-500/20 border border-red-500/30
                         text-red-300 font-semibold hover:bg-red-500/30 transition-all">
            <i data-lucide="trash-2" class="w-5 h-5 inline"></i> Yes, Abort Plan
          </button>
        </form>

        <button onclick="hideAbortModal()"
                class="w-full px-6 py-3 rounded-xl bg-white/10 border border-white/20
                       text-white hover:bg-white/20 transition-all">
          Cancel
        </button>
      </div>
    </div>
  </div>

</section>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>
  function showAbortModal() {
    const el = document.getElementById('abortModal');
    if (el) el.classList.remove('hidden');
  }
  function hideAbortModal() {
    const el = document.getElementById('abortModal');
    if (el) el.classList.add('hidden');
  }
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') hideAbortModal();
  });

  document.addEventListener('DOMContentLoaded', function () {
    if (window.lucide) {
      window.lucide.createIcons();
    }

    // ----- Daily progress ring -----
    function updateDailyRing() {
      const ring = document.getElementById('today-progress-ring');
      if (!ring) return;
      const total = parseInt(ring.getAttribute('data-total') || '1', 10) || 1;
      const completed = parseInt(ring.getAttribute('data-completed') || '0', 10) || 0;
      const pct = Math.max(0, Math.min(100, Math.round((completed / total) * 100)));

      ring.style.backgroundImage =
        'conic-gradient(rgba(16,185,129,0.95) ' + pct + '%, rgba(15,23,42,0.9) ' + pct + '%)';
    }
    updateDailyRing();

    // ----- Streak + celebration -----
    const headerStreakEl = document.getElementById('coach-streak-value');
    const mainStreakEl   = document.getElementById('coach-streak-main-value');
    let currentStreak = 0;
    if (headerStreakEl) {
      currentStreak = parseInt(headerStreakEl.dataset.streak || headerStreakEl.textContent || '0', 10) || 0;
    } else if (mainStreakEl) {
      currentStreak = parseInt(mainStreakEl.dataset.streakMain || mainStreakEl.textContent || '0', 10) || 0;
    }

    function triggerStreakCelebration(taskType) {
      const container = document.createElement('div');
      container.className = 'fixed inset-0 flex items-start justify-center pointer-events-none z-[80]';
      const message = taskType === 'weekly'
        ? 'Weekly milestone locked in ‚Äî nice.'
        : 'Another day in your streak. Keep it going.';
      container.innerHTML = `
        <div class="mt-20 px-4 py-2 rounded-full bg-emerald-500/20 border border-emerald-300/80 shadow-lg text-xs sm:text-sm text-emerald-50 coach-streak-pop">
          <span class="inline-flex items-center gap-1">
            <span>üî• Streak up!</span>
            <span class="hidden sm:inline">${message}</span>
          </span>
        </div>
      `;
      document.body.appendChild(container);
      setTimeout(() => {
        container.classList.add('opacity-0');
      }, 650);
      setTimeout(() => {
        container.remove();
      }, 1100);
    }

    function applyStreakUpdate(newStreak, taskType) {
      if (typeof newStreak !== 'number') return;
      if (newStreak > currentStreak) {
        triggerStreakCelebration(taskType);
      }
      currentStreak = newStreak;
      if (headerStreakEl) {
        headerStreakEl.dataset.streak = String(newStreak);
        headerStreakEl.textContent = String(newStreak);
      }
      if (mainStreakEl) {
        mainStreakEl.dataset.streakMain = String(newStreak);
        mainStreakEl.textContent = String(newStreak);
      }
    }

    // ----- AJAX toggle for daily + weekly tasks -----
    const taskForms = document.querySelectorAll('form[data-coach-task-form]');
    taskForms.forEach((form) => {
      form.addEventListener('submit', function (e) {
        if (form.dataset.noAjax === '1') return; // fallback case
        e.preventDefault();

        const taskType  = form.dataset.taskType || 'daily';
        const toggleBtn = form.querySelector('[data-coach-task-toggle]');
        const titleEl   = form.querySelector('[data-coach-task-title]');
        const isDailyTask = taskType === 'daily';
        const prevDoneAttr = form.dataset.isDone;
        const prevDone = prevDoneAttr === '1';

        fetch(form.action, {
          method: form.method || 'POST',
          body: new FormData(form),
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then((res) => {
          if (!res.ok) throw new Error('Network error');
          return res.json();
        })
        .then((data) => {
          if (!data) throw new Error('Bad response');

          // ‚úÖ BLOCKED ACTIONS: show ALERT + optionally redirect to DevLog
          if (data.ok === false) {
            const msg = data.message || 'Action blocked.';
            alert(msg);

            if (data.devlog_url) {
              window.location.href = data.devlog_url;
            }
            return;
          }

          // If backend includes ok, require it to be truthy
          if (data.ok !== undefined && !data.ok) throw new Error('Bad response');

          const isDone = !!data.is_done;

          // Button visual
          if (toggleBtn) {
            if (taskType === 'weekly') {
              if (isDone) {
                toggleBtn.classList.add('bg-indigo-500', 'border-indigo-400', 'shadow-glow');
                toggleBtn.classList.remove('border-white/40', 'hover:border-indigo-300');
                toggleBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-white"></i>';
              } else {
                toggleBtn.classList.remove('bg-indigo-500', 'border-indigo-400', 'shadow-glow');
                toggleBtn.classList.add('border-white/40');
                toggleBtn.innerHTML = '';
              }
            } else { // daily
              if (isDone) {
                toggleBtn.classList.add('bg-emerald-500', 'border-emerald-400', 'shadow-glow');
                toggleBtn.classList.remove('border-white/40', 'hover:border-emerald-300');
                toggleBtn.innerHTML = '<i data-lucide="check" class="w-3.5 h-3.5 text-white"></i>';
              } else {
                toggleBtn.classList.remove('bg-emerald-500', 'border-emerald-400', 'shadow-glow');
                toggleBtn.classList.add('border-white/40');
                toggleBtn.innerHTML = '';
              }
            }
            if (window.lucide) window.lucide.createIcons();
          }

          // Title styling
          if (titleEl) {
            if (isDone) {
              titleEl.classList.add('line-through');
              titleEl.classList.add(taskType === 'weekly' ? 'text-emerald-200/75' : 'text-emerald-200/70');
            } else {
              titleEl.classList.remove('line-through');
              titleEl.classList.remove('text-emerald-200/75', 'text-emerald-200/70');
              titleEl.classList.add('text-white');
            }
          }

          // Daily ring update
          if (isDailyTask) {
            const ring = document.getElementById('today-progress-ring');
            if (ring) {
              const total = parseInt(ring.getAttribute('data-total') || '1', 10) || 1;
              let completed = parseInt(ring.getAttribute('data-completed') || '0', 10) || 0;

              if (isDone && !prevDone) {
                completed += 1;
              } else if (!isDone && prevDone && completed > 0) {
                completed -= 1;
              }

              if (completed < 0) completed = 0;
              if (completed > total) completed = total;

              ring.setAttribute('data-completed', String(completed));
              updateDailyRing();
            }
            form.dataset.isDone = isDone ? '1' : '0';
          }

          // Big Rock progress bar update
          if (taskType === 'weekly') {
            const bar   = document.getElementById('big-rock-progress-bar');
            const label = document.getElementById('big-rock-progress-label');
            if (bar && label) {
              const pct = isDone ? 100 : 0;
              bar.style.width = pct + '%';
              label.textContent = pct + '%';
            }
          }

          // Streak update
          if (typeof data.user_streak === 'number') {
            applyStreakUpdate(data.user_streak || 0, taskType);
          }
        })
        .catch(() => {
          // Fallback: normal POST
          form.dataset.noAjax = '1';
          form.submit();
        });
      });
    });
  });
</script>
{% endblock %}
